<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FocusQuiz · Càpsula · Suma de fraccions (denominadors diferents)</title>
  <meta name="description" content="Càpsula visual i seqüencial: objectiu → introducció → explicació visual → pràctica guiada → joc → resum. Exemple base 1/2 + 1/3 amb transformació a sisens i suma final." />
  <style>
    :root{
      --bg:#f8fafc;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;
      --brand:#8ec5ff;--brand2:#a7f3d0;--brand3:#fbcfe8;--ok:#10b981;--bad:#ef4444;--warn:#f59e0b;
      --shadow:0 10px 30px rgba(2,8,23,.08);
      --grid-fine:#e9eef6;--grid-bold:#d9e2f1;--grid-blur:0.3px;--grid-size:24px;--grid-mult:5;
      --focus:#7bb0ff;
    }
    body.dark{
      --grid-fine:#1b2535;
      --grid-bold:#162031;
      --grid-blur:0.2px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);position:relative;min-height:100vh;}
    body::before{
      content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;
      background:
        repeating-linear-gradient(
          to right,
          transparent 0 calc(var(--grid-size)*(var(--grid-mult) - 0.1)),
          var(--grid-bold) 0 calc(var(--grid-size)*var(--grid-mult))
        ),
        repeating-linear-gradient(
          to bottom,
          transparent 0 calc(var(--grid-size)*(var(--grid-mult) - 0.1)),
          var(--grid-bold) 0 calc(var(--grid-size)*var(--grid-mult))
        ),
        repeating-linear-gradient(
          to right,
          var(--grid-fine) 0 1px,
          transparent 1px var(--grid-size)
        ),
        repeating-linear-gradient(
          to bottom,
          var(--grid-fine) 0 1px,
          transparent 1px var(--grid-size)
        ),
        var(--bg);
      background-attachment:fixed;
      filter:blur(var(--grid-blur));
    }
    body.dots::before{
      background:
        radial-gradient(var(--grid-fine) 1px,transparent 1px) 0 0/ var(--grid-size) var(--grid-size),
        radial-gradient(var(--grid-bold) 1px,transparent 1px) 0 0/ calc(var(--grid-size)*var(--grid-mult)) calc(var(--grid-size)*var(--grid-mult)),
        var(--bg);
      filter:none;
    }
    @media print{
      body{background:#fff!important;}
      body::before{display:none;}
    }
    section{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    h1,h2{margin:6px 0 10px}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:linear-gradient(135deg,var(--brand),var(--brand3));color:#0b1220;font-weight:600;cursor:pointer;box-shadow:0 4px 14px rgba(2,8,23,.08)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn:hover{transform:translateY(-1px)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .frac{display:inline-grid;grid-template-rows:auto auto;line-height:1;text-align:center;min-width:28px;justify-items:center}
    .frac>i{height:2px;background:#111827;border-radius:2px;margin:2px 0;width:100%}
    .input{padding:10px 12px;border:1px solid var(--line);border-radius:10px;width:110px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .hidden{display:none}
    .fade{opacity:0;transform:translateY(6px);animation:fade .4s forwards}
    @keyframes fade{to{opacity:1;transform:none}}
    .progress{height:8px;background:var(--line);border-radius:999px;overflow:hidden}
    .bar{height:8px;width:0;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:.3s width}
    svg{max-width:100%;height:auto}
    #viz{position:relative;min-height:320px;border-radius:22px;padding:24px;background:radial-gradient(circle at top,var(--brand)10%,transparent 55%),radial-gradient(circle at bottom,var(--brand2)10%,transparent 60%),var(--card);border:1px solid var(--line);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;overflow:hidden}
    #viz::after{content:"";position:absolute;inset:0;border-radius:22px;pointer-events:none;background:linear-gradient(135deg,rgba(255,255,255,.45),rgba(255,255,255,0));mix-blend-mode:screen;opacity:.65}
    #viz svg{position:relative;z-index:1}
    .grid{display:grid;gap:12px}
    #blk-7 .grid{grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}
    #blk-7 .grid>.card{background:linear-gradient(135deg,rgba(142,197,255,.12),rgba(247,255,253,.9));border:1px solid rgba(148,163,184,.4);box-shadow:0 10px 24px rgba(15,23,42,.08)}
    .mini{font-size:.95rem}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
    .list{display:grid;grid-template-columns:1fr auto 1fr;gap:6px;align-items:center}
    .topbar{justify-content:flex-end}
    .topbar .btn{min-width:44px;padding:8px 12px}
    .btn:focus-visible,.input:focus-visible,.topbar button:focus-visible{outline:3px solid var(--focus);outline-offset:2px;border-radius:12px}
    @media (prefers-reduced-motion:no-preference){
      .card{transition:box-shadow .2s ease,transform .15s ease}
      .card:hover{transform:translateY(-1px);box-shadow:0 14px 34px rgba(2,8,23,.1)}
      .btn{transition:transform .12s ease,box-shadow .12s ease}
      .btn:active{transform:translateY(0)}
    }
    @media (prefers-reduced-motion:reduce){
      *{animation:none!important;transition:none!important}
    }
  </style>
</head>
<body>
  <section id="capsule">
    <div class="row topbar" aria-label="Eines de fons">
      <button class="btn" id="gridToggle" type="button" aria-label="Canvia el patró de fons" title="Canvia fons">📐</button>
    </div>
    <!-- 1) Objectiu didàctic -->
    <article class="card" id="blk-1">
      <h1>Objectiu d’aprenentatge</h1>
      <div class="toast small">Quan <b>denominadors són diferents</b> → <b>MCM</b> → <b>equivalències</b> → <b>suma</b> → <b>simplificació</b>.</div>
      <p>Al final podràs: (1) trobar el <b>MCM</b>, (2) convertir a <b>denominador comú</b>, (3) sumar <b>només els numeradors</b>, (4) <b>simplificar</b> el resultat.</p>
      <div class="row"><button class="btn primary" id="start">Comença</button><span class="pill">Criteris d’èxit: aplica MCM correctament ≥ 80% dels casos</span></div>
    </article>

    <article class="card hidden" id="blk-2">
      <h2>Demostració visual</h2>
      <p class="muted">Exemple base <span class="pill"><span class="frac"><b>1</b><i></i><b>2</b></span> + <span class="frac"><b>1</b><i></i><b>3</b></span></span>. Convertim a sisens (MCM = 6) i sumem.</p>
      <div id="viz" class="fade" role="img" aria-label="Diagrama circular de fraccions amb transformació a sisens"></div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <span class="pill">Exemple: <span class="frac"><b>1</b><i></i><b>2</b></span> + <span class="frac"><b>1</b><i></i><b>3</b></span></span>
        <div class="row">
          <button class="btn" id="btnShowMCM">Mostra MCM i equivalències</button>
          <button class="btn" id="btnShowSum" disabled>Mostra la suma</button>
          <button class="btn" data-retry="2">Reinicia aquest pas</button>
        </div>
      </div>
    </article>

    <article class="card hidden" id="blk-3">
      <h2>Guia pas a pas</h2>
      <ol id="guide" class="fade small" style="margin:0 0 8px 18px"></ol>
      <div class="row"><button class="btn primary" id="nextStep">Següent pas</button><button class="btn" data-retry="3">Reinicia aquest pas</button></div>
    </article>

    <article class="card hidden" id="blk-4">
      <h2>Pràctica guiada</h2>
      <p class="muted">Completa cada pas. Quan el facis bé, s’obrirà el següent.</p>
      <div id="p1" class="fade">
        <h3>Pas 1 · Troba el MCM (2 i 3) <span class="pill" id="bc1">Pas 1/4</span></h3>
        <div class="row"><input id="mcm" class="input" placeholder="Escriu el MCM" aria-label="Resposta MCM"/><button class="btn" id="mcmChk">Comprova</button><button class="btn" data-retry="p1">Reinicia</button><span id="mcmMsg" class="muted"></span></div>
        <div class="small muted">Pista 1: múltiples de 2 → 2,4,6… · 3 → 3,6,9… <span id="pistaMCM" class="hidden">Pista 2: el primer múltiple compartit és 6.</span></div>
      </div>
      <div id="p2" class="hidden">
        <h3>Pas 2 · Equivalències a sisens <span class="pill" id="bc2">Pas 2/4</span></h3>
        <div class="grid">
          <div class="row"><div><span class="frac"><b>1</b><i></i><b>2</b></span> →</div><div class="row"><input id="a2n" class="input" placeholder="numerador"/><span class="frac"><b>&nbsp;</b><i></i><b>6</b></span></div><span id="eqMsg1" class="muted"></span></div>
          <div class="row"><div><span class="frac"><b>1</b><i></i><b>3</b></span> →</div><div class="row"><input id="c2n" class="input" placeholder="numerador"/><span class="frac"><b>&nbsp;</b><i></i><b>6</b></span></div><span id="eqMsg2" class="muted"></span></div>
        </div>
        <div class="row"><button class="btn" id="eqChk">Comprova</button><button class="btn" data-retry="p2">Reinicia</button><span id="eqMsg" class="muted"></span></div>
      </div>
      <div id="p3" class="hidden">
        <h3>Pas 3 · Fes la suma <span class="pill" id="bc3">Pas 3/4</span></h3>
        <div class="row">
          <span class="frac"><b id="showA2">3</b><i></i><b>6</b></span> + <span class="frac"><b id="showC2">2</b><i></i><b>6</b></span> =
          <div class="frac"><b><input id="sumN" class="input" placeholder="numerador"/></b><i></i><b><input id="sumD" class="input" value="6" readonly/></b></div>
          <button class="btn" id="sumChk">Comprova</button><button class="btn" data-retry="p3">Reinicia</button><span id="sumMsg" class="muted"></span>
        </div>
        <div class="small muted">Error típic: <span class="pill">sumar denominadors</span>. No ho facis.</div>
      </div>
      <div id="p4" class="hidden">
        <h3>Pas 4 · Resultat i simplificació <span class="pill" id="bc4">Pas 4/4</span></h3>
        <div class="row"><span class="pill">Resultat: <span class="frac"><b id="resN">5</b><i></i><b id="resD">6</b></span></span><span class="ok" id="simpMsg">Ja està simplificat ✅</span></div>
        <div class="row"><button class="btn primary" id="toGame">Anar al joc</button><button class="btn" data-retry="p4">Reinicia</button></div>
      </div>
    </article>

    <article class="card hidden" id="blk-5">
      <h2>Joc interactiu</h2>
      <div id="game" class="fade small"></div>
      <div class="row"><button class="btn" id="moreGame">Nou repte</button><button class="btn" data-retry="5">Reinicia aquest pas</button><a class="btn" href="#blk-7">Ves a Exercicis</a></div>
    </article>

    <article class="card hidden" id="blk-7">
      <h2>Exercicis d’entrenament</h2>
      <p class="muted">Pràctiques variades amb generador aleatori i Mastery Check.</p>
      <div class="grid">
        <div class="card">
          <h3>MCM ràpid · 10 ítems</h3>
          <div id="mcmFlash"></div>
          <div class="row"><button class="btn primary" id="mcmRun">Comença</button><span id="mcmScore" class="pill">0/0</span></div>
        </div>
        <div class="card">
          <h3>Equivalències dirigides</h3>
          <div id="eqDir"></div>
          <div class="row"><button class="btn primary" id="eqDirRun">Comença</button><span id="eqDirScore" class="pill">0/0</span></div>
        </div>
        <div class="card">
          <h3>Suma guiada (aleatòria)</h3>
          <div id="sumTrain"></div>
          <div class="row"><button class="btn primary" id="sumRun">Comença</button><span id="sumScore" class="pill">0/0</span></div>
        </div>
        <div class="card">
          <h3>Simplificació</h3>
          <div id="simpTrain"></div>
          <div class="row"><button class="btn primary" id="simpRun">Comença</button><span id="simpScore" class="pill">0/0</span></div>
        </div>
        <div class="card">
          <h3>Mastery Check · 8 ítems</h3>
          <div id="master"></div>
          <div class="row"><button class="btn primary" id="masterRun">Inicia</button><span id="masterScore" class="pill">0/0</span><span class="muted small">Aprovat amb 6/8</span></div>
        </div>
      </div>
    </article>

    <article class="card hidden" id="blk-6">
      <h2>Resum i recomanacions</h2>
      <ul>
        <li>Troba el <b>MCM</b> dels denominadors.</li>
        <li>Converteix a <b>denominador comú</b> (fraccions equivalents).</li>
        <li><b>Suma</b> els numeradors; el denominador es manté.</li>
        <li><b>Simplifica</b> si cal.</li>
      </ul>
      <div class="row"><button class="btn" id="restart">Torna a començar</button><button class="btn" id="printSum">Imprimeix resum</button></div>
      <div class="printOnly small"><hr/>Errors freqüents: sumar denominadors; confondre MCM amb MCD.</div>
    </article>
  </section>

  <script>
    // ——— Utilitats visuals ———
    const $=id=>document.getElementById(id);
    const gcd=(a,b)=>b?gcd(b,a%b):Math.abs(a);
    const prefersReduced = typeof window.matchMedia==='function' && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const PREF_KEY='fq_capsula_suma_prefs';

    const frac=(n,d,extraClass='')=>`<span class="frac${extraClass?` ${extraClass}`:''}"><b>${n}</b><i></i><b>${d}</b></span>`;

    function scrollToEl(el){
      if(!el) return;
      const behavior=prefersReduced?'auto':'smooth';
      el.scrollIntoView({behavior,block:'start'});
    }

    function safeParse(json){
      try{return JSON.parse(json);}catch{return null;}
    }

    function savePrefs(){
      try{
        const prefs={dots:document.body.classList.contains('dots')};
        localStorage.setItem(PREF_KEY,JSON.stringify(prefs));
      }catch(err){/* ignore storage errors */}
    }

    function loadPrefs(){
      try{
        const stored=safeParse(localStorage.getItem(PREF_KEY));
        if(stored?.dots){ document.body.classList.add('dots'); }
      }catch(err){/* ignore */}
    }

    loadPrefs();

    function drawPie(cx,cy,r,parts,fill,color){
      let out='';const tau=Math.PI*2,off=-Math.PI/2;
      for(let i=0;i<parts;i++){
        const a0=off+i*(tau/parts),a1=off+(i+1)*(tau/parts);
        const x0=cx+r*Math.cos(a0),y0=cy+r*Math.sin(a0),x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
        const large=(a1-a0)>Math.PI?1:0;
        const p=`M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z`;
        out+=`<path d="${p}" fill="${i<fill?color:'#e5e7eb'}" stroke="#94a3b8"/>`;
      }
      return out;
    }

    function svgFraction(x,y,n,d,options={}){
      const size=options.size??26;
      const color=options.color??'#0f172a';
      const lineColor=options.lineColor??'#0f172a';
      const weight=options.fontWeight??600;
      const half=options.width??size;
      const offset=size*0.55;
      const denomOffset=size*0.95;
      const lineY=y+size*0.1;
      const caption=options.caption?`<text x="${x}" y="${y+denomOffset+22}" text-anchor="middle" font-size="14" fill="#475569">${options.caption}</text>`:'';
      return `
        <g aria-label="${n}/${d}">
          <text x="${x}" y="${y-offset}" text-anchor="middle" font-size="${size}" font-weight="${weight}" fill="${color}">${n}</text>
          <line x1="${x-half}" x2="${x+half}" y1="${lineY}" y2="${lineY}" stroke="${lineColor}" stroke-width="2" stroke-linecap="round"/>
          <text x="${x}" y="${y+denomOffset}" text-anchor="middle" font-size="${size}" font-weight="${weight}" fill="${color}">${d}</text>
          ${caption}
        </g>`;
    }

    // ——— 1) Flux seqüencial ———
    const order=['blk-1','blk-2','blk-3','blk-4','blk-5','blk-6'];
    function reveal(id){
      const el=$(id);
      if(!el) return;
      const wasHidden=el.classList.contains('hidden');
      el.classList.remove('hidden');
      if(wasHidden) el.classList.add('fade');
      scrollToEl(el);
    }
    function openNext(currId){
      const i=order.indexOf(currId); if(i>-1 && i<order.length-1){
        const nextId=order[i+1];
        reveal(nextId);
      }
    }

    // ——— 2) Introducció visual ———
    function renderIntro(){
      const svg=`<svg viewBox="0 0 820 480" role="img" aria-label="Transformació de fraccions fins a la suma final">
        <g aria-label="Fraccions originals">
          <text x="150" y="48" text-anchor="middle" font-size="15" fill="#64748b">Fracció 1</text>
          ${drawPie(150,110,70,2,1,'#93c5fd')}
          ${svgFraction(150,220,1,2,{caption:'Original'})}
        </g>
        <g aria-label="Fraccions originals">
          <text x="390" y="48" text-anchor="middle" font-size="15" fill="#64748b">Fracció 2</text>
          ${drawPie(390,110,70,3,1,'#fbcfe8')}
          ${svgFraction(390,220,1,3,{caption:'Original'})}
        </g>
        <text x="270" y="120" font-size="42" text-anchor="middle" fill="#0f172a">+</text>
        <g id="zoneEquiv"></g>
        <g id="zoneResult"></g>
      </svg>`;
      $('viz').innerHTML=svg;
    }

    function showMCM(){
      const zone=`
        <g aria-label="Fraccions equivalents" transform="translate(0,120)">
          <text x="150" y="48" text-anchor="middle" font-size="15" fill="#64748b">Equivalència</text>
          ${drawPie(150,160,60,6,3,'#a7f3d0')}
          ${svgFraction(150,270,3,6,{caption:'Comú (×3)'})}
        </g>
        <g aria-label="Fraccions equivalents" transform="translate(0,120)">
          <text x="390" y="48" text-anchor="middle" font-size="15" fill="#64748b">Equivalència</text>
          ${drawPie(390,160,60,6,2,'#c7d2fe')}
          ${svgFraction(390,270,2,6,{caption:'Comú (×2)'})}
        </g>
        <text x="270" y="280" font-size="38" text-anchor="middle" fill="#0f172a">+</text>
      `;
      const doc=$('viz').querySelector('#zoneEquiv');
      doc.innerHTML=zone;
      $('btnShowSum').disabled=false;
    }

    function showSum(){
      const sum=`
        <g aria-label="Suma final" transform="translate(260,0)">
          <text x="390" y="48" text-anchor="middle" font-size="15" fill="#64748b">Suma final</text>
          ${drawPie(390,160,70,6,5,'#fde68a')}
          ${svgFraction(390,270,5,6,{caption:'Resultat'})}
          <g aria-label="Operació" transform="translate(-120,210)">
            ${svgFraction(150,70,3,6,{size:22})}
            <text x="190" y="72" font-size="26" text-anchor="middle" fill="#0f172a">+</text>
            ${svgFraction(230,70,2,6,{size:22})}
            <text x="270" y="72" font-size="26" text-anchor="middle" fill="#0f172a">=</text>
            ${svgFraction(320,70,5,6,{size:26})}
          </g>
        </g>`;
      const doc=$('viz').querySelector('#zoneResult');
      doc.innerHTML=sum;
      // Quan es veu la suma, obrim la següent secció
      openNext('blk-2');
    }

    // ——— 3) Explicació guiada amb visuals ———
    const guideItems=[
      {html:`<b>Pas 1</b> · Denominadors: 2 i 3 → <b>MCM = 6</b>`, visual:`<div class="mini muted">Múltiples: 2→2,4,<b>6</b>,8… · 3→3,<b>6</b>,9…</div>`},
      {html:`<b>Pas 2</b> · Equivalències: ${frac(1,2)} → <b>${frac(3,6)}</b> i ${frac(1,3)} → <b>${frac(2,6)}</b>`, visual:`<div class="mini">${frac(1,2)} <span class="muted">×3</span> → ${frac(3,6)} &nbsp; · &nbsp; ${frac(1,3)} <span class="muted">×2</span> → ${frac(2,6)}</div>`},
      {html:`<b>Pas 3</b> · Suma: ${frac(3,6)} + ${frac(2,6)} = <b>${frac(5,6)}</b>`, visual:`<div class="mini">Només <b>suma el numerador</b>; el denominador es manté (6).</div>`},
      {html:`<b>Pas 4</b> · Simplificació`, visual:`<div class="mini">MCD(5,6)=1 → ja està simplificat ✅</div>`},
    ];
    let gIndex=0; const bar=$('bar');
    function addGuideStep(){
      if(gIndex>=guideItems.length){ $('nextStep').disabled=true; openNext('blk-3'); return }
      const li=document.createElement('li'); li.className='fade'; li.innerHTML=guideItems[gIndex].html + guideItems[gIndex].visual; $('guide').appendChild(li);
      gIndex++; bar.style.width=(gIndex/guideItems.length*100)+'%';
    }

    // ——— 4) Pràctica guiada (clara) ———
    function checkMCM(){
      const v=$('mcm').value.trim(); const ok=(v==='6');
      $('mcmMsg').innerHTML= ok?'<span class="ok">Correcte! El MCM és 6.</span>':'<span class="bad">No és el MCM. Prova amb 6.</span>';
      if(ok){ reveal('p2'); }
    }
    function checkEq(){
      const a2=$('a2n').value.trim(), c2=$('c2n').value.trim();
      const ok1=(a2==='3'), ok2=(c2==='2');
      $('eqMsg1').innerHTML = ok1?`<span class="ok">${frac(1,2)} = ${frac(3,6)}</span>`:`<span class="bad">Recorda: ${frac(1,2)} × 3 = ${frac(3,6)}</span>`;
      $('eqMsg2').innerHTML = ok2?`<span class="ok">${frac(1,3)} = ${frac(2,6)}</span>`:`<span class="bad">Recorda: ${frac(1,3)} × 2 = ${frac(2,6)}</span>`;
      if(ok1 && ok2){ $('eqMsg').innerHTML='<span class="ok">Perfecte! Ara suma.</span>'; reveal('p3'); $('showA2').textContent='3'; $('showC2').textContent='2'; }
    }
    function checkSum(){
      const n=$('sumN').value.trim(), d=$('sumD').value.trim();
      const ok=(n==='5' && d==='6');
      $('sumMsg').innerHTML= ok?`<span class="ok">Correcte: ${frac(5,6)}.</span>`:'<span class="bad">Revisa: 3+2=5 i el denominador es manté (6).</span>';
      if(ok){ reveal('p4'); }
    }

    // ——— 5) Joc senzill ———
    function renderGame(){
      $('game').innerHTML=`
        <p>Resol: ${frac(2,5)} + ${frac(1,10)}</p>
        <div class="row">
          <button class="btn" data-a>${frac(3,10)}</button>
          <button class="btn" data-b>${frac(1,2)}</button>
          <button class="btn" data-c>${frac(7,10)}</button>
        </div>
        <p id="gMsg" class="muted"></p>`;
      $('game').querySelector('[data-a]').onclick=()=>{$('gMsg').innerHTML='<span class="bad">No: cal MCM(5,10)=10.</span>'}
      $('game').querySelector('[data-b]').onclick=()=>{$('gMsg').innerHTML=`<span class="ok">Correcte! ${frac(2,5)} = ${frac(4,10)} → ${frac(4,10)} + ${frac(1,10)} = ${frac(5,10)} = ${frac(1,2)} ✅</span>`; openNext('blk-5');}
      $('game').querySelector('[data-c]').onclick=()=>{$('gMsg').innerHTML=`<span class="bad">No: ${frac(4,10)} + ${frac(1,10)} no dona ${frac(7,10)}.</span>`}
    }

    // ——— 6) Esdeveniments ———
    $('start').addEventListener('click',()=>{ reveal('blk-2'); renderIntro(); });
    $('btnShowMCM').addEventListener('click',showMCM);
    $('btnShowSum').addEventListener('click',showSum);

    $('nextStep').addEventListener('click',addGuideStep);

    $('mcmChk').addEventListener('click',checkMCM);
    $('eqChk').addEventListener('click',checkEq);
    $('sumChk').addEventListener('click',checkSum);

    function showGameSection(){
      reveal('blk-5');
      renderGame();
    }

    $('toGame').addEventListener('click',showGameSection);

    $('restart').addEventListener('click',()=>{ location.reload(); });

    const gridToggle=$('gridToggle');
    if(gridToggle){
      gridToggle.setAttribute('aria-pressed',document.body.classList.contains('dots'));
      gridToggle.addEventListener('click',()=>{
        document.body.classList.toggle('dots');
        gridToggle.setAttribute('aria-pressed',document.body.classList.contains('dots'));
        savePrefs();
      });
    }

    document.addEventListener('keydown',e=>{
      if(e.defaultPrevented) return;
      if(e.target.closest('input,textarea')) return;
      const key=e.key.length===1?e.key.toLowerCase():e.key;
      if(key==='n'){
        const nextBtn=$('nextStep');
        if(nextBtn && !nextBtn.disabled && !nextBtn.closest('.hidden')){
          nextBtn.click();
          e.preventDefault();
        }
      }
      if(key==='g'){
        showGameSection();
        e.preventDefault();
      }
      if(e.key==='?'){
        alert('Dreceres: N (següent pas), G (anar al joc), Enter valida al camp actiu.');
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
