<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FocusQuiz ¬∑ C√†psula ¬∑ Suma de fraccions (denominadors diferents)</title>
  <meta name="description" content="C√†psula visual i seq√ºencial: objectiu ‚Üí introducci√≥ ‚Üí explicaci√≥ visual ‚Üí pr√†ctica guiada ‚Üí joc ‚Üí resum. Exemple base 1/2 + 1/3 amb transformaci√≥ a sisens i suma final." />
  <style>
    :root{
      --bg:#f8fafc;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;
      --brand:#8ec5ff;--brand2:#a7f3d0;--brand3:#fbcfe8;--ok:#10b981;--bad:#ef4444;--warn:#f59e0b;
      --shadow:0 10px 30px rgba(2,8,23,.08);
      --grid-fine:#e9eef6;--grid-bold:#d9e2f1;--grid-blur:0.3px;--grid-size:24px;--grid-mult:5;
      --focus:#7bb0ff;
    }
    body.dark{
      --grid-fine:#1b2535;
      --grid-bold:#162031;
      --grid-blur:0.2px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);position:relative;min-height:100vh;}
    body::before{
      content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;
      background:
        repeating-linear-gradient(
          to right,
          transparent 0 calc(var(--grid-size)*(var(--grid-mult) - 0.1)),
          var(--grid-bold) 0 calc(var(--grid-size)*var(--grid-mult))
        ),
        repeating-linear-gradient(
          to bottom,
          transparent 0 calc(var(--grid-size)*(var(--grid-mult) - 0.1)),
          var(--grid-bold) 0 calc(var(--grid-size)*var(--grid-mult))
        ),
        repeating-linear-gradient(
          to right,
          var(--grid-fine) 0 1px,
          transparent 1px var(--grid-size)
        ),
        repeating-linear-gradient(
          to bottom,
          var(--grid-fine) 0 1px,
          transparent 1px var(--grid-size)
        ),
        var(--bg);
      background-attachment:fixed;
      filter:blur(var(--grid-blur));
    }
    body.dots::before{
      background:
        radial-gradient(var(--grid-fine) 1px,transparent 1px) 0 0/ var(--grid-size) var(--grid-size),
        radial-gradient(var(--grid-bold) 1px,transparent 1px) 0 0/ calc(var(--grid-size)*var(--grid-mult)) calc(var(--grid-size)*var(--grid-mult)),
        var(--bg);
      filter:none;
    }
    @media print{
      body{background:#fff!important;}
      body::before{display:none;}
    }
    section{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    h1,h2{margin:6px 0 10px}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:linear-gradient(135deg,var(--brand),var(--brand3));color:#0b1220;font-weight:600;cursor:pointer;box-shadow:0 4px 14px rgba(2,8,23,.08)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn:hover{transform:translateY(-1px)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .frac{display:inline-grid;grid-template-rows:auto auto;line-height:1}
    .frac>i{height:2px;background:#111827;border-radius:2px;margin:2px 0}
    .input{padding:10px 12px;border:1px solid var(--line);border-radius:10px;width:110px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .hidden{display:none}
    .fade{opacity:0;transform:translateY(6px);animation:fade .4s forwards}
    @keyframes fade{to{opacity:1;transform:none}}
    .progress{height:8px;background:var(--line);border-radius:999px;overflow:hidden}
    .bar{height:8px;width:0;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:.3s width}
    svg{max-width:100%;height:auto}
    .mini{font-size:.95rem}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted)}
    .list{display:grid;grid-template-columns:1fr auto 1fr;gap:6px;align-items:center}
    .topbar{justify-content:flex-end}
    .topbar .btn{min-width:44px;padding:8px 12px}
    .btn:focus-visible,.input:focus-visible,.topbar button:focus-visible{outline:3px solid var(--focus);outline-offset:2px;border-radius:12px}
    @media (prefers-reduced-motion:no-preference){
      .card{transition:box-shadow .2s ease,transform .15s ease}
      .card:hover{transform:translateY(-1px);box-shadow:0 14px 34px rgba(2,8,23,.1)}
      .btn{transition:transform .12s ease,box-shadow .12s ease}
      .btn:active{transform:translateY(0)}
    }
    @media (prefers-reduced-motion:reduce){
      *{animation:none!important;transition:none!important}
    }
  </style>
</head>
<body>
  <section id="capsule">
    <div class="row topbar" aria-label="Eines de fons">
      <button class="btn" id="gridToggle" type="button" aria-label="Canvia el patr√≥ de fons" title="Canvia fons">üìê</button>
    </div>
    <!-- 1) Objectiu did√†ctic -->
    <article class="card" id="blk-1">
      <h1>Objectiu d‚Äôaprenentatge</h1>
      <div class="toast small">Quan <b>denominadors s√≥n diferents</b> ‚Üí <b>MCM</b> ‚Üí <b>equival√®ncies</b> ‚Üí <b>suma</b> ‚Üí <b>simplificaci√≥</b>.</div>
      <p>Al final podr√†s: (1) trobar el <b>MCM</b>, (2) convertir a <b>denominador com√∫</b>, (3) sumar <b>nom√©s els numeradors</b>, (4) <b>simplificar</b> el resultat.</p>
      <div class="row"><button class="btn primary" id="start">Comen√ßa</button><span class="pill">Criteris d‚Äô√®xit: aplica MCM correctament ‚â• 80% dels casos</span></div>
    </article>

    <article class="card hidden" id="blk-2">
      <h2>Demostraci√≥ visual</h2>
      <p class="muted">Exemple base <span class="pill">1/2 + 1/3</span>. Convertim a sisens (MCM=6) i sumem.</p>
      <div id="viz" class="fade" role="img" aria-label="Diagrama circular de fraccions amb transformaci√≥ a sisens"></div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <span class="pill">Exemple: <span class="frac"><b>1</b><i></i><b>2</b></span> + <span class="frac"><b>1</b><i></i><b>3</b></span></span>
        <div class="row">
          <button class="btn" id="btnShowMCM">Mostra MCM i equival√®ncies</button>
          <button class="btn" id="btnShowSum" disabled>Mostra la suma</button>
          <button class="btn" data-retry="2">Reinicia aquest pas</button>
        </div>
      </div>
    </article>

    <article class="card hidden" id="blk-3">
      <h2>Guia pas a pas</h2>
      <ol id="guide" class="fade small" style="margin:0 0 8px 18px"></ol>
      <div class="row"><button class="btn primary" id="nextStep">Seg√ºent pas</button><button class="btn" data-retry="3">Reinicia aquest pas</button></div>
    </article>

    <article class="card hidden" id="blk-4">
      <h2>Pr√†ctica guiada</h2>
      <p class="muted">Completa cada pas. Quan el facis b√©, s‚Äôobrir√† el seg√ºent.</p>
      <div id="p1" class="fade">
        <h3>Pas 1 ¬∑ Troba el MCM (2 i 3) <span class="pill" id="bc1">Pas 1/4</span></h3>
        <div class="row"><input id="mcm" class="input" placeholder="Escriu el MCM" aria-label="Resposta MCM"/><button class="btn" id="mcmChk">Comprova</button><button class="btn" data-retry="p1">Reinicia</button><span id="mcmMsg" class="muted"></span></div>
        <div class="small muted">Pista 1: m√∫ltiples de 2 ‚Üí 2,4,6‚Ä¶ ¬∑ 3 ‚Üí 3,6,9‚Ä¶ <span id="pistaMCM" class="hidden">Pista 2: el primer m√∫ltiple compartit √©s 6.</span></div>
      </div>
      <div id="p2" class="hidden">
        <h3>Pas 2 ¬∑ Equival√®ncies a sisens <span class="pill" id="bc2">Pas 2/4</span></h3>
        <div class="grid">
          <div class="row"><div><span class="frac"><b>1</b><i></i><b>2</b></span> ‚Üí</div><div class="row"><input id="a2n" class="input" placeholder="numerador"/><span class="frac"><b>&nbsp;</b><i></i><b>6</b></span></div><span id="eqMsg1" class="muted"></span></div>
          <div class="row"><div><span class="frac"><b>1</b><i></i><b>3</b></span> ‚Üí</div><div class="row"><input id="c2n" class="input" placeholder="numerador"/><span class="frac"><b>&nbsp;</b><i></i><b>6</b></span></div><span id="eqMsg2" class="muted"></span></div>
        </div>
        <div class="row"><button class="btn" id="eqChk">Comprova</button><button class="btn" data-retry="p2">Reinicia</button><span id="eqMsg" class="muted"></span></div>
      </div>
      <div id="p3" class="hidden">
        <h3>Pas 3 ¬∑ Fes la suma <span class="pill" id="bc3">Pas 3/4</span></h3>
        <div class="row">
          <span class="frac"><b id="showA2">3</b><i></i><b>6</b></span> + <span class="frac"><b id="showC2">2</b><i></i><b>6</b></span> =
          <div class="frac"><b><input id="sumN" class="input" placeholder="numerador"/></b><i></i><b><input id="sumD" class="input" value="6" readonly/></b></div>
          <button class="btn" id="sumChk">Comprova</button><button class="btn" data-retry="p3">Reinicia</button><span id="sumMsg" class="muted"></span>
        </div>
        <div class="small muted">Error t√≠pic: <span class="pill">sumar denominadors</span>. No ho facis.</div>
      </div>
      <div id="p4" class="hidden">
        <h3>Pas 4 ¬∑ Resultat i simplificaci√≥ <span class="pill" id="bc4">Pas 4/4</span></h3>
        <div class="row"><span class="pill">Resultat: <span class="frac"><b id="resN">5</b><i></i><b id="resD">6</b></span></span><span class="ok" id="simpMsg">Ja est√† simplificat ‚úÖ</span></div>
        <div class="row"><button class="btn primary" id="toGame">Anar al joc</button><button class="btn" data-retry="p4">Reinicia</button></div>
      </div>
    </article>

    <article class="card hidden" id="blk-5">
      <h2>Joc interactiu</h2>
      <div id="game" class="fade small"></div>
      <div class="row"><button class="btn" id="moreGame">Nou repte</button><button class="btn" data-retry="5">Reinicia aquest pas</button><a class="btn" href="#blk-7">Ves a Exercicis</a></div>
    </article>

    <article class="card hidden" id="blk-7">
      <h2>Exercicis d‚Äôentrenament</h2>
      <p class="muted">Pr√†ctiques variades amb generador aleatori i Mastery Check.</p>
      <div class="grid">
        <div class="card">
          <h3>MCM r√†pid ¬∑ 10 √≠tems</h3>
          <div id="mcmFlash"></div>
          <div class="row"><button class="btn primary" id="mcmRun">Comen√ßa</button><span id="mcmScore" class="pill">0/0</span></div>
        </div>
        <div class="card">
          <h3>Equival√®ncies dirigides</h3>
          <div id="eqDir"></div>
          <div class="row"><button class="btn primary" id="eqDirRun">Comen√ßa</button><span id="eqDirScore" class="pill">0/0</span></div>
        </div>
        <div class="card">
          <h3>Suma guiada (aleat√≤ria)</h3>
          <div id="sumTrain"></div>
          <div class="row"><button class="btn primary" id="sumRun">Comen√ßa</button><span id="sumScore" class="pill">0/0</span></div>
        </div>
        <div class="card">
          <h3>Simplificaci√≥</h3>
          <div id="simpTrain"></div>
          <div class="row"><button class="btn primary" id="simpRun">Comen√ßa</button><span id="simpScore" class="pill">0/0</span></div>
        </div>
        <div class="card">
          <h3>Mastery Check ¬∑ 8 √≠tems</h3>
          <div id="master"></div>
          <div class="row"><button class="btn primary" id="masterRun">Inicia</button><span id="masterScore" class="pill">0/0</span><span class="muted small">Aprovat amb 6/8</span></div>
        </div>
      </div>
    </article>

    <article class="card hidden" id="blk-6">
      <h2>Resum i recomanacions</h2>
      <ul>
        <li>Troba el <b>MCM</b> dels denominadors.</li>
        <li>Converteix a <b>denominador com√∫</b> (fraccions equivalents).</li>
        <li><b>Suma</b> els numeradors; el denominador es mant√©.</li>
        <li><b>Simplifica</b> si cal.</li>
      </ul>
      <div class="row"><button class="btn" id="restart">Torna a comen√ßar</button><button class="btn" id="printSum">Imprimeix resum</button></div>
      <div class="printOnly small"><hr/>Errors freq√ºents: sumar denominadors; confondre MCM amb MCD.</div>
    </article>
  </section>

  <script>
    // ‚Äî‚Äî‚Äî Utilitats visuals ‚Äî‚Äî‚Äî
    const $=id=>document.getElementById(id);
    const gcd=(a,b)=>b?gcd(b,a%b):Math.abs(a);
    const prefersReduced = typeof window.matchMedia==='function' && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const PREF_KEY='fq_capsula_suma_prefs';

    function scrollToEl(el){
      if(!el) return;
      const behavior=prefersReduced?'auto':'smooth';
      el.scrollIntoView({behavior,block:'start'});
    }

    function safeParse(json){
      try{return JSON.parse(json);}catch{return null;}
    }

    function savePrefs(){
      try{
        const prefs={dots:document.body.classList.contains('dots')};
        localStorage.setItem(PREF_KEY,JSON.stringify(prefs));
      }catch(err){/* ignore storage errors */}
    }

    function loadPrefs(){
      try{
        const stored=safeParse(localStorage.getItem(PREF_KEY));
        if(stored?.dots){ document.body.classList.add('dots'); }
      }catch(err){/* ignore */}
    }

    loadPrefs();

    function drawPie(cx,cy,r,parts,fill,color){
      let out='';const tau=Math.PI*2,off=-Math.PI/2;
      for(let i=0;i<parts;i++){
        const a0=off+i*(tau/parts),a1=off+(i+1)*(tau/parts);
        const x0=cx+r*Math.cos(a0),y0=cy+r*Math.sin(a0),x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
        const large=(a1-a0)>Math.PI?1:0;
        const p=`M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z`;
        out+=`<path d="${p}" fill="${i<fill?color:'#e5e7eb'}" stroke="#94a3b8"/>`;
      }
      return out;
    }

    // ‚Äî‚Äî‚Äî 1) Flux seq√ºencial ‚Äî‚Äî‚Äî
    const order=['blk-1','blk-2','blk-3','blk-4','blk-5','blk-6'];
    function reveal(id){
      const el=$(id);
      if(!el) return;
      const wasHidden=el.classList.contains('hidden');
      el.classList.remove('hidden');
      if(wasHidden) el.classList.add('fade');
      scrollToEl(el);
    }
    function openNext(currId){
      const i=order.indexOf(currId); if(i>-1 && i<order.length-1){
        const nextId=order[i+1];
        reveal(nextId);
      }
    }

    // ‚Äî‚Äî‚Äî 2) Introducci√≥ visual ‚Äî‚Äî‚Äî
    function renderIntro(){
      // Primer: mostrem nom√©s 1/2 i 1/3 a dalt
      const svg=`<svg viewBox="0 0 820 240">
        <g>
          ${drawPie(150,90,70,2,1,'#93c5fd')}<text x="150" y="190" text-anchor="middle" fill="#334155">1/2</text>
        </g>
        <g>
          ${drawPie(390,90,70,3,1,'#fbcfe8')}<text x="390" y="190" text-anchor="middle" fill="#334155">1/3</text>
        </g>
        <text x="270" y="100" font-size="26" text-anchor="middle" fill="#0f172a">+</text>
        <!-- zona inferior preparada per a la transformaci√≥ i la suma -->
        <g id="zone2"></g>
      </svg>`;
      $('viz').innerHTML=svg;
    }

    function showMCM(){
      // A sota apareixen 3/6 i 2/6
      const zone=`
        <g>
          ${drawPie(150,160,60,6,3,'#a7f3d0')}<text x="150" y="230" text-anchor="middle" fill="#0f172a">3/6</text>
        </g>
        <g>
          ${drawPie(390,160,60,6,2,'#c7d2fe')}<text x="390" y="230" text-anchor="middle" fill="#0f172a">2/6</text>
        </g>
      `;
      const doc=$('viz').querySelector('#zone2');
      doc.innerHTML=zone;
      $('btnShowSum').disabled=false;
    }

    function showSum(){
      // A la dreta apareix la suma final 5/6
      const sum=`
        <g>
          ${drawPie(650,160,70,6,5,'#fde68a')}<text x="650" y="230" text-anchor="middle" fill="#0f172a">3/6 + 2/6 = 5/6</text>
        </g>`;
      const doc=$('viz').querySelector('#zone2');
      doc.innerHTML+=sum;
      // Quan es veu la suma, obrim la seg√ºent secci√≥
      openNext('blk-2');
    }

    // ‚Äî‚Äî‚Äî 3) Explicaci√≥ guiada amb visuals ‚Äî‚Äî‚Äî
    const guideItems=[
      {html:`<b>Pas 1</b> ¬∑ Denominadors: 2 i 3 ‚Üí <b>MCM = 6</b>`, visual:`<div class="mini muted">M√∫ltiples: 2‚Üí2,4,<b>6</b>,8‚Ä¶ ¬∑ 3‚Üí3,<b>6</b>,9‚Ä¶</div>`},
      {html:`<b>Pas 2</b> ¬∑ Equival√®ncies: 1/2 ‚Üí <b>3/6</b> i 1/3 ‚Üí <b>2/6</b>`, visual:`<div class="mini">1/2 <span class="muted">√ó3</span> ‚Üí 3/6 &nbsp; ¬∑ &nbsp; 1/3 <span class="muted">√ó2</span> ‚Üí 2/6</div>`},
      {html:`<b>Pas 3</b> ¬∑ Suma: 3/6 + 2/6 = <b>5/6</b>`, visual:`<div class="mini">Nom√©s <b>suma el numerador</b>; el denominador es mant√© (6).</div>`},
      {html:`<b>Pas 4</b> ¬∑ Simplificaci√≥`, visual:`<div class="mini">MCD(5,6)=1 ‚Üí ja est√† simplificat ‚úÖ</div>`},
    ];
    let gIndex=0; const bar=$('bar');
    function addGuideStep(){
      if(gIndex>=guideItems.length){ $('nextStep').disabled=true; openNext('blk-3'); return }
      const li=document.createElement('li'); li.className='fade'; li.innerHTML=guideItems[gIndex].html + guideItems[gIndex].visual; $('guide').appendChild(li);
      gIndex++; bar.style.width=(gIndex/guideItems.length*100)+'%';
    }

    // ‚Äî‚Äî‚Äî 4) Pr√†ctica guiada (clara) ‚Äî‚Äî‚Äî
    function checkMCM(){
      const v=$('mcm').value.trim(); const ok=(v==='6');
      $('mcmMsg').innerHTML= ok?'<span class="ok">Correcte! El MCM √©s 6.</span>':'<span class="bad">No √©s el MCM. Prova amb 6.</span>';
      if(ok){ reveal('p2'); }
    }
    function checkEq(){
      const a2=$('a2n').value.trim(), c2=$('c2n').value.trim();
      const ok1=(a2==='3'), ok2=(c2==='2');
      $('eqMsg1').innerHTML = ok1?'<span class="ok">1/2 = 3/6</span>':'<span class="bad">Recorda: 1/2 √ó 3 = 3/6</span>';
      $('eqMsg2').innerHTML = ok2?'<span class="ok">1/3 = 2/6</span>':'<span class="bad">Recorda: 1/3 √ó 2 = 2/6</span>';
      if(ok1 && ok2){ $('eqMsg').innerHTML='<span class="ok">Perfecte! Ara suma.</span>'; reveal('p3'); $('showA2').textContent='3'; $('showC2').textContent='2'; }
    }
    function checkSum(){
      const n=$('sumN').value.trim(), d=$('sumD').value.trim();
      const ok=(n==='5' && d==='6');
      $('sumMsg').innerHTML= ok?'<span class="ok">Correcte: 5/6.</span>':'<span class="bad">Revisa: 3+2=5 i el denominador es mant√© (6).</span>';
      if(ok){ reveal('p4'); }
    }

    // ‚Äî‚Äî‚Äî 5) Joc senzill ‚Äî‚Äî‚Äî
    function renderGame(){
      $('game').innerHTML=`
        <p>Resol: <span class="frac"><b>2</b><i></i><b>5</b></span> + <span class="frac"><b>1</b><i></i><b>10</b></span></p>
        <div class="row">
          <button class="btn" data-a>3/10</button>
          <button class="btn" data-b>1/2</button>
          <button class="btn" data-c>7/10</button>
        </div>
        <p id="gMsg" class="muted"></p>`;
      $('game').querySelector('[data-a]').onclick=()=>{$('gMsg').innerHTML='<span class="bad">No: cal MCM(5,10)=10.</span>'}
      $('game').querySelector('[data-b]').onclick=()=>{$('gMsg').innerHTML='<span class="ok">Correcte! 2/5=4/10 ‚Üí 4/10+1/10=5/10=1/2 ‚úÖ</span>'; openNext('blk-5');}
      $('game').querySelector('[data-c]').onclick=()=>{$('gMsg').innerHTML='<span class="bad">No: 4/10+1/10 no dona 7/10.</span>'}
    }

    // ‚Äî‚Äî‚Äî 6) Esdeveniments ‚Äî‚Äî‚Äî
    $('start').addEventListener('click',()=>{ reveal('blk-2'); renderIntro(); });
    $('btnShowMCM').addEventListener('click',showMCM);
    $('btnShowSum').addEventListener('click',showSum);

    $('nextStep').addEventListener('click',addGuideStep);

    $('mcmChk').addEventListener('click',checkMCM);
    $('eqChk').addEventListener('click',checkEq);
    $('sumChk').addEventListener('click',checkSum);

    function showGameSection(){
      reveal('blk-5');
      renderGame();
    }

    $('toGame').addEventListener('click',showGameSection);

    $('restart').addEventListener('click',()=>{ location.reload(); });

    const gridToggle=$('gridToggle');
    if(gridToggle){
      gridToggle.setAttribute('aria-pressed',document.body.classList.contains('dots'));
      gridToggle.addEventListener('click',()=>{
        document.body.classList.toggle('dots');
        gridToggle.setAttribute('aria-pressed',document.body.classList.contains('dots'));
        savePrefs();
      });
    }

    document.addEventListener('keydown',e=>{
      if(e.defaultPrevented) return;
      if(e.target.closest('input,textarea')) return;
      const key=e.key.length===1?e.key.toLowerCase():e.key;
      if(key==='n'){
        const nextBtn=$('nextStep');
        if(nextBtn && !nextBtn.disabled && !nextBtn.closest('.hidden')){
          nextBtn.click();
          e.preventDefault();
        }
      }
      if(key==='g'){
        showGameSection();
        e.preventDefault();
      }
      if(e.key==='?'){
        alert('Dreceres: N (seg√ºent pas), G (anar al joc), Enter valida al camp actiu.');
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
