<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FocusQuiz ¬∑ C√†psules ¬∑ Resta portant (Prim√†ria, sense √†udio)</title>
  <meta name="description" content="C√†psula de resta portant per Prim√†ria: 4 sessions guiades, animacions de pr√©stec i exercicis autocorrectius. Single-file, sense depend√®ncies. (Versi√≥ sense √†udio)" />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --brand:#93c5fd; --brand-2:#a7f3d0; --brand-3:#fbcfe8; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.07), 0 4px 12px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--ink)}

    .wrap{max-width:1180px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .left{display:flex;align-items:center;gap:10px}
    .logo{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:var(--shadow);font-weight:900}
    h1{font-size:clamp(1.3rem,1.1rem + 2vw,2.4rem);margin:0}
    .sub{color:var(--muted)}

    .top-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{background:#eef2ff;color:#3730a3;border-radius:999px;padding:8px 12px;font-size:.95rem;text-decoration:none;display:inline-flex;align-items:center;gap:6px;font-weight:600}

    .grid{display:grid;grid-template-columns:300px 1fr; gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .inner{padding:18px}

    /* ======= Sessions sidebar ======= */
    .steps{display:grid;gap:10px}
    .step{display:flex;gap:12px;align-items:center;border:2px solid var(--line);padding:14px;border-radius:16px;cursor:pointer;background:#fff;transition:transform .18s ease, box-shadow .18s ease, border-color .2s ease}
    .step:hover{transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.06); border-color:rgba(148,163,184,0.6)}
    .step.locked{opacity:.5; cursor:not-allowed}
    .ico{width:38px;height:38px;border-radius:12px;display:grid;place-items:center;background:#f1f5f9;font-size:1.2rem}
    .step .meta{display:flex;flex-direction:column;line-height:1.1}
    .step .meta small{color:var(--muted)}
    .status{margin-left:auto;font-weight:800}
    .status.ok{color:var(--ok)}
    .status.do{color:#111}

    /* ======= Page transitions ======= */
    .view{min-height:560px}
    .fade-enter{animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none}}

    /* ======= Operation layout ======= */
    .op{position:relative; display:inline-grid; grid-template-columns:repeat(var(--cols,3), minmax(2ch, 2.6ch)); gap:.4ch; align-items:end; padding:14px; border-radius:16px; background:#f8fafc; border:2px solid var(--line)}
    .col{position:relative; text-align:center; min-width:2ch}
    .col .top,.col .bot{font-size:2rem; font-variant-numeric:tabular-nums}
    .col .borrow{position:absolute; top:-14px; left:50%; transform:translateX(-50%); font-size:1rem; color:#334155}
    .minus{grid-column:1/-1; border-top:3px solid #111; margin-top:5px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}

    input.dig{width:2.6ch;text-align:center;border:2px solid var(--line);border-radius:10px;padding:8px 0;font-size:1.2rem}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select, button{appearance:none;border:2px solid var(--line);background:#fff;border-radius:14px;padding:12px 14px;font-size:1.05rem}
    button{cursor:pointer}
    button.primary{background:#111;color:#fff;border:none}
    button.ghost{background:transparent;border:2px dashed var(--line)}
    button.ok{background:var(--ok);color:#fff;border:none}
    button.warn{background:var(--warn);color:#111;border:none}

    .result{padding:12px 14px;border-radius:14px;font-weight:800;display:inline-flex;align-items:center;gap:10px;font-size:1.05rem}
    .result.ok{background:#ecfdf5;color:#065f46}
    .result.no{background:#fef2f2;color:#7f1d1d}

    .note{padding:12px 14px;border-radius:14px;background:#fff7ed;border:2px solid #fed7aa;color:#7c2d12;font-size:1.05rem}

    .progress{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress > div{height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-3)); width:0}

    .coach{display:flex;gap:12px;align-items:flex-start;background:#f1f5f9;border:2px solid var(--line);padding:14px;border-radius:16px}
    .coach .avatar{width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg,var(--brand-3),var(--brand));display:grid;place-items:center;font-weight:900;color:#111;font-size:1.1rem}
    .coach .bubble{line-height:1.3;font-size:1.08rem}

    .kbd{border:2px solid #cbd5e1;background:#fff;border-bottom-width:4px;padding:2px 8px;border-radius:8px;font-weight:900}

    /* ======= Highlights i animacions ======= */
    .hl{background:#fffbea; box-shadow:0 0 0 4px #fef3c7 inset; border-radius:8px}
    .pulse{animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)}}
    .ten-token{position:absolute; width:32px; height:32px; border-radius:999px; background:#a7f3d0; color:#065f46; display:grid; place-items:center; font-weight:900; box-shadow:var(--shadow); pointer-events:none; opacity:0; transform:scale(.8); transition:transform .6s ease, opacity .6s ease}

    /* ======= Test runner ======= */
    #tests{font-size:.9rem;color:#111;background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:8px 10px;display:none;margin-top:10px}
    #tests.pass{background:#ecfdf5;border-color:#a7f3d0}
    #tests.fail{background:#fef2f2;border-color:#fecaca}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="left">
        <div class="logo">FQ</div>
        <div>
          <h1>FocusQuiz ¬∑ C√†psules ‚Äî Resta portant</h1>
          <div class="sub">Pensada per Prim√†ria. 4 sessions curtes amb animacions. Cada sessi√≥ es desbloqueja quan superes la prova üëá</div>
        </div>
      </div>
      <div class="top-controls">
        <span class="pill">Progr√©s total: <b id="allPct">0%</b></span>
        <a class="pill" href="index.html">‚Üê Torna a Focus Academy</a>
      </div>
    </header>

    <section class="grid">
      <aside class="card" aria-label="Sessions">
        <div class="inner">
          <div class="steps" id="steps"></div>
          <div id="tests" aria-live="polite"></div>
        </div>
      </aside>

      <main class="card view fade-enter" id="view">
        <div class="inner" id="screen"></div>
      </main>
    </section>
  </div>

  <script>
  // ===== Utils =====
  const $ = (q,el=document)=>el.querySelector(q);
  const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
  const rng = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;

  const LS_KEY = 'fq_capsula_resta_portant_primaria_v3_noaudio';
  const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  if(!state.progress){ state.progress = { s1:false, s2:false, s3:false, s4:false }; }
  if(typeof state.best3 !== 'number') state.best3 = 0;

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  const SESS = [
    { id:'s1', title:'1) Mira i ent√©n', sub:'Qu√® fem quan no podem restar? Amb animaci√≥.', icon:'üëÄ' },
    { id:'s2', title:'2) Fem-ho pas a pas', sub:'Una columna cada cop, pista visual.', icon:'üß±' },
    { id:'s3', title:'3) Practiquem r√†pid', sub:'5 bones en 90 s. Pots repetir!', icon:'‚è±Ô∏è' },
    { id:'s4', title:'4) Prova final', sub:'10 preguntes. A partir de 8, aprovat!', icon:'üéØ' },
  ];

  const isUnlocked = (idx)=> idx===0 || SESS.slice(0,idx).every(prev=>state.progress[prev.id]);

  function percentAll(){ const v = Object.values(state.progress).filter(Boolean).length; return Math.round(v/4*100); }

  function renderSteps(){
    const box = $('#steps'); box.innerHTML='';
    SESS.forEach((s,idx)=>{
      const unlocked = isUnlocked(idx);
      const done = !!state.progress[s.id];
      const el = document.createElement('div'); el.className = 'step' + (unlocked?'':' locked'); el.dataset.id = s.id;
      el.innerHTML = `<div class="ico">${s.icon}</div>
        <div class="meta"><b>${s.title}</b><small>${s.sub}</small></div>
        <div class="status ${done?'ok':'do'}">${done?'Fet ‚úÖ': (unlocked?'Inicia':'Blocat')}</div>`;
      if(unlocked){ el.addEventListener('click', ()=> openSession(s.id)); }
      box.appendChild(el);
    });
    $('#allPct').textContent = percentAll()+"%";
  }

  // NOTE IMPORTANT: primer afegim la vista al DOM, DESPR√âS inicialitzem la sessi√≥.
  function openSession(id){
    const host = $('#screen');
    host.innerHTML='';
    const view = document.createElement('div');
    view.className='fade-enter';
    host.appendChild(view); // üëâ Ara la vista ja √©s al DOM
    if(id==='s1') initS1(view);
    else if(id==='s2') initS2(view);
    else if(id==='s3') initS3(view);
    else initS4(view);
    renderSteps();
  }

  // ===== Generaci√≥ d'operacions =====
  function needsBorrow(a,b){
    const sa = String(a).padStart(Math.max(String(a).length,String(b).length),'0');
    const sb = String(b).padStart(sa.length,'0');
    for(let i=sa.length-1;i>=0;i--){ if(+sa[i] < +sb[i]) return true; }
    return false;
  }
  function genPair(d){ let a,b; const min=10**(d-1), max=10**d-1; do{ a=rng(min,max); b=rng(min,a-1);} while(!needsBorrow(a,b)); return [a,b]; }

  function renderOperation(container, a, b, withInputs=true, showSteps=false){
    container.innerHTML='';
    const cols = Math.max(String(a).length,String(b).length);
    const root = document.createElement('div'); root.className='op'; root.style.setProperty('--cols',cols); root.dataset.cols=String(cols);
    const sa = String(a).padStart(cols,'0'); const sb = String(b).padStart(cols,'0');

    const originalTop = sa.split('').map(Number);
    const bottomDigits = sb.split('').map(Number);
    let workingTop = originalTop.slice();
    const displayTop = sa.split('');
    const borrowMarks = new Array(cols).fill('');
    if(showSteps){
      for(let i=cols-1;i>=0;i--){
        if(workingTop[i] < bottomDigits[i]){
          let k=i-1;
          while(k>=0 && workingTop[k]===0) k--;
          if(k>=0){
            workingTop[k]-=1;
            for(let j=k+1;j<i;j++) workingTop[j]+=9;
            workingTop[i]+=10;
            borrowMarks[i]='10';
          }
        }
        displayTop[i] = String(workingTop[i]);
      }
    }

    for(let i=0;i<cols;i++){
      const c=document.createElement('div'); c.className='col';
      const sup=document.createElement('div'); sup.className='borrow'; sup.textContent=borrowMarks[i]||'';
      const t=document.createElement('div'); t.className='top'; t.textContent=showSteps?displayTop[i]:sa[i];
      c.appendChild(sup); c.appendChild(t); root.appendChild(c);
    }
    for(let i=0;i<cols;i++){
      const c=document.createElement('div'); c.className='col';
      const t=document.createElement('div'); t.className='bot'; t.textContent=sb[i];
      c.appendChild(t); root.appendChild(c);
    }
    const line=document.createElement('div'); line.className='minus'; root.appendChild(line);

    const inputs=[]; if(withInputs){ for(let i=0;i<cols;i++){ const c=document.createElement('div'); c.className='col'; const inp=document.createElement('input'); inp.className='dig mono'; inp.maxLength=1; inp.inputMode='numeric'; inp.pattern='[0-9]'; c.appendChild(inp); root.appendChild(c); inputs.push(inp);} }
    container.appendChild(root);

    if(inputs.length){
      inputs[0].focus();
      inputs.forEach((el,idx)=>{
        el.addEventListener('input',()=>{ if(el.value.length===1 && idx<inputs.length-1) inputs[idx+1].focus(); });
        el.addEventListener('keydown',(e)=>{
          if(e.key==='ArrowLeft' && idx>0){inputs[idx-1].focus();e.preventDefault();}
          if(e.key==='ArrowRight' && idx<inputs.length-1){inputs[idx+1].focus();e.preventDefault();}
        });
      });
    }

    return {cols,inputs,root,topDigits: (showSteps?workingTop:originalTop).slice(),bottomDigits};
  }

  function highlightColumn(opRoot, colIndex){
    const cols = Number(opRoot.dataset.cols||'0');
    if(!cols) return;
    $$('.col', opRoot).forEach((c,i)=> c.classList.toggle('hl', colIndex>=0 && i%cols===colIndex));
  }

  function animateBorrow(opRoot, from, to){
    const cols = Number(opRoot.dataset.cols||'0');
    if(!cols || from<0 || to<0) return;
    const topCols = $$('.col', opRoot).slice(0, cols);
    const fromCol = topCols[from];
    const toCol = topCols[to];
    if(!fromCol || !toCol) return;

    fromCol.classList.add('pulse');
    const token = document.createElement('div');
    token.className='ten-token';
    token.textContent='10';
    opRoot.appendChild(token);
    const rootRect = opRoot.getBoundingClientRect();
    const fromRect = fromCol.getBoundingClientRect();
    const toRect = toCol.getBoundingClientRect();
    const startX = fromRect.left - rootRect.left + fromRect.width/2 - 16;
    const startY = fromRect.top - rootRect.top - 26;
    token.style.left = `${startX}px`;
    token.style.top = `${startY}px`;
    requestAnimationFrame(()=>{
      token.style.opacity='1';
      token.style.transform='scale(1)';
      const dx = toRect.left - fromRect.left;
      const dy = toRect.top - fromRect.top;
      requestAnimationFrame(()=>{ token.style.transform=`translate(${dx}px, ${dy}px) scale(0.9)`; });
      setTimeout(()=>{ token.style.opacity='0'; }, 420);
    });
    setTimeout(()=>{
      token.remove();
      fromCol.classList.remove('pulse');
    }, 780);
  }

  /* ===== SESSI√ì 1 ‚Äî Mira i ent√©n ===== */
  function initS1(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>1) Mira i ent√©n</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Si <b>no podem restar</b>, demanem <b>una desena</b> al ve√≠ de l'esquerra. Aquesta desena val <b>10</b> i ens ajuda. Mira l'animaci√≥ i despr√©s prova-ho.</div></div>
      <div style="height:12px"></div>
      <div class="controls">
        <label>Nivell
          <select id="s1level">
            <option value="2">2 xifres</option>
            <option value="3" selected>3 xifres</option>
            <option value="4">4 xifres</option>
          </select>
        </label>
        <button id="s1demo" class="ok">‚ñ∂Ô∏è Mostra animaci√≥</button>
        <button id="s1new" class="ghost">Nova operaci√≥</button>
      </div>
      <div id="s1op" style="margin:12px 0"></div>
      <div class="note"><b>Objectiu:</b> Aconsegueix <b>2 encerts seguits</b> per obrir la Sessi√≥ 2.</div>
      <div class="controls" style="margin-top:8px">
        <button id="s1check" class="primary">Comprova</button>
        <div id="s1fb"></div>
      </div>
      <div class="progress" style="margin-top:10px"><div id="s1bar"></div></div>
    `;

    let chain=0; let current={a:0,b:0,cols:0,inputs:[],root:null};

    function newOp(){ const d=+q('#s1level').value; const [a,b]=genPair(d); const r=renderOperation(q('#s1op'),a,b,true,true); current={a,b,cols:r.cols,inputs:r.inputs,root:r.root}; }

    function demo(){ if(!current.root) return; const cols=current.cols; const sa=String(current.a).padStart(cols,'0'); const sb=String(current.b).padStart(cols,'0');
      for(let i=cols-1;i>=0;i--){ if(+sa[i] < +sb[i]){ highlightColumn(current.root, i); const from=i-1; if(from>=0) animateBorrow(current.root, from, i); setTimeout(()=>highlightColumn(current.root,-1), 1200); break; } }
    }

    function check(){ if(!current.inputs.length) return; const ans=current.inputs.map(x=>x.value||'0').join(''); const tgt=String(current.a-current.b).padStart(current.cols,'0'); const ok=ans===tgt; const fb=q('#s1fb'); fb.innerHTML=`<span class="result ${ok?'ok':'no'}">${ok?'Molt b√©! ‚úÖ':'Ups‚Ä¶ torna-ho a provar ‚ùå'} <span class="mono">${current.a} ‚àí ${current.b} = ${current.a-current.b}</span></span>`; if(ok){ chain++; q('#s1bar').style.width = Math.min(chain,2)/2*100+"%"; if(chain>=2){ state.progress.s1=true; save(); renderSteps(); setTimeout(()=>openSession('s2'),600); } else { setTimeout(newOp,500);} } else { chain=0; q('#s1bar').style.width='0%'; }}

    q('#s1new').addEventListener('click', newOp);
    q('#s1level').addEventListener('change', newOp);
    q('#s1demo').addEventListener('click', demo);
    q('#s1check').addEventListener('click', check);
    view.addEventListener('keydown',(e)=>{ if(e.key==='Enter') check(); });
    newOp();
  }

  /* ===== SESSI√ì 2 ‚Äî Pas a pas ===== */
  function initS2(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>2) Fem-ho pas a pas</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Treballarem <b>columna per columna</b>: unitats ‚Üí desenes ‚Üí centenes. Escriu nom√©s el n√∫mero d'aquella columna.</div></div>
      <div style="height:12px"></div>
      <div class="controls">
        <label>Nivell
          <select id="s2level">
            <option value="2">2 xifres</option>
            <option value="3" selected>3 xifres</option>
            <option value="4">4 xifres</option>
          </select>
        </label>
        <button id="s2new" class="ghost">Nova operaci√≥</button>
      </div>
      <div id="s2op" style="margin:12px 0"></div>
      <div id="s2hint" class="note">Comencem per les <b>unitats</b> (dreta).</div>
      <div class="controls" style="margin-top:8px">
        <button id="s2next" class="primary">Comprova el pas</button>
        <div id="s2fb"></div>
      </div>
      <div class="progress" style="margin-top:10px"><div id="s2bar"></div></div>
    `;

    let done=0, stepIndex=0; let a=0,b=0, cols=0, inputs=[], root=null; let sa=[], sb=[];

    function newOp(){ const d=+q('#s2level').value; [a,b]=genPair(d); const r=renderOperation(q('#s2op'),a,b,true,true); cols=r.cols; inputs=r.inputs; root=r.root; sa=r.topDigits; sb=r.bottomDigits; stepIndex=cols-1; updateHint(); }

    function updateHint(){ const colName = stepIndex===cols-1? 'unitats' : stepIndex===cols-2? 'desenes' : stepIndex===cols-3? 'centenes' : 'columna'; const need = sa[stepIndex] < sb[stepIndex]; highlightColumn(root, stepIndex); if(need){ if(stepIndex-1>=0) animateBorrow(root, stepIndex-1, stepIndex); q('#s2hint').innerHTML = `A <b>${colName}</b> no pots: ${sa[stepIndex]} < ${sb[stepIndex]}. <b>Demana 1 desena</b> a l'esquerra i despr√©s resta.`; } else { q('#s2hint').innerHTML = `A <b>${colName}</b>, fes <b>${sa[stepIndex]} ‚àí ${sb[stepIndex]}</b> i escriu el d√≠git.`; } if(inputs[stepIndex]) inputs[stepIndex].focus(); }

    function checkStep(){ if(!inputs.length) return; const ansDigit = +(inputs[stepIndex].value||'0'); const targetDigit = +String(a-b).padStart(cols,'0')[stepIndex]; const ok = ansDigit===targetDigit; const fb=q('#s2fb'); fb.innerHTML = `<span class="result ${ok?'ok':'no'}">${ok?'Correcte ‚úÖ':'Oops‚Ä¶ ‚ùå'} <span class="mono">Esper√†vem: ${targetDigit}</span></span>`; if(ok){ stepIndex--; if(stepIndex<0){ done++; q('#s2bar').style.width = Math.min(done,3)/3*100+"%"; if(done>=3){ state.progress.s2=true; save(); renderSteps(); setTimeout(()=>openSession('s3'),650); } else { setTimeout(newOp,500);} } else { updateHint(); } } }

    q('#s2new').addEventListener('click', newOp);
    q('#s2level').addEventListener('change', newOp);
    q('#s2next').addEventListener('click', checkStep);
    view.addEventListener('keydown',(e)=>{ if(e.key==='Enter') checkStep(); });
    newOp();
  }

  /* ===== SESSI√ì 3 ‚Äî Cronometrada ===== */
  function initS3(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>3) Practiquem r√†pid</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Tens <b>90 segons</b>. Aconsegueix <b>5 encerts</b>. Millora la teva <b>marca</b> cada vegada!</div></div>
      <div style="height:12px"></div>
      <div class="controls">
        <label>Nivell
          <select id="s3level">
            <option value="2">2 xifres</option>
            <option value="3" selected>3 xifres</option>
            <option value="4">4 xifres</option>
          </select>
        </label>
        <button id="s3start" class="primary">Comen√ßa</button>
        <span class="pill">Temps: <b id="s3t">‚Äî</b></span>
        <span class="pill">Correctes: <b id="s3ok">0</b>/5</span>
        <span class="pill">Millor marca: <b id="s3best">${state.best3||0}</b></span>
      </div>
      <div id="s3op" style="margin:12px 0"></div>
      <div id="s3fb"></div>
    `;

    let target=5, ok=0, running=false, timer=null, left=90; let cur={a:0,b:0,cols:0,inputs:[]};
    function tick(){ left--; q('#s3t').textContent = left+'s'; if(left<=0){ stop(false); }}
    function start(){ if(timer) clearInterval(timer); ok=0; left=90; q('#s3ok').textContent='0'; q('#s3t').textContent=left+'s'; q('#s3fb').innerHTML=''; running=true; timer=setInterval(tick,1000); newOp(); }
    function stop(win){ if(!running && !timer) return; running=false; if(timer){ clearInterval(timer); timer=null; } if(!win){ q('#s3fb').innerHTML = `<span class="result no">Temps esgotat ‚è±Ô∏è <span class="mono">Intenta-ho de nou</span></span>`; } if(ok>state.best3){ state.best3=ok; save(); q('#s3best').textContent=ok; } if(win){ state.progress.s3=true; save(); renderSteps(); setTimeout(()=>openSession('s4'),650);} q('#s3t').textContent = win ? 'üéØ' : left<=0 ? '0s' : q('#s3t').textContent; }
    function newOp(){ const d=+q('#s3level').value; const [a,b]=genPair(d); const r=renderOperation(q('#s3op'),a,b,true,true); cur={a,b,cols:r.cols,inputs:r.inputs}; if(cur.inputs[0]) cur.inputs[0].focus(); }
    function check(){ if(!running) return; const ans=cur.inputs.map(x=>x.value||'0').join(''); const tgt=String(cur.a-cur.b).padStart(cur.cols,'0'); const okNow=ans===tgt; q('#s3fb').innerHTML=`<span class="result ${okNow?'ok':'no'}">${okNow?'Correcte ‚úÖ':'Incorrecte ‚ùå'} <span class="mono">${cur.a} ‚àí ${cur.b} = ${cur.a-cur.b}</span></span>`; if(okNow){ ok++; q('#s3ok').textContent=ok; if(ok>=target){ stop(true); } else { setTimeout(newOp,380); } } }

    q('#s3start').addEventListener('click', start);
    view.addEventListener('keydown', (e)=>{ if(e.key==='Enter') check(); });
  }

  /* ===== SESSI√ì 4 ‚Äî Prova final ===== */
  function initS4(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>4) Prova final</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Respon <b>10 preguntes</b>. Si arribes a <b>8</b>, <b>certificat superat</b>! üëè</div></div>
      <div style="height:12px"></div>
      <div class="controls">
        <label>Nivell
          <select id="s4level">
            <option value="2">2 xifres</option>
            <option value="3" selected>3 xifres</option>
            <option value="4">4 xifres</option>
          </select>
        </label>
        <button id="s4start" class="primary">Inicia la prova</button>
        <span class="pill">P: <b id="s4i">0</b>/10</span>
        <span class="pill">Encerts: <b id="s4ok">0</b></span>
      </div>
      <div id="s4host" style="margin:12px 0"></div>
      <div id="s4fb"></div>
    `;

    let i=0, ok=0, cur={a:0,b:0,cols:0,inputs:[]};
    function newQ(){ const d=+q('#s4level').value; const [a,b]=genPair(d); const r=renderOperation(q('#s4host'),a,b,true,true); cur={a,b,cols:r.cols,inputs:r.inputs}; if(cur.inputs[0]) cur.inputs[0].focus(); }
    function start(){ i=0; ok=0; q('#s4i').textContent='0'; q('#s4ok').textContent='0'; q('#s4fb').innerHTML=''; newQ(); }
    function check(){ if(!cur.inputs.length) return; const ans=cur.inputs.map(x=>x.value||'0').join(''); const tgt=String(cur.a-cur.b).padStart(cur.cols,'0'); const okNow=ans===tgt; if(okNow) ok++; i++; q('#s4i').textContent=i; q('#s4ok').textContent=ok; q('#s4fb').innerHTML=`<span class="result ${okNow?'ok':'no'}">${okNow?'Correcte ‚úÖ':'Incorrecte ‚ùå'} <span class="mono">${cur.a} ‚àí ${cur.b} = ${cur.a-cur.b}</span></span>`; if(i>=10){ const pass = ok>=8; if(pass){ state.progress.s4=true; save(); renderSteps(); q('#s4fb').insertAdjacentHTML('beforeend', ' <span class="pill" style="margin-left:8px">Completada üèÜ</span>'); } } else { setTimeout(newQ,380); }
    }

    q('#s4start').addEventListener('click', start);
    view.addEventListener('keydown', (e)=>{ if(e.key==='Enter') check(); });
  }

  // ===== Init =====
  document.addEventListener('DOMContentLoaded', ()=>{
    renderSteps();
    const nextSession = SESS.find((s,idx)=>!state.progress[s.id] && isUnlocked(idx)) || SESS.find((s,idx)=>isUnlocked(idx)) || SESS[0];
    openSession(nextSession.id);
    runSmokeTests();
  });

  // ===== Simple smoke tests (no canvien cap flux) =====
  function runSmokeTests(){
    const box = document.getElementById('tests');
    if(!box) return;
    try{
      // Test 1: sidebar render
      console.assert(document.querySelectorAll('#steps .step').length>=1,'[TEST] Steps renderitzats');
      // Test 2: primera sessi√≥ cont√© botons esperats
      openSession('s1');
      const hasBtn = !!document.querySelector('#screen #s1new');
      console.assert(hasBtn,'[TEST] s1new existeix al DOM');
      // Test 3: obrir sessi√≥ 2 no llen√ßa errors i te bot√≥
      openSession('s2');
      const hasS2 = !!document.querySelector('#screen #s2next');
      console.assert(hasS2,'[TEST] s2next existeix al DOM');
      box.className='pass';
      box.textContent='Tests b√†sics passats ‚úÖ';
      box.style.display='block';
    }catch(e){
      console.error('[TEST ERROR]', e);
      box.className='fail';
      box.textContent='Alguns tests han fallat ‚ùå (mira la consola)';
      box.style.display='block';
    }
  }
  </script>
</body>
</html>
