<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FocusQuiz ¬∑ C√†psula ¬∑ Resta portant</title>
  <meta name="description" content="C√†psula de resta portant per Prim√†ria: 4 sessions guiades, animacions de pr√©stec i exercicis autocorrectius. Sense √†udio." />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --brand:#38bdf8; --brand-2:#a7f3d0; --brand-3:#bfdbfe; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --radius:18px; --shadow:0 12px 32px rgba(15,23,42,.08), 0 6px 18px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:linear-gradient(180deg,#f8fafc,#eef2ff 320px); color:var(--ink)}
    a{text-decoration:none;color:inherit}

    .wrap{max-width:1180px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:20px}
    .left{display:flex;align-items:center;gap:12px}
    .logo{display:inline-grid;place-items:center;width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:var(--shadow);font-weight:900;color:#111}
    h1{font-size:clamp(1.3rem,1.15rem + 2vw,2.4rem);margin:0}
    .sub{color:var(--muted);max-width:640px}
    .pill{background:#e0f2fe;color:#0c4a6e;border-radius:999px;padding:9px 14px;font-size:.92rem;font-weight:700;display:inline-flex;align-items:center;gap:6px}
    .top-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .hero-card{background:linear-gradient(120deg,rgba(56,189,248,0.22),rgba(167,243,208,0.25));padding:18px 20px;border-radius:20px;border:1.5px dashed rgba(14,165,233,0.45);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px;margin-bottom:18px}
    .hero-card h2{margin:0;font-size:1.25rem}
    .hero-card p{margin:0;color:#0f172a;line-height:1.45}
    .hero-card ul{margin:0;padding-left:20px;color:#0f172a;line-height:1.45}

    .grid{display:grid;grid-template-columns:320px 1fr; gap:20px}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .inner{padding:20px}

    .steps{display:grid;gap:12px}
    .step{display:flex;gap:12px;align-items:center;border:2px solid var(--line);padding:14px;border-radius:18px;cursor:pointer;background:#fff;transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
    .step:hover{transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.06); border-color:#bae6fd}
    .step.locked{opacity:.55; cursor:not-allowed}
    .ico{width:40px;height:40px;border-radius:14px;display:grid;place-items:center;background:#f0f9ff;font-size:1.35rem}
    .step .meta{display:flex;flex-direction:column;line-height:1.1}
    .step .meta small{color:var(--muted)}
    .status{margin-left:auto;font-weight:800}
    .status.ok{color:var(--ok)}
    .status.do{color:#0f172a}

    .view{min-height:580px}
    .fade-enter{animation:fadeIn .32s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none}}

    .coach{display:flex;gap:12px;align-items:flex-start;background:#f0f9ff;border:2px solid var(--line);padding:14px;border-radius:18px;margin:12px 0}
    .coach .avatar{width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg,var(--brand-3),var(--brand));display:grid;place-items:center;font-weight:900;color:#0f172a;font-size:1.1rem}
    .coach .bubble{line-height:1.35;font-size:1.05rem}

    .note{padding:12px 14px;border-radius:16px;background:#fff7ed;border:2px solid #fed7aa;color:#7c2d12;font-size:1.02rem;margin:12px 0}
    .info{padding:12px 14px;border-radius:16px;background:#ecfeff;border:2px solid #bae6fd;color:#0f172a;font-size:1rem;margin:12px 0;line-height:1.5}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 14px}
    label>span{display:block;font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#0f172a;margin-bottom:4px}
    select,input,button{appearance:none;border:2px solid var(--line);background:#fff;border-radius:14px;padding:11px 14px;font-size:1.02rem;font-family:inherit}
    input[type=number]{width:120px}
    button{cursor:pointer;font-weight:700;box-shadow:var(--shadow);background:linear-gradient(135deg,#0284c7,#0ea5e9);color:#fff;border:none;transition:transform .18s ease, box-shadow .18s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 12px 28px rgba(2,132,199,0.25)}
    button.ghost{background:transparent;color:#0f172a;border:2px dashed var(--line);box-shadow:none}
    button.ok{background:linear-gradient(135deg,#10b981,#34d399);color:#034732}
    button.warn{background:linear-gradient(135deg,#f59e0b,#fcd34d);color:#7c2d12}
    button.small{padding:8px 12px;font-size:.9rem}

    .progress{height:12px;background:#e0f2fe;border-radius:999px;overflow:hidden}
    .progress > div{height:100%; background:linear-gradient(90deg,#0284c7,#22d3ee); width:0}

    .result{padding:10px 12px;border-radius:14px;font-weight:700;display:inline-flex;align-items:center;gap:8px;font-size:.98rem;margin-top:8px}
    .result.ok{background:#ecfdf5;color:#065f46}
    .result.no{background:#fef2f2;color:#7f1d1d}

    .op{position:relative; display:inline-grid; grid-template-columns:repeat(var(--cols,3), minmax(2ch, 2.6ch)); gap:.4ch; align-items:end; padding:14px; border-radius:16px; background:#f8fafc; border:2px solid var(--line)}
    .col{position:relative; text-align:center; min-width:2ch}
    .col .top,.col .bot{font-size:2rem; font-variant-numeric:tabular-nums}
    .col .borrow{position:absolute; top:-14px; left:50%; transform:translateX(-50%); font-size:1rem; color:#334155}
    .minus{grid-column:1/-1; border-top:3px solid #111; margin-top:5px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}

    input.dig{width:2.6ch;text-align:center;border:2px solid var(--line);border-radius:10px;padding:8px 0;font-size:1.2rem}

    .highlight{background:#fffbea; box-shadow:0 0 0 4px #fef3c7 inset; border-radius:8px}
    .ten-token{position:absolute; width:32px; height:32px; border-radius:999px; background:#a7f3d0; color:#065f46; display:grid; place-items:center; font-weight:900; box-shadow:var(--shadow); pointer-events:none}

    .progress-text{margin-top:8px;font-size:.9rem;color:#0f172a}

    #tests{font-size:.9rem;color:#0f172a;background:#ecfeff;border:1px solid #bae6fd;border-radius:12px;padding:8px 10px;display:none;margin-top:10px}
    #tests.pass{background:#ecfdf5;border-color:#a7f3d0}
    #tests.fail{background:#fef2f2;border-color:#fecaca}

    @media (max-width:720px){
      header{align-items:flex-start}
      .hero-card{margin-bottom:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="left">
        <div class="logo">FQ</div>
        <div>
          <h1>FocusQuiz ¬∑ C√†psules ‚Äî Resta portant</h1>
          <div class="sub">Apr√®n a demanar una desena i a repartir-la entre unitats, desenes i centenes. Completa les 4 sessions per dominar els pr√©stecs i guardar el progr√©s al teu dispositiu.</div>
        </div>
      </div>
      <div class="top-controls">
        <span class="pill">Progr√©s total: <b id="allPct">0%</b></span>
        <a class="pill" href="capsules.html">‚Üê Torna a l'Espai</a>
      </div>
    </header>

    <div class="hero-card">
      <h2>Itinerari de la c√†psula</h2>
      <p>Aquesta seq√º√®ncia combina teoria extensa amb pr√†ctica guiada. Comen√ßa visualitzant els pr√©stecs, continua amb una explicaci√≥ detallada columna a columna, posa't a prova amb un entrenament cronometrat i acaba amb una prova final.</p>
      <ul>
        <li>Recorda cada pas clau: comprovar si cal demanar, convertir una desena en 10 unitats i restar.</li>
        <li>Les teves respostes, encerts i temps queden guardats al navegador perqu√® puguis reprendre-ho quan vulguis.</li>
      </ul>
    </div>

    <section class="grid">
      <aside class="card" aria-label="Sessions">
        <div class="inner">
          <div class="steps" id="steps"></div>
          <div id="tests" aria-live="polite"></div>
        </div>
      </aside>

      <main class="card view" id="view">
        <div class="inner" id="screen"></div>
      </main>
    </section>
  </div>

  <script>
  const $ = (q,el=document)=>el.querySelector(q);
  const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
  const rng = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;

  const LS_KEY = 'fq_capsula_resta_portant_v4';
  const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  if(!state.progress){ state.progress = { s1:false, s2:false, s3:false, s4:false }; }
  if(typeof state.best3 !== 'number') state.best3 = 0;

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  const SESS = [
    { id:'s1', title:'1) Mira i ent√©n', sub:'Animaci√≥ de pr√©stecs', icon:'üé¨' },
    { id:'s2', title:'2) Pas a pas', sub:'Columna a columna', icon:'üßÆ' },
    { id:'s3', title:'3) Entrena el ritme', sub:'5 encerts en 90s', icon:'‚è±Ô∏è' },
    { id:'s4', title:'4) Prova final', sub:'10 restes amb portar', icon:'üéØ' },
  ];

  function percentAll(){ const v = Object.values(state.progress).filter(Boolean).length; return Math.round(v/4*100); }

  function renderSteps(){
    const box = $('#steps'); box.innerHTML='';
    SESS.forEach((s,idx)=>{
      const unlocked = idx===0 || Object.values(state.progress).slice(0,idx).every(Boolean);
      const done = !!state.progress[s.id];
      const el = document.createElement('div'); el.className = 'step' + (unlocked?'':' locked'); el.dataset.id = s.id;
      el.innerHTML = `<div class="ico">${s.icon}</div>
        <div class="meta"><b>${s.title}</b><small>${s.sub}</small></div>
        <div class="status ${done?'ok':'do'}">${done?'Fet ‚úÖ': (unlocked?'Inicia':'Blocat')}</div>`;
      if(unlocked){ el.addEventListener('click', ()=> openSession(s.id)); }
      box.appendChild(el);
    });
    $('#allPct').textContent = percentAll()+"%";
  }

  function openSession(id){
    const host = $('#screen');
    host.innerHTML='';
    const view = document.createElement('div');
    view.className='fade-enter';
    host.appendChild(view);
    if(id==='s1') initS1(view);
    else if(id==='s2') initS2(view);
    else if(id==='s3') initS3(view);
    else initS4(view);
    renderSteps();
  }

  function needsBorrow(a,b){
    const sa = String(a).padStart(Math.max(String(a).length,String(b).length),'0');
    const sb = String(b).padStart(sa.length,'0');
    for(let i=sa.length-1;i>=0;i--){ if(+sa[i] < +sb[i]) return true; }
    return false;
  }
  function genPair(d){ let a,b; const min=10**(d-1), max=10**d-1; do{ a=rng(min,max); b=rng(min,a-1);} while(!needsBorrow(a,b)); return [a,b]; }

  function renderOperation(container, a, b, withInputs=true, showSteps=false){
    container.innerHTML='';
    const cols = Math.max(String(a).length,String(b).length);
    const root = document.createElement('div'); root.className='op'; root.style.setProperty('--cols',cols); root.dataset.cols=String(cols);
    const sa = String(a).padStart(cols,'0'); const sb = String(b).padStart(cols,'0');

    let topDigits = sa.split('').map(Number);
    const bottomDigits = sb.split('').map(Number);
    const borrowMarks = new Array(cols).fill('');
    if(showSteps){
      for(let i=cols-1;i>=0;i--){ if(topDigits[i] < bottomDigits[i]){ let k=i-1; while(k>=0 && topDigits[k]===0) k--; if(k>=0){ topDigits[k]-=1; for(let j=k+1;j<i;j++) topDigits[j]+=9; topDigits[i]+=10; borrowMarks[i]='10'; } } }
    }

    for(let i=0;i<cols;i++){
      const c=document.createElement('div'); c.className='col';
      const sup=document.createElement('div'); sup.className='borrow'; sup.textContent=borrowMarks[i]||'';
      const t=document.createElement('div'); t.className='top'; t.textContent=sa[i];
      c.appendChild(sup); c.appendChild(t); root.appendChild(c);
    }
    for(let i=0;i<cols;i++){
      const c=document.createElement('div'); c.className='col';
      const t=document.createElement('div'); t.className='bot'; t.textContent=sb[i];
      c.appendChild(t); root.appendChild(c);
    }
    const line=document.createElement('div'); line.className='minus'; root.appendChild(line);

    const inputs=[]; if(withInputs){ for(let i=0;i<cols;i++){ const c=document.createElement('div'); c.className='col'; const inp=document.createElement('input'); inp.className='dig mono'; inp.maxLength=1; inp.inputMode='numeric'; inp.pattern='[0-9]'; c.appendChild(inp); root.appendChild(c); inputs.push(inp);} }
    container.appendChild(root);

    if(inputs.length){ inputs[0].focus(); inputs.forEach((el,idx)=>{
      el.addEventListener('input',()=>{ if(el.value.length===1 && idx<inputs.length-1) inputs[idx+1].focus(); });
      el.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft' && idx>0){inputs[idx-1].focus();e.preventDefault();} if(e.key==='ArrowRight' && idx<inputs.length-1){inputs[idx+1].focus();e.preventDefault();} });
    }); }

    return {cols,inputs,root};
  }

  function highlightColumn(opRoot, colIndex){
    const cols = Number(opRoot.dataset.cols||'0');
    if(!cols) return;
    $$('.col', opRoot).forEach((c,i)=> c.classList.toggle('highlight', Math.floor(i%cols)===colIndex));
  }

  function animateBorrow(opRoot, from, to){
    const ten=document.createElement('div'); ten.className='ten-token'; ten.textContent='10';
    const fromCol = $$('.col', opRoot)[from];
    const toCol = $$('.col', opRoot)[to];
    if(!fromCol || !toCol) return;
    const rectFrom = fromCol.getBoundingClientRect();
    const rectTo = toCol.getBoundingClientRect();
    const hostRect = opRoot.getBoundingClientRect();
    ten.style.left = rectFrom.left - hostRect.left + rectFrom.width/2 - 16 + 'px';
    ten.style.top = rectFrom.top - hostRect.top - 40 + 'px';
    opRoot.appendChild(ten);
    setTimeout(()=>{
      ten.style.transition='transform .6s ease, opacity .6s ease';
      const dx = (rectTo.left - rectFrom.left);
      const dy = (rectTo.top - rectFrom.top);
      ten.style.transform=`translate(${dx}px,${dy}px)`;
      ten.style.opacity='0';
      setTimeout(()=>ten.remove(),650);
    },30);
  }

  /* ===== S1 ===== */
  function initS1(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>1) Mira i ent√©n</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Si <b>no podem restar</b>, demanem <b>una desena</b> al ve√≠ de l'esquerra. Aquesta desena val <b>10</b> i ens permet completar la resta. Mira l'animaci√≥, llegeix el resum te√≤ric i despr√©s practica.</div></div>
      <div class="info">Teoria clau: <b>1 desena = 10 unitats</b>. Quan el d√≠git de dalt √©s m√©s petit que el de baix, demanem una desena i l'afegim (sumem 10) a la columna. El pr√©stec es registra amb un petit 10 i redu√Øm en una unitat el d√≠git de l'esquerra.</div>
      <div class="controls">
        <label><span>Nivell</span>
          <select id="s1level">
            <option value="2">2 xifres</option>
            <option value="3" selected>3 xifres</option>
            <option value="4">4 xifres</option>
          </select>
        </label>
        <button id="s1demo" class="ok">‚ñ∂Ô∏è Mostra animaci√≥</button>
        <button id="s1new" class="ghost">Nova operaci√≥</button>
      </div>
      <div id="s1op" style="margin:12px 0"></div>
      <div class="note"><b>Objectiu:</b> Aconsegueix <b>2 encerts seguits</b> per obrir la Sessi√≥ 2. La barra de progr√©s indica la teva ratxa d'encerts.</div>
      <div class="controls" style="margin-top:8px">
        <button id="s1check">Comprova</button>
        <div id="s1fb"></div>
      </div>
      <div class="progress"><div id="s1bar"></div></div>
    `;

    let chain=0; let current={a:0,b:0,cols:0,inputs:[],root:null};

    function newOp(){ const d=+q('#s1level').value; const [a,b]=genPair(d); const r=renderOperation(q('#s1op'),a,b,true,true); current={a,b,cols:r.cols,inputs:r.inputs,root:r.root}; q('#s1fb').innerHTML=''; }

    function demo(){ if(!current.root) return; const cols=current.cols; const sa=String(current.a).padStart(cols,'0'); const sb=String(current.b).padStart(cols,'0');
      for(let i=cols-1;i>=0;i--){ if(+sa[i] < +sb[i]){ highlightColumn(current.root, i); const from=i-1; if(from>=0) animateBorrow(current.root, from, i); break; } }
    }

    function check(){ if(!current.inputs.length) return; const ans=current.inputs.map(x=>x.value||'0').join(''); const tgt=String(current.a-current.b).padStart(current.cols,'0'); const ok=ans===tgt; const fb=q('#s1fb'); fb.innerHTML=`<span class="result ${ok?'ok':'no'}">${ok?'Molt b√©! ‚úÖ':'Ups‚Ä¶ torna-ho a provar ‚ùå'} <span class="mono">${current.a} ‚àí ${current.b} = ${current.a-current.b}</span></span>`; if(ok){ chain++; q('#s1bar').style.width = Math.min(chain,2)/2*100+"%"; if(chain>=2){ state.progress.s1=true; save(); renderSteps(); setTimeout(()=>openSession('s2'),600); } else { setTimeout(newOp,500);} } else { chain=0; q('#s1bar').style.width='0%'; }}

    q('#s1new').addEventListener('click', newOp);
    q('#s1level').addEventListener('change', newOp);
    q('#s1demo').addEventListener('click', demo);
    q('#s1check').addEventListener('click', check);
    view.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const active=document.activeElement; if(current.inputs.includes(active)) check(); }});
    newOp();
  }

  /* ===== S2 ===== */
  function initS2(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>2) Pas a pas</h2>
      <div class="coach"><div class="avatar">üßë‚Äçüè´</div><div class="bubble">Treballarem <b>columna per columna</b>: unitats ‚Üí desenes ‚Üí centenes‚Ä¶ Escriu nom√©s el n√∫mero de la columna indicada. Quan necessitem pr√©stec ho remarcarem amb animacions.</div></div>
      <div class="info">Procediment complet: compara, demana una desena si cal, suma-la (10) a la columna actual, resta i escriu el resultat. Anota el pr√©stec i continua amb la seg√ºent columna.</div>
      <div class="controls">
        <label><span>Nivell</span>
          <select id="s2level">
            <option value="2">2 xifres</option>
            <option value="3" selected>3 xifres</option>
            <option value="4">4 xifres</option>
          </select>
        </label>
        <button id="s2new" class="ghost">Nova operaci√≥</button>
      </div>
      <div id="s2op" style="margin:12px 0"></div>
      <div id="s2hint" class="note">Comencem per les <b>unitats</b> (dreta). Escriu el d√≠git que queda despr√©s de restar.</div>
      <div class="controls" style="margin-top:8px">
        <button id="s2next">Comprova el pas</button>
        <div id="s2fb"></div>
        <span class="pill small" id="s2step">Pas 1</span>
      </div>
      <div class="progress"><div id="s2bar"></div></div>
    `;

    let done=0, stepIndex=0; let a=0,b=0, cols=0, inputs=[], root=null; let sa=[], sb=[];

    function newOp(){ const d=+q('#s2level').value; [a,b]=genPair(d); const r=renderOperation(q('#s2op'),a,b,true,true); cols=r.cols; inputs=r.inputs; root=r.root; sa=String(a).padStart(cols,'0').split('').map(Number); sb=String(b).padStart(cols,'0').split('').map(Number); stepIndex=cols-1; q('#s2fb').innerHTML=''; q('#s2bar').style.width = Math.min(done,3)/3*100+"%"; updateHint(); }

    function columnName(idx){ const pos = cols-1-idx; return pos===0?'unitats':pos===1?'desenes':pos===2?'centenes':`columna ${pos+1}`; }

    function updateHint(){ const need = sa[stepIndex] < sb[stepIndex]; highlightColumn(root, stepIndex); if(need){ if(stepIndex-1>=0) animateBorrow(root, stepIndex-1, stepIndex); q('#s2hint').innerHTML = `A <b>${columnName(stepIndex)}</b> no podem: ${sa[stepIndex]} ‚àí ${sb[stepIndex]}. Demanem una desena a l'esquerra (afegim 10) i escrivim el resultat.`; } else { q('#s2hint').innerHTML = `A <b>${columnName(stepIndex)}</b>, fem ${sa[stepIndex]} ‚àí ${sb[stepIndex]} i escrivim el d√≠git.`; } q('#s2step').textContent = `Pas ${cols-stepIndex}`; }

    function checkStep(){ if(!inputs.length) return; const ansDigit = +(inputs[stepIndex].value||'0'); const targetDigit = +String(a-b).padStart(cols,'0')[stepIndex]; const ok = ansDigit===targetDigit; const fb=q('#s2fb'); fb.innerHTML = `<span class="result ${ok?'ok':'no'}">${ok?'Correcte ‚úÖ':'Oops‚Ä¶ ‚ùå'} <span class="mono">Esper√†vem: ${targetDigit}</span></span>`; if(ok){ stepIndex--; if(stepIndex<0){ done++; q('#s2bar').style.width = Math.min(done,3)/3*100+"%"; if(done>=3){ state.progress.s2=true; save(); renderSteps(); setTimeout(()=>openSession('s3'),650); } else { setTimeout(newOp,500);} } else { updateHint(); inputs[stepIndex].focus(); } } }

    q('#s2new').addEventListener('click', newOp);
    q('#s2level').addEventListener('change', ()=>{ done=0; q('#s2bar').style.width='0%'; newOp(); });
    q('#s2next').addEventListener('click', checkStep);
    view.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const active=document.activeElement; if(inputs.includes(active)) checkStep(); }});
    newOp();
  }

  /* ===== S3 ===== */
  function initS3(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>3) Entrena el ritme</h2>
      <div class="coach"><div class="avatar">üèÉ‚Äç‚ôÄÔ∏è</div><div class="bubble">Tens <b>90 segons</b>. Aconsegueix <b>5 encerts</b>. Millora la teva <b>marca personal</b> cada vegada i comprova com creix la teva agilitat fent pr√©stecs mentals.</div></div>
      <div class="controls">
        <label><span>Nivell</span>
          <select id="s3level">
            <option value="2">2 xifres</option>
            <option value="3" selected>3 xifres</option>
            <option value="4">4 xifres</option>
          </select>
        </label>
        <button id="s3start">Comen√ßa</button>
        <span class="pill">Temps: <b id="s3t">‚Äî</b></span>
        <span class="pill">Correctes: <b id="s3ok">0</b>/5</span>
        <span class="pill">Millor marca: <b id="s3best">${state.best3||0}</b></span>
      </div>
      <div id="s3op" style="margin:12px 0"></div>
      <div id="s3fb"></div>
    `;

    let target=5, ok=0, running=false, timer=null, left=90; let cur={a:0,b:0,cols:0,inputs:[],root:null};
    function tick(){ left--; q('#s3t').textContent = left+'s'; if(left<=0){ stop(false); }}
    function start(){ ok=0; left=90; q('#s3ok').textContent='0'; q('#s3t').textContent=left+'s'; running=true; timer=setInterval(tick,1000); newOp(); }
    function stop(win){ running=false; clearInterval(timer); if(win){ state.progress.s3=true; save(); renderSteps(); setTimeout(()=>openSession('s4'),650);} if(ok>state.best3){ state.best3=ok; save(); q('#s3best').textContent=ok; } }
    function newOp(){ const d=+q('#s3level').value; const [a,b]=genPair(d); const r=renderOperation(q('#s3op'),a,b,true,true); cur={a,b,cols:r.cols,inputs:r.inputs,root:r.root}; }
    function check(){ if(!running) return; const ans=cur.inputs.map(x=>x.value||'0').join(''); const tgt=String(cur.a-cur.b).padStart(cur.cols,'0'); const okNow=ans===tgt; q('#s3fb').innerHTML=`<span class="result ${okNow?'ok':'no'}">${okNow?'Correcte ‚úÖ':'Incorrecte ‚ùå'} <span class="mono">${cur.a} ‚àí ${cur.b} = ${cur.a-cur.b}</span></span>`; if(okNow){ ok++; q('#s3ok').textContent=ok; if(ok>=target){ stop(true); } else { setTimeout(newOp,380); } } }

    q('#s3start').addEventListener('click', ()=>{ if(running) return; start(); });
    view.addEventListener('keydown', (e)=>{ if(e.key==='Enter') check(); });
  }

  /* ===== S4 ===== */
  function initS4(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>4) Prova final</h2>
      <div class="coach"><div class="avatar">üéì</div><div class="bubble">Respon <b>10 preguntes</b>. Si arribes a <b>8</b>, <b>certificat superat</b>! Pots repetir la prova quan vulguis i comprovar com millores.</div></div>
      <div class="controls">
        <label><span>Nivell</span>
          <select id="s4level">
            <option value="2">2 xifres</option>
            <option value="3" selected>3 xifres</option>
            <option value="4">4 xifres</option>
          </select>
        </label>
        <button id="s4start">Inicia la prova</button>
        <span class="pill">P: <b id="s4i">0</b>/10</span>
        <span class="pill">Encerts: <b id="s4ok">0</b></span>
      </div>
      <div id="s4host" style="margin:12px 0"></div>
      <div id="s4fb"></div>
    `;

    let i=0, ok=0, cur={a:0,b:0,cols:0,inputs:[]};
    function newQ(){ const d=+q('#s4level').value; const [a,b]=genPair(d); const r=renderOperation(q('#s4host'),a,b,true,true); cur={a,b,cols:r.cols,inputs:r.inputs,root:r.root}; }
    function start(){ i=0; ok=0; q('#s4i').textContent='0'; q('#s4ok').textContent='0'; q('#s4fb').innerHTML=''; newQ(); }
    function check(){ if(!cur.inputs.length) return; const ans=cur.inputs.map(x=>x.value||'0').join(''); const tgt=String(cur.a-cur.b).padStart(cur.cols,'0'); const okNow=ans===tgt; if(okNow) ok++; i++; q('#s4i').textContent=i; q('#s4ok').textContent=ok; q('#s4fb').innerHTML=`<span class="result ${okNow?'ok':'no'}">${okNow?'Correcte ‚úÖ':'Incorrecte ‚ùå'} <span class="mono">${cur.a} ‚àí ${cur.b} = ${cur.a-cur.b}</span></span>`; if(i>=10){ const pass = ok>=8; if(pass){ state.progress.s4=true; save(); renderSteps(); q('#s4fb').insertAdjacentHTML('beforeend', ' <span class="pill small">Certificat aconseguit üèÜ</span>'); } q('#s4host').innerHTML=''; } else { setTimeout(newQ,380); } }

    q('#s4start').addEventListener('click', start);
    view.addEventListener('keydown', (e)=>{ if(e.key==='Enter') check(); });
  }

  function runSmokeTests(){
    const box = document.getElementById('tests');
    if(!box) return;
    try{
      console.assert(document.querySelectorAll('#steps .step').length===4,'[TEST] quatre sessions');
      openSession('s1');
      console.assert(document.querySelector('#screen #s1check'),'[TEST] bot√≥ s1check');
      openSession('s2');
      console.assert(document.querySelector('#screen #s2next'),'[TEST] bot√≥ s2next');
      box.className='pass';
      box.textContent='Tests b√†sics passats ‚úÖ';
      box.style.display='block';
    }catch(e){
      console.error('[TEST ERROR]', e);
      box.className='fail';
      box.textContent='Alguns tests han fallat ‚ùå (mira la consola)';
      box.style.display='block';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    renderSteps();
    const firstOpen = ['s1','s2','s3','s4'].find((id,idx)=> idx===0 || Object.values(state.progress).slice(0,idx).every(Boolean) );
    openSession(firstOpen||'s1');
    runSmokeTests();
  });
  </script>
</body>
</html>
