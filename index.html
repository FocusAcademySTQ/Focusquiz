<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Focus Academy ¬∑ Matem√†tiques</title>
</header>
  <meta name="description" content="Pr√†ctiques de matem√†tiques tipus ThatQuiz per a estudiants. Single-file, sense depend√®ncies." />
  <style>
    :root{
      /* Paleta pastel Material-lite */
      --bg: #f7f7fb;
      --card: #ffffff;
      --ink: #1b1e28;
      --muted: #6b7280;
      --primary: #7aa2ff;   /* blau pastel */
      --secondary: #a7f3d0; /* menta suau */
      --ok: #86efac;
      --bad: #fca5a5;
      --warn: #fde68a;
      --radius: 18px;
      --shadow: 0 8px 22px rgba(27,30,40,.08);
      --hair: #e5e7eb;
      --focus: 0 0 0 3px rgba(122,162,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: linear-gradient(180deg, var(--bg), #eef2ff 280px);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(1.2) blur(10px);
      background:rgba(255,255,255,.7);
      border-bottom:1px solid var(--hair);
    }
    .wrap{max-width:1100px; margin:0 auto; padding: clamp(14px, 2vw, 24px);}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:38px;height:38px; display:grid; place-items:center; border-radius:12px;
      background:linear-gradient(135deg, var(--primary), #c7d2fe);
      box-shadow: var(--shadow); color:#0f172a; font-weight:900
    }
    .brand h1{font-size:1.1rem; margin:0; letter-spacing:.2px}
    nav{display:flex; gap:8px; flex-wrap:wrap}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .pill{
      border:1px solid var(--hair); color:var(--ink); background:#ffffffcc;
      padding:10px 14px; border-radius:999px; cursor:pointer; transition:.2s ease; font-weight:700; font-size:.92rem
    }
    .pill:hover{transform:translateY(-1px); background:#fff}
    .right{display:flex; align-items:center; gap:10px}
    .input, select{
      background:#f3f4f6; border:1px solid var(--hair); color:var(--ink);
      border-radius:12px; padding:10px 12px; outline:none; font-size:.95rem
    }
    .input:focus, select:focus{box-shadow:var(--focus); border-color:transparent}

    main{padding: 28px 0 60px}
    .hero{display:grid; grid-template-columns: 1fr; gap:20px}
    .panel{background: var(--card); border:1px solid var(--hair); border-radius: var(--radius); box-shadow: var(--shadow)}
    .card{padding: clamp(16px, 2.2vw, 26px)}
    .title{font-size: clamp(1.3rem, 2.6vw, 2rem); margin:0 0 10px}
    .subtitle{color:var(--muted); margin:0 0 18px}
    .grid{display:grid; grid-template-columns: repeat(4, 1fr); gap:14px}
    @media (max-width: 1000px){ .grid{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width: 560px){ .grid{grid-template-columns: 1fr} }

    .option{
      position:relative; overflow:hidden; padding:16px; border-radius:16px; cursor:pointer; border:1px solid var(--hair); transition:.2s;
      background:linear-gradient(180deg, #f9fafb, #f3f4f6);
    }
    .option:hover{transform: translateY(-2px); border-color: #cbd5e1; background:#fff}
    .option h3{margin:8px 0 6px; font-size:1rem}
    .option p{margin:0; color:var(--muted); font-size:.9rem}
    .badge{
      font-size:.75rem; color:#0f172a; font-weight:800; letter-spacing:.3px;
      background:linear-gradient(135deg, var(--primary), #c7d2fe); padding:6px 10px; border-radius:999px; display:inline-block
    }

    .section-title{margin: 18px 0 8px; font-size:1rem; color:var(--muted); letter-spacing:.3px}

    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .controls .field{display:flex; align-items:center; gap:8px}
    .controls .group{display:flex; gap:8px; flex-wrap:wrap}
    .toggle{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--hair); border-radius:12px; background:#fff}
    .check{width:18px; height:18px}

    button{
      background:linear-gradient(135deg, var(--primary), #a5b4fc); color:#0f172a; border:0; padding:12px 14px; border-radius:14px; font-weight:800; cursor:pointer; box-shadow: var(--shadow); transition:.18s
    }
    button:hover{transform: translateY(-1px)}
    .btn-secondary{background:#eef2ff; border:1px solid var(--hair); color:var(--ink); font-weight:800}
    .btn-ghost{background: transparent; border:1px dashed var(--hair); color:var(--muted); font-weight:700}

    .hidden{display:none}

    /* Quiz */
    .quiz{display:grid; grid-template-columns: 1.1fr .9fr; gap:18px}
    @media (max-width: 1000px){ .quiz{grid-template-columns: 1fr} }
    .q-header{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .progress{height: 10px; background: #e5e7eb; border-radius:999px; overflow:hidden}
    .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--primary), #93c5fd)}

    .q{display:grid; gap:14px}
    .q h2{font-size: clamp(1.4rem, 2.8vw, 2.2rem); margin:8px 0}
    .q .meta{color:var(--muted); font-size:.95rem}
    .answer-row{display:flex; gap:10px; align-items:center}
    .answer{flex:1; font-size:1.2rem}

    .kbd{
      display:inline-grid; place-items:center; min-width:46px; height:46px; border-radius:12px;
      background:#f3f4f6; border:1px solid var(--hair); font-weight:800; color:var(--ink)
    }

    .board{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    .board button{height:50px}

    .feedback{padding:12px; border-radius:12px; background: #ecfdf5; border:1px solid #bbf7d0; color:#065f46}
    .feedback.bad{background: #fff1f2; border-color: #fecaca; color:#7f1d1d}

    .timer{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" on; font-size:1.2rem}
    .chip{border:1px solid var(--hair); color:var(--muted); padding:6px 10px; border-radius:999px; background:#fff}

    /* Results */
    table{width:100%; border-collapse:collapse}
    th, td{padding:10px 12px; border-bottom:1px solid var(--hair); text-align:left}
    th{color:var(--muted); font-weight:800}
    tr:hover td{background: #f9fafb}
    .tbl-actions{display:flex; gap:8px}

    footer{opacity:.9; font-size:.9rem; padding:40px 0 60px; color:var(--muted)}
    .link{color:#6366f1; text-decoration:none}

    .pulse{animation:pulse 1.6s infinite}
    @keyframes pulse{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(10,13,24,.25); backdrop-filter: blur(6px); display:grid; place-items:center; z-index:50}
    .modal-inner{width:min(92vw, 820px)}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="brand">
        <div class="logo" aria-hidden="true">Q</div>
        <h1>Focus Academy ¬∑ Matem√†tiques</h1>
      </div>
      <nav class="right">
        <button class="pill" onclick="showView('home')">Inici</button>
        <button class="pill" onclick="showView('results')">Resultats</button>
        <button class="pill" onclick="showView('about')">Sobre</button>
        <input id="studentName" class="input" placeholder="Nom de l'alumne/a" />
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="view-home" class="hero">
      <div class="panel card">
        <h2 class="title">Benvingut/da! üëã</h2>
        <p class="subtitle">Tria un m√≤dul per configurar-lo i comen√ßar. Tot queda guardat en aquest dispositiu (sense comptes).</p>

        <div class="section-title">M√≤duls de matem√†tiques</div>
        <div class="grid" id="moduleGrid"></div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="view-config" class="hidden">
      <div class="panel card">
        <div class="row" style="align-items:center">
          <div>
            <h2 class="title" id="cfg-title" style="margin:0">Configura el m√≤dul</h2>
            <p class="subtitle" id="cfg-desc"></p>
          </div>
          <div class="controls">
            <button class="btn-secondary" onclick="showView('home')">‚Üê Torna</button>
            <button onclick="startFromConfig()">Comen√ßa</button>
          </div>
        </div>

        <div class="section-title">Opcions comunes</div>
        <div class="controls">
          <label class="field chip">Preguntes
            <select id="cfg-count">
              <option>10</option><option>20</option><option>30</option><option>50</option>
            </select>
          </label>
          <label class="field chip">Temps (min)
            <select id="cfg-time">
              <option value="0">Sense l√≠mit</option><option>5</option><option>10</option><option>15</option><option>20</option>
            </select>
          </label>
          <label class="field chip">Nivell (1‚Äì20)
            <select id="cfg-level"></select>
          </label>
        </div>

        <div id="cfg-specific"></div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="view-quiz" class="hidden">
      <div class="quiz">
        <div class="panel card">
          <div class="q-header">
            <div style="display:flex; align-items:center; gap:10px">
              <span id="qModule" class="badge">M√≤dul</span>
              <span id="qLevel" class="chip">Nivell 1</span>
              <span id="timer" class="chip timer">--:--</span>
            </div>
            <div class="progress" style="flex:1"><i id="bar"></i></div>
          </div>

          <div class="q">
            <div class="meta" id="qMeta">Pregunta 1 de 10</div>
            <h2 id="qText">‚Äî</h2>
            <div class="answer-row">
              <input id="answer" class="input answer" placeholder="Resposta" inputmode="decimal" />
              <button id="btnCheck">Comprova (‚Üµ)</button>
              <button class="btn-secondary" id="btnSkip">Omet (‚Üí)</button>
            </div>
            <div id="feedback"></div>
          </div>
        </div>

        <div class="panel card">
          <h3 class="title" style="margin-top:0">Teclat num√®ric</h3>
          <div class="board">
            <button onclick="typeKey('7')">7</button>
            <button onclick="typeKey('8')">8</button>
            <button onclick="typeKey('9')">9</button>
            <button onclick="typeKey('4')">4</button>
            <button onclick="typeKey('5')">5</button>
            <button onclick="typeKey('6')">6</button>
            <button onclick="typeKey('1')">1</button>
            <button onclick="typeKey('2')">2</button>
            <button onclick="typeKey('3')">3</button>
            <button onclick="typeKey('0')">0</button>
            <button onclick="typeKey('-')">¬±</button>
            <button onclick="typeKey('del')">‚å´</button>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center">
            <span class="kbd">‚Üµ</span> <span class="subtitle">comprova</span>
            <span class="kbd">‚Üí</span> <span class="subtitle">omet</span>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="view-results" class="hidden">
      <div class="panel card">
        <div class="row">
          <h3 class="title" style="margin:0">Resultats guardats</h3>
          <div class="tbl-actions">
            <button class="btn-secondary" onclick="exportCSV()">Exporta CSV</button>
            <button class="btn-ghost" onclick="clearResults()">Neteja</button>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
          <label class="chip">Filtra m√≤dul: <select id="filter-module"></select></label>
          <label class="chip">Alumne/a: <input id="filter-student" class="input" placeholder="Tots" style="width:160px"></label>
        </div>
        <div id="resultsTable">No hi ha dades encara.</div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="view-about" class="hidden">
      <div class="panel card">
        <h3 class="title" style="margin-top:0">Sobre aquesta eina</h3>
        <p class="subtitle">Web single-file creada per Focus Academy. Inspirada en ThatQuiz, sense comptes ni depend√®ncies. Dades locals al navegador.</p>
        <ul>
          <li>Generador de preguntes per: Aritm√®tica, Fraccions, Percentatges i Equacions lineals.</li>
          <li>Temps opcional, nivell 1‚Äì20, negatius i resum d'errors amb correcci√≥.</li>
          <li>Historial exportable a CSV i mode offline (funciona sense internet).</li>
        </ul>
        <p class="subtitle">Suggeriments? Envia'ns millores i crearem m√©s m√≤duls (pot√®ncies, arrels, √†rees...).</p>
      </div>
    </section>

    <footer class="wrap">
      Fet amb ‚ù§Ô∏è per Focus Academy ¬∑ ¬© <span id="year"></span>
    </footer>
  </main>

  <script>
    /* ===================== UTILS ===================== */
    function showModal(contentHTML){
      closeModal();
      const overlay = document.createElement('div');
      overlay.className = 'modal';
      overlay.innerHTML = `<div class="modal-inner panel card">${contentHTML}</div>`;
      document.body.appendChild(overlay);
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });
    }
    function closeModal(){ const m = document.querySelector('.modal'); if(m) m.remove(); }

    const $ = (q) => document.querySelector(q);
    const $$ = (q) => Array.from(document.querySelectorAll(q));
    const rng = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
    const choice = (arr)=> arr[Math.floor(Math.random()*arr.length)];
    const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));

    const gcd = (a,b)=>{ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b] } return a||1 };
    const simplifyFrac = (n,d)=>{ const g=gcd(n,d); return [n/g, d/g] };

    const store = {
      get k(){ return 'focus-math-results-v1' },
      all(){ try{ return JSON.parse(localStorage.getItem(this.k)||'[]') }catch{ return [] } },
      save(entry){ const all=this.all(); all.push(entry); localStorage.setItem(this.k, JSON.stringify(all)) },
      clear(){ localStorage.removeItem(this.k) }
    };

    const fmtTime = (sec)=>{
      const m = Math.floor(sec/60), s = sec%60; return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`
    }

    /* ===================== APP STATE ===================== */
    const MODULES = [
      { id:'arith', name:'Aritm√®tica', desc:'Sumes, restes, multiplicacions i divisions.', badge:'B√†sic', gen: genArith },
      { id:'frac', name:'Fraccions', desc:'Simplifica i compara fraccions.', badge:'Nou', gen: genFractions },
      { id:'perc', name:'Percentatges', desc:'Calcula percentatges i descomptes.', badge:'Pr√†ctic', gen: genPercent },
      { id:'eq1', name:'Equacions lineals', desc:'Resol ax + b = c.', badge:'√Älgebra', gen: genEq1 },
    ];

    let pendingModule = null; // m√≤dul seleccionat per configurar
    const DEFAULTS = { count: 10, time: 0, level: 1 };
    let session = null;
    let timerHandle = null;

    /* ===================== VIEWS ===================== */
    function showView(name){
      ['home','config','quiz','results','about'].forEach(v=> $('#view-'+v).classList.toggle('hidden', v!==name));
      if(name==='results') renderResults();
    }

    function buildHome(){
      const grid = $('#moduleGrid'); grid.innerHTML='';
      MODULES.forEach(m=>{
        const el = document.createElement('div');
        el.className='option';
        el.innerHTML = `
          <span class="badge">${m.badge}</span>
          <h3>${m.name}</h3>
          <p>${m.desc}</p>`;
        el.onclick = ()=> openConfig(m.id);
        grid.appendChild(el);
      });

      // filtre resultats
      const fm = $('#filter-module');
      fm.innerHTML = `<option value="">Tots</option>` + MODULES.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');

      // nivells 1..20
      const sl = $('#cfg-level');
      sl.innerHTML = Array.from({length:20},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
      sl.value = DEFAULTS.level;
    }

    function openConfig(moduleId){
      pendingModule = MODULES.find(m=>m.id===moduleId) || MODULES[0];
      $('#cfg-title').textContent = `Configura: ${pendingModule.name}`;
      $('#cfg-desc').textContent = pendingModule.desc;

      // valors per defecte comuns
      $('#cfg-count').value = DEFAULTS.count;
      $('#cfg-time').value = DEFAULTS.time;
      $('#cfg-level').value = DEFAULTS.level;

      // Opcions espec√≠fiques
      const box = document.createElement('div');
      box.className = 'card';
      const wrap = document.createElement('div');

      if(pendingModule.id === 'arith'){
        wrap.innerHTML = `
          <div class="section-title">Opcions d'aritm√®tica</div>
          <div class="controls">
            <div class="group" role="group" aria-label="Operacions">
              <label class="toggle"><input class="check" type="checkbox" id="op-plus" checked> Sumes</label>
              <label class="toggle"><input class="check" type="checkbox" id="op-minus" checked> Restes</label>
              <label class="toggle"><input class="check" type="checkbox" id="op-times" checked> Multiplicacions</label>
              <label class="toggle"><input class="check" type="checkbox" id="op-div" checked> Divisions</label>
            </div>
          </div>
          <div class="controls">
            <label class="toggle"><input class="check" type="checkbox" id="allow-neg"> Permetre negatius</label>
            <label class="toggle"><input class="check" type="checkbox" id="tri-numbers"> Operar amb 3 n√∫meros</label>
          </div>
        `;
      } else {
        wrap.innerHTML = `<div class="section-title">Opcions espec√≠fiques</div>
          <p class="subtitle">Aquest m√≤dul no t√© opcions espec√≠fiques addicionals (de moment).</p>`;
      }

      box.appendChild(wrap);
      const holder = $('#cfg-specific');
      holder.innerHTML = '';
      holder.appendChild(box);

      showView('config');
    }

    function startFromConfig(){
      if(!pendingModule) return;
      const count = parseInt($('#cfg-count').value||DEFAULTS.count);
      const time = parseInt($('#cfg-time').value||0);
      const level = parseInt($('#cfg-level').value||1);

      const options = {};
      if(pendingModule.id==='arith'){
        const ops = [];
        if($('#op-plus').checked) ops.push('+');
        if($('#op-minus').checked) ops.push('-');
        if($('#op-times').checked) ops.push('√ó');
        if($('#op-div').checked) ops.push('√∑');
        if(!ops.length){ alert('Selecciona almenys una operaci√≥.'); return; }
        options.ops = ops;
        options.allowNeg = !!$('#allow-neg').checked;
        options.tri = !!$('#tri-numbers').checked;
      }

      startQuiz(pendingModule.id, {count, time, level, options});
    }

    /* ===================== QUIZ ENGINE ===================== */
    function startQuiz(moduleId, cfg){
      const module = MODULES.find(m=>m.id===moduleId) || MODULES[0];
      const count = clamp(parseInt(cfg.count)||10, 1, 200);
      const time = clamp(parseInt(cfg.time)||0, 0, 180);
      const level = clamp(parseInt(cfg.level)||1, 1, 20);

      session = {
        module: moduleId,
        count, time, level,
        idx: 0,
        correct: 0,
        wrongs: [],
        startedAt: Date.now(),
        secondsLeft: time>0 ? time*60 : 0,
        questions: [],
        options: cfg.options || {}
      };

      for(let i=0;i<count;i++) session.questions.push(module.gen(level, session.options));

      // UI
      $('#qModule').textContent = module.name;
      $('#qLevel').textContent = `Nivell ${level}`;
      $('#feedback').innerHTML='';
      $('#answer').value='';
      updateProgress();
      showView('quiz');
      renderQuestion();
      stopTimer();
      if(time>0) startTimer(); else $('#timer').textContent='Sense l√≠mit';
      $('#answer').focus();
    }

    function renderQuestion(){
      const q = session.questions[session.idx];
      $('#qMeta').textContent = `Pregunta ${session.idx+1} de ${session.count}`;
      $('#qText').textContent = q.text;
      $('#answer').value='';
      $('#feedback').innerHTML='';
    }

    function updateProgress(){
      const pct = (session.idx / session.count) * 100;
      $('#bar').style.width = pct + '%';
    }

    function startTimer(){
      $('#timer').textContent = fmtTime(session.secondsLeft);
      timerHandle = setInterval(()=>{
        session.secondsLeft--;
        $('#timer').textContent = fmtTime(Math.max(0, session.secondsLeft));
        if(session.secondsLeft<=0){
          stopTimer();
          finishQuiz(true);
        }
      }, 1000);
    }
    function stopTimer(){ if(timerHandle) clearInterval(timerHandle); timerHandle=null; }

    function checkAnswer(){
      if(!session || session.done){ flashFeedback('Prova finalitzada. Torna a Inici.'); return }
      const q = session.questions[session.idx];
      const raw = $('#answer').value.trim().replace(',', '.');
      if(raw==='') { flashFeedback('Escriu una resposta o prem Omet.', 'warn'); return; }

      let ok = false; let user;
      if(typeof q.answer === 'number'){
        user = Number(raw);
        ok = Math.abs(user - q.answer) < 1e-9;
      } else {
        user = raw;
        ok = (user === q.answer);
      }

      if(ok){
        session.correct++;
        feedback(true, `Correcte!`);
      }else{
        session.wrongs.push({ ...q, user: raw });
        feedback(false, `Incorrecte. Resposta correcta: <b>${fmtAns(q.answer)}</b>`);
      }

      session.idx++;
      updateProgress();
      if(session.idx>=session.count){ finishQuiz(false) }
      else renderQuestion();
    }

    function skip(){
      if(!session || session.done){ flashFeedback('Prova finalitzada. Torna a Inici.'); return }
      const q = session.questions[session.idx];
      session.wrongs.push({ ...q, user: '‚Äî (omet)' });
      session.idx++;
      updateProgress();
      if(session.idx>=session.count){ finishQuiz(false) }
      else renderQuestion();
    }

    function feedback(isOk, msg){
      $('#feedback').innerHTML = `<div class="feedback ${isOk? '':'bad'}">${msg}</div>`;
    }
    function flashFeedback(msg, type='warn'){
      const color = type==='warn'? 'var(--warn)':'#fecaca';
      const bg = type==='warn'? '#fffbeb':'#fff1f2';
      $('#feedback').innerHTML = `<div class="feedback" style="background:${bg};border-color:${color};color:#78350f">${msg}</div>`
    }
    function fmtAns(a){ return typeof a==='number' ? (Number.isInteger(a)? a : a.toFixed(3)) : a }

    function finishQuiz(timeUp){
      stopTimer();
      const elapsed = Math.floor((Date.now() - session.startedAt)/1000);
      const score = Math.round((session.correct / session.count) * 100);
      const name = ($('#studentName').value||'An√≤nim').trim();

      store.save({
        at: new Date().toISOString(),
        name,
        module: session.module,
        level: session.level,
        count: session.count,
        correct: session.correct,
        time_limit: session.time,
        time_spent: elapsed,
        score,
        wrongs: session.wrongs
      });

      session.done = true;

      const html = `
        <h3 style="margin-top:0">${timeUp? 'Temps exhaurit ‚è±Ô∏è':'Prova finalitzada üéâ'}</h3>
        <p class="subtitle">${name} ¬∑ ${MODULES.find(m=>m.id===session.module).name} ¬∑ Nivell ${session.level}</p>
        <div class="row" style="align-items:flex-end">
          <div>
            <div class="section-title">Resultat</div>
            <div style="font-size:2.2rem; font-weight:900">${score}%</div>
            <div class="subtitle">${session.correct}/${session.count} correctes ¬∑ Temps: ${fmtTime(elapsed)}</div>
            <div class="controls" style="margin-top:10px">
              <button onclick="openConfig('${session.module}')">Configura i torna-ho a fer</button>
              <button class="btn-secondary" onclick="showView('results')">Veure resultats</button>
              <button class="btn-ghost" onclick="closeModal()">Tanca</button>
            </div>
          </div>
          <div style="flex:1"></div>
        </div>
        <div class="section-title">Errors i correccions</div>
        ${session.wrongs.length? renderWrongs(session.wrongs): '<div class="chip">Cap error üéØ</div>'}
      `;
      showModal(html);
    }

    function renderWrongs(wr){
      return `<table><thead><tr><th>#</th><th>Pregunta</th><th>La teva</th><th>Correcta</th></tr></thead><tbody>`+
        wr.map((w,i)=>`<tr><td>${i+1}</td><td>${w.text}</td><td>${w.user}</td><td>${fmtAns(w.answer)}</td></tr>`).join('')+
        `</tbody></table>`
    }

    /* ===================== GENERADORS ===================== */
    // Helper: mapeig de nivell (1‚Äì20) a rangs aritm√®tics
    function levelRange(level){
      const t = clamp(level,1,20);
      // creix gradualment fins a ~200
      const max = Math.round(10 + t*9.5); // nivell 1‚âà20, nivell 20‚âà200
      return [-Math.floor(max/3), max]; // si hi ha negatius activats, es far√† servir el m√≠nim
    }

    function genArith(level, opts={}){
      const allowNeg = !!opts.allowNeg;
      const tri = !!opts.tri;
      const ops = (opts.ops && opts.ops.length)? opts.ops : ['+','-','√ó','√∑'];

      const [mn, mx] = levelRange(level);
      const low = allowNeg ? mn : 0;
      const a = rng(low, mx), b = rng(low, mx);
      const op = choice(ops);

      function makeDivisible(xmin, xmax){
        let y = rng(1, 12);
        let x = rng(xmin, xmax);
        x = Math.abs(x);
        const prod = y * rng(1, 12);
        return [prod, y]; // prod √∑ y = enter
      }

      let text, ans;

      if(tri){
        // a op b op c
        let c = rng(low, mx);
        let expOp1 = op;
        let expOp2 = choice(ops);
        let x=a, y=b, z=c;

        // ajusta si hi ha divisions perqu√® siguin netes
        if(expOp1==='√∑'){ [x,y] = makeDivisible(low, mx); }
        if(expOp2==='√∑'){ [y,z] = makeDivisible(low, mx); }

        text = `${x} ${expOp1} ${y} ${expOp2} ${z} = ?`;
        ans = evalArith(x, expOp1, y);
        ans = evalArith(ans, expOp2, z);
      } else {
        let x=a, y=b, expOp = op;
        if(expOp==='√∑'){ [x,y] = makeDivisible(low, mx); }
        text = `${x} ${expOp} ${y} = ?`;
        ans = evalArith(x, expOp, y);
      }

      return { type:'arith', text, answer: ans };
    }

    function evalArith(x, op, y){
      switch(op){
        case '+': return x + y;
        case '-': return x - y;
        case '√ó': return x * y;
        case '√∑': return x / y;
      }
      return NaN;
    }

    function genFractions(level){
      // Mant√© estructura simple; el nivell es podria usar per ampliar magnituds
      const mode = Math.random()<.5? 'simplify':'compare';
      if(mode==='simplify'){
        let n=rng(2,40), d=rng(2,40); if(n===d) d++;
        const [sn,sd]=simplifyFrac(n,d);
        return { type:'frac-simplify', text:`Simplifica: ${n}/${d}`, answer:`${sn}/${sd}` };
      } else {
        let a=rng(1,15), b=rng(2,16), c=rng(1,15), d=rng(2,16);
        const lhs = a*d, rhs = c*b; let sign = '=';
        if(lhs>rhs) sign='>'; else if(lhs<rhs) sign='<';
        return { type:'frac-compare', text:`Compara: ${a}/${b} ? ${c}/${d} (respon <, > o =)`, answer: sign };
      }
    }

    function genPercent(level){
      const mode = Math.random()<.33? 'of' : (Math.random()<.5? 'is-of' : 'discount');
      if(mode==='of'){
        const p = [5,10,12.5,15,20,25,30,40,50,60,75][rng(0,10)];
        const n = rng(20, 800);
        const ans = +(n * p / 100).toFixed(2);
        return { type:'percent-of', text:`${p}% de ${n} = ?`, answer: ans };
      } else if(mode==='is-of'){
        const p = [10,12.5,20,25,33.33,40,50,66.67,75,80][rng(0,9)];
        const part = rng(10,600);
        const whole = +(part * 100 / p).toFixed(2);
        return { type:'percent-is-of', text:`${part} √©s el ${p}% de ?`, answer: whole };
      } else {
        const n = rng(20, 900);
        const off = [5,10,12,15,20,25,30,40][rng(0,7)];
        const ans = +(n * (1 - off/100)).toFixed(2);
        return { type:'percent-discount', text:`Descompte del ${off}% sobre ${n} ‚Üí preu final = ?`, answer: ans };
      }
    }

    function genEq1(level){
      const a = rng(1, 12) * (Math.random()<.25? -1: 1);
      const x = rng(-15, 15);
      const b = rng(-20, 20);
      const c = a*x + b;
      const text = `${a}¬∑x ${b>=0?'+':'‚àí'} ${Math.abs(b)} = ${c}. Troba x`;
      return { type:'eq1', text, answer: x };
    }

    /* ===================== RESULTS ===================== */
    function renderResults(){
      const data = store.all();
      const modFilter = $('#filter-module').value || '';
      const nameFilter = ($('#filter-student').value||'').toLowerCase();
      const filtered = data.filter(r=>
        (!modFilter || r.module===modFilter) && (!nameFilter || (r.name||'').toLowerCase().includes(nameFilter))
      );

      if(!filtered.length){ $('#resultsTable').innerHTML = '<div class="chip">No hi ha dades.</div>'; return }

      const rows = filtered.map((r,i)=>{
        const m = MODULES.find(m=>m.id===r.module)?.name || r.module;
        const d = new Date(r.at);
        return `<tr>
          <td>${i+1}</td>
          <td>${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
          <td>${r.name}</td>
          <td>${m}</td>
          <td>Nivell ${r.level}</td>
          <td>${r.correct}/${r.count}</td>
          <td>${r.score}%</td>
          <td>${fmtTime(r.time_spent)}</td>
        </tr>`
      }).join('');

      $('#resultsTable').innerHTML = `
        <table>
          <thead>
            <tr><th>#</th><th>Data</th><th>Alumne/a</th><th>M√≤dul</th><th>Nivell</th><th>Encerts</th><th>Puntuaci√≥</th><th>Temps</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function exportCSV(){
      const data = store.all();
      if(!data.length){ alert('No hi ha dades per exportar.'); return }
      const header = ['data','alumne','modul','nivell','preguntes','correctes','puntuacio','temps_limit','temps_consumit'];
      const lines = [header.join(',')];
      data.forEach(r=>{
        lines.push([
          r.at, r.name, r.module, r.level, r.count, r.correct, r.score, r.time_limit, r.time_spent
        ].join(','))
      })
      const blob = new Blob([lines.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='focus-academy-math-results.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function clearResults(){
      if(confirm('Segur que vols esborrar tots els resultats d\'aquest dispositiu?')){
        store.clear(); renderResults();
      }
    }

    /* ===================== INPUT ===================== */
    function typeKey(k){
      const inp = $('#answer');
      if(k==='del') inp.value = inp.value.slice(0,-1);
      else if(k==='-'){
        if(inp.value.startsWith('-')) inp.value = inp.value.slice(1); else inp.value = '-' + inp.value;
      } else inp.value += k;
      inp.focus();
    }

    document.addEventListener('keydown', (e)=>{
      if(!$('#view-quiz') || $('#view-quiz').classList.contains('hidden')) return;
      if(e.key==='Enter'){ e.preventDefault(); checkAnswer(); }
      if(e.key==='ArrowRight'){ e.preventDefault(); skip(); }
    });

    $('#btnCheck').onclick = checkAnswer;
    $('#btnSkip').onclick = skip;

    /* ===================== INIT ===================== */
    function init(){
      buildHome();
      showView('home');
      $('#year').textContent = new Date().getFullYear();
    }
    init();
  </script>
</body>
</html>
