<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Focus Academy ¬∑ Matem√†tiques</title>
  <meta name="description" content="Pr√†ctiques de matem√†tiques tipus ThatQuiz per a estudiants. Single-file, sense depend√®ncies." />
  <style>
    :root{
      --bg: #0f1222;
      --card: #161a34;
      --muted: #8b91b7;
      --text: #eef2ff;
      --accent: #8b5cf6; /* violeta */
      --accent-2: #22d3ee; /* cian */
      --ok: #22c55e;
      --bad: #ef4444;
      --warn: #f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text); background:
        radial-gradient(1000px 600px at 10% -10%, rgba(139,92,246,.25), transparent 60%),
        radial-gradient(1000px 600px at 100% 10%, rgba(34,211,238,.15), transparent 50%),
        linear-gradient(180deg, #0c0f1d, #0b0e19 60%, #0a0d18);
    }
    header{
      position:sticky; top:0; z-index:5; backdrop-filter:saturate(1.2) blur(10px);
      background:rgba(12, 15, 29, .6); border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px; margin:0 auto; padding: clamp(14px, 2vw, 24px);}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{width:38px;height:38px; display:grid; place-items:center; border-radius:12px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow)}
    .brand h1{font-size:1.1rem; margin:0; letter-spacing:.2px}
    nav{display:flex; gap:8px; flex-wrap:wrap}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .pill{
      border:1px solid rgba(255,255,255,.08); color:var(--text); background:rgba(255,255,255,.03);
      padding:10px 14px; border-radius:999px; cursor:pointer; transition:.2s ease; font-weight:600; font-size:.92rem
    }
    .pill:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
    .right{display:flex; align-items:center; gap:10px}
    .input, select{
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
      color:var(--text); border-radius:12px; padding:10px 12px; outline:none; font-size:.95rem
    }
    .ghost{opacity:.8}

    main{padding: 28px 0 60px}
    .hero{display:grid; grid-template-columns: 1.3fr .7fr; gap:20px; align-items:stretch}
    .panel{background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow)}
    .card{padding: clamp(16px, 2.2vw, 26px)}
    .title{font-size: clamp(1.3rem, 2.6vw, 2rem); margin:0 0 10px}
    .subtitle{color:var(--muted); margin:0 0 18px}
    .grid{display:grid; grid-template-columns: repeat(4, 1fr); gap:14px}
    @media (max-width: 1000px){ .hero{grid-template-columns: 1fr} .grid{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width: 560px){ .grid{grid-template-columns: 1fr} }

    .option{position:relative; overflow:hidden; padding:16px; border-radius:16px; cursor:pointer; border:1px solid transparent; transition:.2s; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));}
    .option:hover{transform: translateY(-2px); border-color: rgba(255,255,255,.14)}
    .option h3{margin:8px 0 6px; font-size:1rem}
    .option p{margin:0; color:var(--muted); font-size:.9rem}
    .badge{font-size:.75rem; color:#0a1420; font-weight:800; letter-spacing:.3px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); padding:6px 10px; border-radius:999px; display:inline-block}

    .section-title{margin: 18px 0 8px; font-size:1rem; color:var(--muted); letter-spacing:.3px}

    .controls{display:flex; gap:10px; flex-wrap:wrap}
    button{background:linear-gradient(135deg, #3b82f6, #8b5cf6); color:white; border:0; padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow: var(--shadow); transition:.18s}
    button:hover{transform: translateY(-1px)}
    .btn-secondary{background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:var(--text); font-weight:700}
    .btn-ghost{background: transparent; border:1px dashed rgba(255,255,255,.25)}

    .hidden{display:none}

    /* Quiz */
    .quiz{display:grid; grid-template-columns: 1.1fr .9fr; gap:18px}
    @media (max-width: 1000px){ .quiz{grid-template-columns: 1fr} }
    .q-header{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .progress{height: 10px; background: rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2))}

    .q{display:grid; gap:14px}
    .q h2{font-size: clamp(1.4rem, 2.8vw, 2.2rem); margin:8px 0}
    .q .meta{color:var(--muted); font-size:.95rem}
    .answer-row{display:flex; gap:10px; align-items:center}
    .answer{flex:1; font-size:1.2rem}

    .kbd{display:inline-grid; place-items:center; min-width:46px; height:46px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-weight:800}

    .board{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    .board button{height:50px}

    .feedback{padding:12px; border-radius:12px; background: rgba(34,197,94,.08); border:1px solid rgba(34,197,94,.25)}
    .feedback.bad{background: rgba(239,68,68,.08); border-color: rgba(239,68,68,.25)}

    .timer{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" on; font-size:1.2rem}
    .chip{border:1px solid rgba(255,255,255,.1); color:var(--muted); padding:6px 10px; border-radius:999px}

    /* Results */
    table{width:100%; border-collapse:collapse}
    th, td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left}
    th{color:var(--muted); font-weight:700}
    tr:hover td{background: rgba(255,255,255,.03)}
    .tbl-actions{display:flex; gap:8px}

    footer{opacity:.8; font-size:.9rem; padding:40px 0 60px}
    .link{color:#a5b4fc; text-decoration:none}

    .pulse{animation:pulse 1.6s infinite}
    @keyframes pulse{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
      /* Modal */
    .modal{position:fixed; inset:0; background:rgba(10,13,24,.6); backdrop-filter: blur(6px); display:grid; place-items:center; z-index:50}
    .modal-inner{width:min(92vw, 820px)}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l3.5 7.2L23 10l-5.5 5.1L18.5 22 12 18.5 5.5 22l1-6.9L1 10l7.5-.8L12 2z" fill="white" opacity=".9"/>
          </svg>
        </div>
        <h1>Focus Academy ¬∑ Matem√†tiques</h1>
      </div>
      <nav class="right">
        <button class="pill" onclick="showView('home')">Inici</button>
        <button class="pill" onclick="showView('quiz')">Pr√†ctica</button>
        <button class="pill" onclick="showView('results')">Resultats</button>
        <button class="pill" onclick="showView('about')">Sobre</button>
        <input id="studentName" class="input" placeholder="Nom de l'alumne/a" />
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="view-home" class="hero">
      <div class="panel card">
        <h2 class="title">Benvingut/da! üëã</h2>
        <p class="subtitle">Tria un m√≤dul per comen√ßar. Pots configurar el nombre de preguntes, el nivell i el temps. Tot queda guardat en aquest dispositiu (sense comptes).</p>

        <div class="section-title">M√≤duls de matem√†tiques</div>
        <div class="grid" id="moduleGrid">
          <!-- Cards injected by JS -->
        </div>

        <div class="section-title">Configuraci√≥ r√†pida</div>
        <div class="controls">
          <label class="chip">Preguntes: <select id="cfg-count">
            <option>10</option><option>20</option><option>30</option><option>50</option>
          </select></label>
          <label class="chip">Temps (min): <select id="cfg-time">
            <option value="0">Sense l√≠mit</option><option>5</option><option>10</option><option>15</option><option>20</option>
          </select></label>
          <label class="chip">Nivell: <select id="cfg-level">
            <option value="easy">F√†cil</option><option value="mid">Mitj√†</option><option value="hard">Dif√≠cil</option>
          </select></label>
          <label class="chip">Negatius: <select id="cfg-neg">
            <option value="no">No</option><option value="yes">S√≠</option>
          </select></label>
          <button onclick="quickStart()">Comen√ßa ara</button>
        </div>
      </div>

      <div class="panel card">
        <h3 class="title" style="margin-bottom:6px">R√†nquing local üèÖ</h3>
        <p class="subtitle">Els millors resultats en aquest ordinador.</p>
        <div id="leaderboard">Carregant...</div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="view-quiz" class="hidden">
      <div class="quiz">
        <div class="panel card">
          <div class="q-header">
            <div style="display:flex; align-items:center; gap:10px">
              <span id="qModule" class="badge">Aritm√®tica</span>
              <span id="qLevel" class="chip">F√†cil</span>
              <span id="timer" class="chip timer">--:--</span>
            </div>
            <div class="progress" style="flex:1"><i id="bar"></i></div>
          </div>

          <div class="q">
            <div class="meta" id="qMeta">Pregunta 1 de 10</div>
            <h2 id="qText">3 + 4 = ?</h2>
            <div class="answer-row">
              <input id="answer" class="input answer" placeholder="Resposta" inputmode="decimal" />
              <button id="btnCheck">Comprova (‚Üµ)</button>
              <button class="btn-secondary" id="btnSkip">Omet (‚Üí)</button>
            </div>
            <div id="feedback"></div>
          </div>
        </div>

        <div class="panel card">
          <h3 style="margin-top:0">Teclat num√®ric</h3>
          <div class="board">
            <button onclick="typeKey('7')">7</button>
            <button onclick="typeKey('8')">8</button>
            <button onclick="typeKey('9')">9</button>
            <button onclick="typeKey('4')">4</button>
            <button onclick="typeKey('5')">5</button>
            <button onclick="typeKey('6')">6</button>
            <button onclick="typeKey('1')">1</button>
            <button onclick="typeKey('2')">2</button>
            <button onclick="typeKey('3')">3</button>
            <button onclick="typeKey('0')">0</button>
            <button onclick="typeKey('-')">¬±</button>
            <button onclick="typeKey('del')">‚å´</button>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px">
            <span class="kbd">‚Üµ</span> <span class="ghost">comprova</span>
            <span class="kbd">‚Üí</span> <span class="ghost">omet</span>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="view-results" class="hidden">
      <div class="panel card">
        <div class="row">
          <h3 class="title" style="margin:0">Resultats guardats</h3>
          <div class="tbl-actions">
            <button class="btn-secondary" onclick="exportCSV()">Exporta CSV</button>
            <button class="btn-ghost" onclick="clearResults()">Neteja</button>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
          <label class="chip">Filtra m√≤dul: <select id="filter-module"></select></label>
          <label class="chip">Alumne/a: <input id="filter-student" class="input" placeholder="Tots" style="width:160px"></label>
        </div>
        <div id="resultsTable">No hi ha dades encara.</div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="view-about" class="hidden">
      <div class="panel card">
        <h3 class="title" style="margin-top:0">Sobre aquesta eina</h3>
        <p class="subtitle">Web single-file creada per Focus Academy. Inspirada en ThatQuiz, sense comptes ni depend√®ncies. Dades locals al navegador.</p>
        <ul>
          <li>Generador de preguntes per: Aritm√®tica, Fraccions, Percentatges i Equacions lineals.</li>
          <li>Temps opcional, nivells, negatius i resum d'errors amb correcci√≥.</li>
          <li>R√†nquing local, historial exportable a CSV, i mode offline (funciona sense internet).</li>
        </ul>
        <p class="subtitle">Suggeriments? Envia'ns millores i crearem m√©s m√≤duls (pot√®ncies, arrels, √†rees...).</p>
      </div>
    </section>

    <footer class="wrap">
      Fet amb ‚ù§Ô∏è per Focus Academy ¬∑ ¬© <span id="year"></span>
    </footer>
  </main>

  <script>
    /* ===================== UTILS ===================== */
    // Simple modal helpers (non-destructive UI)
    function showModal(contentHTML){
      closeModal();
      const overlay = document.createElement('div');
      overlay.className = 'modal';
      overlay.innerHTML = `<div class="modal-inner panel card">${contentHTML}</div>`;
      document.body.appendChild(overlay);
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });
    }
    function closeModal(){ const m = document.querySelector('.modal'); if(m) m.remove(); }

    /* ===================== UTILS ===================== */
    const $ = (q) => document.querySelector(q);
    const $$ = (q) => Array.from(document.querySelectorAll(q));
    const rng = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
    const choice = (arr)=> arr[Math.floor(Math.random()*arr.length)];
    const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));

    const gcd = (a,b)=>{ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b] } return a||1 };
    const lcm = (a,b)=> Math.abs(a*b)/gcd(a,b);
    const simplifyFrac = (n,d)=>{ const g=gcd(n,d); return [n/g, d/g] };

    const store = {
      get k(){ return 'focus-math-results-v1' },
      all(){ try{ return JSON.parse(localStorage.getItem(this.k)||'[]') }catch{ return [] } },
      save(entry){ const all=this.all(); all.push(entry); localStorage.setItem(this.k, JSON.stringify(all)) },
      clear(){ localStorage.removeItem(this.k) }
    };

    const fmtTime = (sec)=>{
      const m = Math.floor(sec/60), s = sec%60; return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`
    }

    /* ===================== APP STATE ===================== */
    const MODULES = [
      { id:'arith', name:'Aritm√®tica', desc:'Sumes, restes, multiplicacions i divisions.', badge:'B√†sic', gen: genArith },
      { id:'frac', name:'Fraccions', desc:'Simplifica i compara fraccions.', badge:'Nou', gen: genFractions },
      { id:'perc', name:'Percentatges', desc:'Calcula percentatges i descomptes.', badge:'Pr√†ctic', gen: genPercent },
      { id:'eq1', name:'Equacions lineals', desc:'Resol ax + b = c.', badge:'√Älgebra', gen: genEq1 },
    ];

    const DEFAULTS = { count: 10, time: 0, level: 'easy', allowNeg: false };
    let session = null; // current quiz
    let timerHandle = null;

    /* ===================== UI BUILD ===================== */
    function showView(name){
      ['home','quiz','results','about'].forEach(v=> $('#view-'+v).classList.toggle('hidden', v!==name));
      if(name==='results') renderResults();
      if(name==='home') renderLeaderboard();
    }

    function buildHome(){
      // Module cards
      const grid = $('#moduleGrid'); grid.innerHTML='';
      MODULES.forEach(m=>{
        const el = document.createElement('div');
        el.className='option';
        el.innerHTML = `
          <span class="badge">${m.badge}</span>
          <h3>${m.name}</h3>
          <p>${m.desc}</p>`;
        el.onclick = ()=> startQuiz(m.id);
        grid.appendChild(el);
      });

      // Filters for results page
      const fm = $('#filter-module');
      fm.innerHTML = `<option value="">Tots</option>` + MODULES.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');

      // Defaults in quick config
      $('#cfg-count').value = DEFAULTS.count;
      $('#cfg-time').value = DEFAULTS.time;
      $('#cfg-level').value = DEFAULTS.level;
      $('#cfg-neg').value = DEFAULTS.allowNeg ? 'yes':'no';
    }

    /* ===================== QUIZ ENGINE ===================== */
    function startQuiz(moduleId){
      // Close any open modal to avoid overlay issues
      closeModal();
      const module = MODULES.find(m=>m.id===moduleId) || MODULES[0];
      const count = parseInt($('#cfg-count').value||DEFAULTS.count);
      const time = parseInt($('#cfg-time').value||0);
      const level = $('#cfg-level').value||'easy';
      const allowNeg = $('#cfg-neg').value==='yes';

      session = {
        module: moduleId,
        count, time, level, allowNeg,
        idx: 0,
        correct: 0,
        wrongs: [],
        startedAt: Date.now(),
        secondsLeft: time>0 ? time*60 : 0,
        questions: []
      };

      // pre-generate
      for(let i=0;i<count;i++) session.questions.push(module.gen(level, allowNeg));

      // UI
      $('#qModule').textContent = MODULES.find(m=>m.id===moduleId).name;
      $('#qLevel').textContent = levelLabel(level);
      $('#feedback').innerHTML='';
      $('#answer').value='';
      updateProgress();
      showView('quiz');
      renderQuestion();
      stopTimer();
      if(time>0) startTimer(); else $('#timer').textContent='Sense l√≠mit';
      $('#answer').focus();
    }

    function levelLabel(l){ return l==='easy'?'F√†cil':(l==='mid'?'Mitj√†':'Dif√≠cil') }

    function renderQuestion(){
      const q = session.questions[session.idx];
      $('#qMeta').textContent = `Pregunta ${session.idx+1} de ${session.count}`;
      $('#qText').textContent = q.text;
      $('#answer').value='';
      $('#feedback').innerHTML='';
    }

    function updateProgress(){
      const pct = (session.idx / session.count) * 100;
      $('#bar').style.width = pct + '%';
    }

    function startTimer(){
      $('#timer').textContent = fmtTime(session.secondsLeft);
      timerHandle = setInterval(()=>{
        session.secondsLeft--;
        $('#timer').textContent = fmtTime(Math.max(0, session.secondsLeft));
        if(session.secondsLeft<=0){
          stopTimer();
          finishQuiz(true);
        }
      }, 1000);
    }
    function stopTimer(){ if(timerHandle) clearInterval(timerHandle); timerHandle=null; }

    function checkAnswer(){
      if(!session || session.done){ flashFeedback('Prova finalitzada. Inicia una de nova des d\'Inici.'); return }

      const q = session.questions[session.idx];
      const raw = $('#answer').value.trim().replace(',', '.');
      if(raw==='') { flashFeedback('Escriu una resposta o prem Omet.', 'warn'); return; }

      let ok = false; let user;
      if(typeof q.answer === 'number'){
        user = Number(raw);
        // allow small float tolerance
        ok = Math.abs(user - q.answer) < 1e-9;
      } else if(typeof q.answer === 'string'){
        user = raw;
        ok = (user === q.answer);
      }

      if(ok){
        session.correct++;
        feedback(true, `Correcte!`);
      }else{
        session.wrongs.push({ ...q, user: raw });
        feedback(false, `Incorrecte. Resposta correcta: <b>${fmtAns(q.answer)}</b>`);
      }

      // next
      session.idx++;
      updateProgress();
      if(session.idx>=session.count){ finishQuiz(false) }
      else renderQuestion();
    }

    function skip(){
      if(!session || session.done){ flashFeedback('Prova finalitzada. Inicia una de nova des d\'Inici.'); return }
      const q = session.questions[session.idx];
      session.wrongs.push({ ...q, user: '‚Äî (omet)' });
      session.idx++;
      updateProgress();
      if(session.idx>=session.count){ finishQuiz(false) }
      else renderQuestion();
    }

    function feedback(isOk, msg){
      $('#feedback').innerHTML = `<div class="feedback ${isOk? '':'bad'}">${msg}</div>`;
    }
    function flashFeedback(msg, type='warn'){
      const color = type==='warn'? 'var(--warn)':'var(--bad)';
      $('#feedback').innerHTML = `<div class="feedback" style="background:transparent;border-color:${color};color:${color}">${msg}</div>`
    }
    function fmtAns(a){ return typeof a==='number' ? (Number.isInteger(a)? a : a.toFixed(3)) : a }

    function finishQuiz(timeUp){
      stopTimer();
      const elapsed = Math.floor((Date.now() - session.startedAt)/1000);
      const score = Math.round((session.correct / session.count) * 100);
      const name = ($('#studentName').value||'An√≤nim').trim();

      // Save
      store.save({
        at: new Date().toISOString(),
        name,
        module: session.module,
        level: session.level,
        count: session.count,
        correct: session.correct,
        time_limit: session.time,
        time_spent: elapsed,
        score,
        wrongs: session.wrongs
      });

      session.done = true;

      const html = `
        <h3 style="margin-top:0">${timeUp? 'Temps exhaurit ‚è±Ô∏è':'Prova finalitzada üéâ'}</h3>
        <p class="subtitle">${name} ¬∑ ${MODULES.find(m=>m.id===session.module).name} ¬∑ ${levelLabel(session.level)}</p>
        <div class="row" style="align-items:flex-end">
          <div>
            <div class="section-title">Resultat</div>
            <div style="font-size:2.2rem; font-weight:900">${score}%</div>
            <div class="subtitle">${session.correct}/${session.count} correctes ¬∑ Temps: ${fmtTime(elapsed)}</div>
            <div class="controls" style="margin-top:10px">
              <button onclick="startQuiz('${session.module}')">Torna-ho a fer</button>
              <button class="btn-secondary" onclick="showView('results')">Veure resultats</button>
              <button class="btn-ghost" onclick="closeModal()">Tanca</button>
            </div>
          </div>
          <div style="flex:1"></div>
        </div>
        <div class="section-title">Errors i correccions</div>
        ${session.wrongs.length? renderWrongs(session.wrongs): '<div class="chip">Cap error üéØ</div>'}
      `;
      showModal(html);
    }

    function renderWrongs(wr){
      return `<table><thead><tr><th>#</th><th>Pregunta</th><th>La teva</th><th>Correcta</th></tr></thead><tbody>`+
        wr.map((w,i)=>`<tr><td>${i+1}</td><td>${w.text}</td><td>${w.user}</td><td>${fmtAns(w.answer)}</td></tr>`).join('')+
        `</tbody></table>`
    }

    /* ===================== QUESTION GENERATORS ===================== */
    function genArith(level, allowNeg){
      const ranges = { easy:[0,20], mid:[-10,50], hard:[-50,120] };
      let [a,b] = ranges[level] || ranges.easy;
      let x = rng(a,b), y = rng(a,b);
      if(!allowNeg){ x = Math.max(0,x); y = Math.max(0,y); }
      const op = choice(['+','-','√ó','√∑']);
      let text, ans;
      switch(op){
        case '+': ans = x + y; text = `${x} + ${y} = ?`; break;
        case '-': ans = x - y; text = `${x} ‚àí ${y} = ?`; break;
        case '√ó': ans = x * y; text = `${x} √ó ${y} = ?`; break;
        case '√∑':
          // make divisible sometimes
          y = rng(1,10);
          const prod = x*y; ans = x; text = `${prod} √∑ ${y} = ?`; break;
      }
      return { type:'arith', text, answer: ans };
    }

    function genFractions(level){
      // Two modes: simplify or compare
      const mode = choice(['simplify','compare']);
      if(mode==='simplify'){
        let n=rng(2,40), d=rng(2,40); if(n===d) d++;
        const [sn,sd]=simplifyFrac(n,d);
        // avoid trivial already reduced in easy
        if(level==='easy' && sn===n && sd===d) return genFractions(level);
        return { type:'frac-simplify', text:`Simplifica: ${n}/${d}`, answer:`${sn}/${sd}` };
      } else {
        // compare a/b ? c/d  -> answer one of <, >, =
        let a=rng(1,15), b=rng(2,16), c=rng(1,15), d=rng(2,16);
        const lhs = a*d, rhs = c*b; let sign = '=';
        if(lhs>rhs) sign='>' ; else if(lhs<rhs) sign='<';
        return { type:'frac-compare', text:`Compara: ${a}/${b} ? ${c}/${d} (respon <, > o =)`, answer: sign };
      }
    }

    function genPercent(level){
      // Types: p% of N ; N is p% of ? ; increase/decrease
      const mode = choice(['of','is-of','discount']);
      if(mode==='of'){
        const p = [10,15,20,25,30,40,50,60,75,80][rng(0,9)];
        const n = rng(20, 800);
        const ans = +(n * p / 100).toFixed(2);
        return { type:'percent-of', text:`${p}% de ${n} = ?`, answer: ans };
      } else if(mode==='is-of'){
        const p = [10,12.5,20,25,33.33,40,50,66.67,75,80][rng(0,9)];
        const part = rng(10,600);
        const whole = +(part * 100 / p).toFixed(2);
        return { type:'percent-is-of', text:`${part} √©s el ${p}% de ?`, answer: whole };
      } else {
        const n = rng(20, 900);
        const off = [5,10,12,15,20,25,30,40][rng(0,7)];
        const ans = +(n * (1 - off/100)).toFixed(2);
        return { type:'percent-discount', text:`Descompte del ${off}% sobre ${n} ‚Üí preu final = ?`, answer: ans };
      }
    }

    function genEq1(level, allowNeg){
      // ax + b = c  -> find x, integers preferred
      let a = rng(1, 12) * (allowNeg && Math.random()<.3? -1: 1);
      let x = rng(-15, 15);
      let b = rng(-20, 20);
      const c = a*x + b;
      const text = `${a}¬∑x ${b>=0?'+':'‚àí'} ${Math.abs(b)} = ${c}. Troba x`;
      return { type:'eq1', text, answer: x };
    }

    /* ===================== RESULTS ===================== */
    function renderResults(){
      const data = store.all();
      const modFilter = $('#filter-module').value || '';
      const nameFilter = ($('#filter-student').value||'').toLowerCase();
      const filtered = data.filter(r=>
        (!modFilter || r.module===modFilter) && (!nameFilter || (r.name||'').toLowerCase().includes(nameFilter))
      );

      if(!filtered.length){ $('#resultsTable').innerHTML = '<div class="chip">No hi ha dades.</div>'; return }

      const rows = filtered.map((r,i)=>{
        const m = MODULES.find(m=>m.id===r.module)?.name || r.module;
        const d = new Date(r.at);
        return `<tr>
          <td>${i+1}</td>
          <td>${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
          <td>${r.name}</td>
          <td>${m}</td>
          <td>${levelLabel(r.level)}</td>
          <td>${r.correct}/${r.count}</td>
          <td>${r.score}%</td>
          <td>${fmtTime(r.time_spent)}</td>
        </tr>`
      }).join('');

      $('#resultsTable').innerHTML = `
        <table>
          <thead>
            <tr><th>#</th><th>Data</th><th>Alumne/a</th><th>M√≤dul</th><th>Nivell</th><th>Encerts</th><th>Puntuaci√≥</th><th>Temps</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function exportCSV(){
      const data = store.all();
      if(!data.length){ alert('No hi ha dades per exportar.'); return }
      const header = ['data','alumne','modul','nivell','preguntes','correctes','puntuacio','temps_limit','temps_consumit'];
      const lines = [header.join(',')];
      data.forEach(r=>{
        lines.push([
          r.at, r.name, r.module, r.level, r.count, r.correct, r.score, r.time_limit, r.time_spent
        ].join(','))
      })
      const blob = new Blob([lines.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='focus-academy-math-results.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function clearResults(){
      if(confirm('Segur que vols esborrar tots els resultats d\'aquest dispositiu?')){
        store.clear(); renderResults(); renderLeaderboard();
      }
    }

    function renderLeaderboard(){
      const data = store.all();
      if(!data.length){ $('#leaderboard').innerHTML='<div class="chip">Encara no hi ha puntuacions. Fes una prova! ‚ú®</div>'; return }
      // Top by score then time
      const best = [...data].sort((a,b)=> b.score-a.score || a.time_spent-b.time_spent).slice(0,8);
      const rows = best.map((r,i)=>{
        const m = MODULES.find(m=>m.id===r.module)?.name || r.module;
        return `<tr>
          <td>${i+1}</td>
          <td>${r.name}</td>
          <td>${m}</td>
          <td>${r.score}%</td>
          <td>${fmtTime(r.time_spent)}</td>
        </tr>`
      }).join('');
      $('#leaderboard').innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Alumne/a</th><th>M√≤dul</th><th>Puntuaci√≥</th><th>Temps</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    /* ===================== INPUT HANDLERS ===================== */
    function typeKey(k){
      const inp = $('#answer');
      if(k==='del') inp.value = inp.value.slice(0,-1);
      else if(k==='-'){
        if(inp.value.startsWith('-')) inp.value = inp.value.slice(1); else inp.value = '-' + inp.value;
      } else inp.value += k;
      inp.focus();
    }

    document.addEventListener('keydown', (e)=>{
      if($('#view-quiz').classList.contains('hidden')) return;
      if(e.key==='Enter'){ e.preventDefault(); checkAnswer(); }
      if(e.key==='ArrowRight'){ e.preventDefault(); skip(); }
    });

    $('#btnCheck').onclick = checkAnswer;
    $('#btnSkip').onclick = skip;

    function quickStart(){ startQuiz('arith') }

    /* ===================== INIT ===================== */
    buildHome();
    showView('home');
    $('#year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
