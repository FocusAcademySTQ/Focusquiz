<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Focus Academy ¬∑ Espai de rep√†s</title>
  <meta name="description" content="Pr√†ctiques de matem√†tiques per a estudiants. Single-file, sense depend√®ncies." />
  <link rel="stylesheet" href="style.css">

  <link rel="stylesheet" href="reptes/challenges.css">

</head>
  <!-- LOGIN LOCAL (overlay) -->
<div id="loginOverlay" class="login-overlay" hidden>
  <div class="login-dialog">
    <h2 class="login-title">Accedeix a Focus Academy</h2>
    <p class="login-subtitle">Tria un usuari existent o escriu un nom nou: aix√≠ guardarem els ex√†mens i podr√†s veure els resultats nom√©s en aquest dispositiu.</p>

    <label class="login-label" for="loginUserList">Usuaris existents</label>
    <div class="login-row">
      <select id="loginUserList" class="login-select"></select>
      <button id="btnLoginSelect" class="pill login-small">Entrar</button>
    </div>

    <div class="login-divider" role="presentation"></div>

    <label class="login-label" for="newUserName">Crear nou usuari</label>
    <p class="login-help">Posa-hi un nom senzill (per exemple ¬´La classe de 4t¬ª o el teu nom) per recon√®ixer on guardem els ex√†mens i notes.</p>
    <input id="newUserName" class="login-input input" placeholder="Nom (m√≠nim 2 car√†cters)" />
    <div class="login-row">
      <button id="btnCreateUser" class="btn login-primary">Crea i entra</button>
      <button id="btnDeleteUser" class="btn-ghost login-ghost">Suprimeix seleccionat</button>
    </div>

    <div class="login-footer">
      <small>üí° Nom√©s cal posar un nom per tenir guardats els ex√†mens i consultar els resultats quan tornis. Tot queda en localStorage, sense servidors.</small>
    </div>
  </div>
</div>

<body class="home-page">
  <header class="topbar">
    <div class="wrap row header-bar">

      <!-- üîπ Marca -->
      <button class="brand brand-home" type="button" onclick="showView('home')" aria-label="Tornar a l'inici">
        <div class="logo">FQ</div>
        <h1>Focus Academy</h1>
      </button>

      <!-- üîπ Navegaci√≥ principal -->
      <nav class="main-nav" aria-label="Navegaci√≥ principal">
        <button class="pill nav-btn" type="button" onclick="scrollToSection('tutorSection')">Tutor</button>
        <button class="pill nav-btn" type="button" onclick="scrollToSection('calendarSection')">Calendari</button>
        <button class="pill nav-btn" type="button" onclick="showView('challenges')">Reptes</button>
        <button class="pill nav-btn" type="button" onclick="scrollToSection('classSection')">Aula</button>
        <button class="pill nav-btn" type="button" onclick="scrollToSection('liveSection')">Live</button>
        <a class="pill nav-btn nav-btn-ghost" href="/portal/supabase-portal.html">Acc√©s professorat</a>
      </nav>

      <!-- üîπ Usuari actiu -->
      <div class="user-controls">
        <button id="activeUser" class="chip user-chip" type="button" aria-live="polite">
          üë§ <span class="label">Sessi√≥ no iniciada</span>
        </button>
        <button id="switchUserBtn" class="pill small" type="button">Canvia</button>
        <button id="logoutBtn" class="pill small" type="button">Surt</button>
      </div>

    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="view-home" class="hero">
      <div class="panel card">
        <h2 class="title">Benvingut/da! üëã</h2>
        <p class="subtitle">Tria un m√≤dul per configurar-lo i comen√ßar. Tot queda guardat en aquest dispositiu (sense comptes).</p>

        <div id="moduleGrid"></div>

        <!-- üß† Consell del tutor -->
        <div id="tutorSection" class="panel card tutor-card">
          <h3 class="title tutor-title">Consell del teu tutor virtual ü§ñ</h3>
          <div id="recommendationText" class="subtitle">Carregant recomanaci√≥...</div>
          <div class="tutor-actions">
          </div>
        </div>

        <section id="calendarSection" class="panel card study-calendar" aria-labelledby="studyCalendarTitle">
          <div class="study-calendar__header">
            <div>
              <p class="portal-section-title">Calendari d'estudi</p>
              <h2 id="studyCalendarTitle">Apunta tasques, ex√†mens i recordatoris</h2>
              <p class="subtitle">Un espai perqu√® l'alumnat pugui organitzar-se i afegir una descripci√≥ clara de cada esdeveniment.</p>
            </div>
            <div class="study-calendar__actions">
              <button class="pill" id="studyCalendarAddShortcut" type="button">+ Afegir</button>
              <button class="btn-ghost" id="studyCalendarToday" type="button">Avui</button>
            </div>
          </div>

          <div class="study-calendar__layout">
            <div class="study-calendar__board">
              <div class="study-calendar__month">
                <button class="btn-ghost" id="studyCalendarPrev" type="button" aria-label="Mes anterior">‚Üê</button>
                <div class="study-calendar__month-title">
                  <span data-calendar-month>Setembre 2024</span>
                  <strong>Vista mensual</strong>
                </div>
                <button class="btn-ghost" id="studyCalendarNext" type="button" aria-label="Mes seg√ºent">‚Üí</button>
              </div>

              <div class="study-calendar__legend">
                <span class="study-calendar__pill is-homework">Deures</span>
                <span class="study-calendar__pill is-exam">Examen</span>
                <span class="study-calendar__pill is-reminder">Recordatori</span>
              </div>

              <div class="study-calendar__weekdays">
                <span>Dl</span>
                <span>Dt</span>
                <span>Dc</span>
                <span>Dj</span>
                <span>Dv</span>
                <span>Ds</span>
                <span>Dg</span>
              </div>

              <div id="studyCalendarGrid" class="study-calendar__grid"></div>
            </div>

            <aside class="study-calendar__details">
              <div class="study-calendar__details-header">
                <div>
                  <p class="portal-section-title">Fitxa del dia</p>
                  <h3 id="studyCalendarSelectedDate">Selecciona un dia</h3>
                </div>
                <span class="study-calendar__badge" id="studyCalendarSelectedBadge">--</span>
              </div>
              <div class="study-calendar__details-card">
                <label class="study-calendar__label">
                  <span>Qu√® tens?</span>
                  <input class="input" id="studyCalendarTitleInput" type="text" placeholder="Examen, treball, recordatori..." />
                </label>
                <label class="study-calendar__label">
                  <span>Tipus</span>
                  <select class="input" id="studyCalendarTypeInput">
                    <option value="homework">Deures</option>
                    <option value="exam">Examen</option>
                    <option value="reminder">Recordatori</option>
                  </select>
                </label>
                <label class="study-calendar__label">
                  <span>Descripci√≥</span>
                  <textarea class="input" id="studyCalendarDescriptionInput" rows="5" placeholder="Detalla qu√® cal preparar, material, passos..."></textarea>
                </label>
                <div class="study-calendar__details-actions">
                  <button class="btn-primary" id="studyCalendarAddButton" type="button">Afegir</button>
                  <button class="btn-secondary" id="studyCalendarClearButton" type="button">Neteja</button>
                </div>
              </div>
              <div class="study-calendar__list">
                <h4>Esdeveniments del dia</h4>
                <p id="studyCalendarEmpty" class="study-calendar__empty">Encara no hi ha res programat per aquest dia.</p>
                <ul id="studyCalendarList" class="study-calendar__list-items"></ul>
              </div>
            </aside>
          </div>
        </section>

        <section id="challengesEntrySection" class="panel card challenge-entry" aria-labelledby="challengesEntryTitle">
          <div>
            <p class="portal-section-title">Reptes</p>
            <h2 id="challengesEntryTitle">Vols jugar als reptes Focus?</h2>
            <p class="subtitle">Entra a la zona de jocs i tria el repte disponible. Ara mateix: <strong>Joc de la corda</strong>.</p>
          </div>
          <div class="challenge-entry__actions">
            <button class="pill" type="button" onclick="showView('challenges')">Entrar a Reptes ‚Üí</button>
          </div>
        </section>


        <section id="classSection" class="panel card home-live-cta home-class-cta" aria-labelledby="homeClassTitle">
          <div class="home-live-cta__body">
            <p class="portal-section-title">Aula FocusQuiz</p>
            <h2 id="homeClassTitle">Has rebut un codi de prova?</h2>
            <p class="subtitle">Escriu el codi que t'ha donat el professorat i entra directament a l'espai de proves.</p>
            <form id="classCodeForm" class="home-live-join-form" autocomplete="off">
              <label class="portal-field-label" for="classCodeInput">Codi del test</label>
              <div class="home-live-join-controls">
                <input
                  id="classCodeInput"
                  class="input"
                  type="text"
                  name="classCode"
                  minlength="4"
                  maxlength="12"
                  required
                  placeholder="Exemple: TR01A2"
                  aria-describedby="classCodeHelp"
                />
                <button class="pill" type="submit">Entra a l'aula</button>
              </div>
              <p id="classCodeHelp" class="home-live-join-hint">
                Els tests FocusQuiz ara es fan a l'espai d'aula. Escriu el codi que t'ha donat el teu professorat.
              </p>
            </form>
          </div>
          <div class="home-live-cta__art home-class-cta__art" aria-hidden="true"></div>
        </section>

        <section id="liveSection" class="panel card home-live-cta" aria-labelledby="homeLiveTitle">
          <div class="home-live-cta__body">
            <p class="portal-section-title">Partides Live</p>
            <h2 id="homeLiveTitle">Tens un codi FocusQuiz?</h2>
            <p class="subtitle">Escriu el codi que t'ha compartit el professorat i entra directament a la partida en viu.</p>
            <form id="homeLiveJoinForm" class="home-live-join-form" autocomplete="off">
              <label class="portal-field-label" for="homeLiveJoinCode">Codi de partida</label>
              <div class="home-live-join-controls">
                <input
                  id="homeLiveJoinCode"
                  class="input"
                  type="text"
                  name="code"
                  minlength="4"
                  maxlength="8"
                  required
                  placeholder="Exemple: 72F8FE"
                />
                <button class="pill" type="submit">Unir-me</button>
              </div>
              <p class="home-live-join-hint">Et portarem a la sala de joc i nom√©s haur√†s d'introduir el teu nom.</p>
            </form>
          </div>
          <div class="home-live-cta__art" aria-hidden="true"></div>
        </section>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            // üîπ Mostra recomanaci√≥ del tutor
            showRecommendation('#recommendationText');

            const dropdown = document.querySelector('[data-nav-dropdown]');
            if (dropdown) {
              const summary = dropdown.querySelector('summary');
              const closeDropdown = () => {
                dropdown.open = false;
                if (summary) summary.focus();
              };

              dropdown.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && dropdown.open) {
                  event.preventDefault();
                  closeDropdown();
                }
              });

              document.addEventListener('click', (event) => {
                if (!dropdown.contains(event.target)) dropdown.open = false;
              });

              if (summary) {
                summary.addEventListener('keydown', (event) => {
                  if (event.key === ' ' || event.key === 'Enter') {
                    event.preventDefault();
                    dropdown.open = !dropdown.open;
                  }
                });
              }

              dropdown.addEventListener('toggle', () => {
                if (summary) summary.setAttribute('aria-expanded', dropdown.open ? 'true' : 'false');
              });

              if (summary) summary.setAttribute('aria-expanded', dropdown.open ? 'true' : 'false');
            }

            // üîπ Mostra l'usuari actiu (si n'hi ha)
            const current = localStorage.getItem('lastStudent');
            const badge = document.getElementById('activeUser');
            if (badge) {
              const label = badge.querySelector('.label');
              if (label) label.textContent = current || 'Sessi√≥ no iniciada';
              badge.classList.toggle('is-empty', !current);
            }

            const form = document.getElementById('classCodeForm');
            if (form) {
              form.addEventListener('submit', (event) => {
                event.preventDefault();
                const input = document.getElementById('classCodeInput');
                if (!input) return;
                const code = (input.value || '').trim().toUpperCase();
                if (!code) {
                  input.focus();
                  return;
                }
                const target = new URL('class.html', window.location.href);
                target.searchParams.set('code', code);
                window.location.href = target.toString();
              });
            }

            const calendarSection = document.querySelector('.study-calendar');
            if (calendarSection) {
              const storagePrefix = 'focusquiz.studyCalendar';
              const getStorageKey = () => `${storagePrefix}.${localStorage.getItem('lastStudent') || 'default'}`;
              let storageKey = getStorageKey();
              const addShortcut = document.getElementById('studyCalendarAddShortcut');
              const todayButton = document.getElementById('studyCalendarToday');
              const prevButton = document.getElementById('studyCalendarPrev');
              const nextButton = document.getElementById('studyCalendarNext');
              const monthLabel = calendarSection.querySelector('[data-calendar-month]');
              const grid = document.getElementById('studyCalendarGrid');
              const titleInput = document.getElementById('studyCalendarTitleInput');
              const typeInput = document.getElementById('studyCalendarTypeInput');
              const descInput = document.getElementById('studyCalendarDescriptionInput');
              const addButton = document.getElementById('studyCalendarAddButton');
              const clearButton = document.getElementById('studyCalendarClearButton');
              const selectedDateLabel = document.getElementById('studyCalendarSelectedDate');
              const selectedBadge = document.getElementById('studyCalendarSelectedBadge');
              const list = document.getElementById('studyCalendarList');
              const emptyState = document.getElementById('studyCalendarEmpty');
              let cells = [];
              let selectedDate = null;
              let eventsByDate = {};
              let editingIndex = null;
              let currentMonth = new Date();
              currentMonth.setDate(1);

              const loadEvents = () => {
                try {
                  eventsByDate = JSON.parse(localStorage.getItem(storageKey)) || {};
                } catch (error) {
                  eventsByDate = {};
                }
              };

              loadEvents();

              const typeLabels = {
                homework: 'Deures',
                exam: 'Examen',
                reminder: 'Recordatori'
              };

              const formatDate = (value) => {
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) return value;
                return parsed.toLocaleDateString('ca-ES', { weekday: 'short', day: 'numeric', month: 'long' });
              };

              const formatISO = (date) => date.toISOString().slice(0, 10);

              const setSelectedDate = (value) => {
                selectedDate = value;
                cells.forEach(cell => cell.classList.toggle('is-selected', cell.dataset.date === value));
                if (selectedDateLabel) selectedDateLabel.textContent = formatDate(value);
                if (selectedBadge) selectedBadge.textContent = value || '--';
                renderDetails();
              };

              const ensureSelectedDate = () => {
                if (!cells.length) return;
                const todayIso = formatISO(new Date());
                const todayCell = cells.find(cell => cell.dataset.date === todayIso);
                const monthCell = cells.find(cell => cell.dataset.inMonth === 'true');
                const hasSelected = cells.some(cell => cell.dataset.date === selectedDate);
                if (hasSelected && selectedDate) {
                  setSelectedDate(selectedDate);
                  return;
                }
                const fallback = todayCell || monthCell || cells[0];
                if (fallback) setSelectedDate(fallback.dataset.date);
              };

              const persist = () => {
                localStorage.setItem(storageKey, JSON.stringify(eventsByDate));
              };

              const syncWithActiveUser = () => {
                storageKey = getStorageKey();
                loadEvents();
                renderCells();
                renderDetails();
              };

              const renderMonthGrid = () => {
                if (!grid) return;
                if (monthLabel) {
                  monthLabel.textContent = currentMonth.toLocaleDateString('ca-ES', { month: 'long', year: 'numeric' });
                }

                grid.innerHTML = '';
                cells = [];

                const startOfMonth = new Date(currentMonth);
                startOfMonth.setDate(1);
                const startOffset = (startOfMonth.getDay() + 6) % 7;
                const totalCells = 42;

                for (let index = 0; index < totalCells; index++) {
                  const dayNumber = index - startOffset + 1;
                  const cellDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), dayNumber);
                  const isCurrentMonth = cellDate.getMonth() === currentMonth.getMonth();
                  const button = document.createElement('button');
                  button.className = 'study-calendar__cell';
                  if (!isCurrentMonth) button.classList.add('is-outside');
                  if (isCurrentMonth) button.dataset.inMonth = 'true';
                  button.dataset.date = formatISO(cellDate);
                  button.innerHTML = `
                    <span class="study-calendar__date">${cellDate.getDate()}</span>
                    <span class="study-calendar__events"></span>
                  `;
                  button.addEventListener('click', () => setSelectedDate(button.dataset.date));
                  grid.appendChild(button);
                  cells.push(button);
                }

                ensureSelectedDate();
                renderCells();
              };

              const renderCells = () => {
                const today = formatISO(new Date());
                cells.forEach(cell => {
                  const date = cell.dataset.date;
                  const container = cell.querySelector('.study-calendar__events');
                  cell.classList.toggle('is-today', date === today);
                  if (!container) return;
                  container.innerHTML = '';
                  const items = eventsByDate[date] || [];
                  items.slice(0, 2).forEach(item => {
                    const badge = document.createElement('span');
                    badge.className = `study-calendar__event is-${item.type}`;
                    badge.textContent = item.title;
                    container.appendChild(badge);
                  });
                  if (items.length > 2) {
                    const more = document.createElement('span');
                    more.className = 'study-calendar__more';
                    more.textContent = `+${items.length - 2}`;
                    container.appendChild(more);
                  }
                  if (items.length > 0) {
                    const count = document.createElement('span');
                    count.className = 'study-calendar__count';
                    count.textContent = items.length;
                    container.appendChild(count);
                  }
                });
              };

              const renderDetails = () => {
                const items = eventsByDate[selectedDate] || [];
                list.innerHTML = '';
                if (items.length === 0) {
                  emptyState.classList.remove('hidden');
                  editingIndex = null;
                  addButton.textContent = 'Afegir';
                  return;
                }
                emptyState.classList.add('hidden');
                items.forEach((item, index) => {
                  const li = document.createElement('li');
                  li.className = 'study-calendar__list-item';
                  li.innerHTML = `
                    <div>
                      <p class="study-calendar__list-title">${item.title}</p>
                      <p class="study-calendar__list-meta">${typeLabels[item.type] || 'Apunt'} ¬∑ ${item.description || 'Sense descripci√≥'}</p>
                    </div>
                    <div class="study-calendar__list-actions">
                      <button class="btn-ghost" type="button" data-edit-index="${index}">Edita</button>
                      <button class="btn-ghost" type="button" data-remove-index="${index}">Elimina</button>
                    </div>
                  `;
                  list.appendChild(li);
                });
              };

              const addEvent = () => {
                if (!selectedDate || !titleInput.value.trim()) {
                  titleInput.focus();
                  return;
                }
                const entry = {
                  title: titleInput.value.trim(),
                  description: descInput.value.trim(),
                  type: typeInput.value
                };
                eventsByDate[selectedDate] = eventsByDate[selectedDate] || [];
                if (editingIndex !== null) {
                  eventsByDate[selectedDate][editingIndex] = entry;
                  editingIndex = null;
                  addButton.textContent = 'Afegir';
                } else {
                  eventsByDate[selectedDate].push(entry);
                }
                persist();
                renderCells();
                renderDetails();
                titleInput.value = '';
                descInput.value = '';
                titleInput.focus();
              };

              const clearForm = () => {
                titleInput.value = '';
                descInput.value = '';
                typeInput.value = 'homework';
                editingIndex = null;
                addButton.textContent = 'Afegir';
              };

              const goToToday = () => {
                const today = new Date();
                const formatted = formatISO(today);
                currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                renderMonthGrid();
                const todayCell = cells.find(cell => cell.dataset.date === formatted);
                if (todayCell) {
                  setSelectedDate(formatted);
                  todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
              };

              list.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                if (target.dataset.editIndex !== undefined) {
                  const index = Number(target.dataset.editIndex);
                  const items = eventsByDate[selectedDate] || [];
                  const current = items[index];
                  if (!current) return;
                  editingIndex = index;
                  titleInput.value = current.title;
                  descInput.value = current.description || '';
                  typeInput.value = current.type || 'homework';
                  addButton.textContent = 'Desa canvis';
                  titleInput.focus();
                  return;
                }
                const removeIndex = target.dataset.removeIndex;
                if (removeIndex === undefined) return;
                const items = eventsByDate[selectedDate] || [];
                items.splice(Number(removeIndex), 1);
                if (items.length === 0) {
                  delete eventsByDate[selectedDate];
                }
                persist();
                renderCells();
                renderDetails();
              });

              addButton.addEventListener('click', addEvent);
              addShortcut.addEventListener('click', addEvent);
              clearButton.addEventListener('click', clearForm);
              todayButton.addEventListener('click', goToToday);

              prevButton?.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderMonthGrid();
              });

              nextButton?.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderMonthGrid();
              });

              document.addEventListener('focusquiz:user-login', syncWithActiveUser);
              document.addEventListener('focusquiz:user-logout', syncWithActiveUser);

              renderMonthGrid();
            }
          });
        </script>
      </div>
    </section>

    <!-- REPTES -->
    <section id="view-challenges" class="hidden">
      <div class="panel card">
        <div class="row" style="align-items:center; margin-bottom:.8rem">
          <div>
            <h2 class="title" style="margin:0">Reptes</h2>
            <p class="subtitle">Tria un joc i configura la partida per m√≤dul.</p>
          </div>
          <div class="controls">
            <button class="btn-secondary" type="button" onclick="showView('home')">‚Üê Torna</button>
          </div>
        </div>

        <section class="challenges-hero" aria-label="Portada de Reptes">
          <h2>Reptes Focus</h2>
          <p class="subtitle">Tria un mode de joc</p>
          <div class="challenges-cards">
            <article class="challenge-card">
              <span class="icon">ü™¢</span>
              <h3>Joc de la corda</h3>
              <p>Duel 1 vs 1 o campionat d'eliminat√≤ries.</p>
            </article>
            <article class="challenge-card">
              <span class="icon">‚öΩ</span>
              <h3>Joc de les xapes</h3>
              <p>Resposta correcta = tir de xapa fins al primer gol.</p>
            </article>
            <article class="challenge-card is-soon">
              <span class="icon">üèÜ</span>
              <h3>Torneig classe</h3>
              <p>Noves modalitats en preparaci√≥. Properament.</p>
            </article>
          </div>
        </section>
<section id="challengesSection" class="panel card challenge-section" aria-labelledby="challengesTitle">
          <div class="challenge-header">
            <p class="portal-section-title">Reptes</p>
            <h2 id="challengesTitle">Jocs per competir en equip</h2>
            <p class="subtitle">Tria un joc del men√∫. Disponibles: <strong>Joc de la corda</strong> i <strong>Joc de les xapes</strong>.</p>
          </div>

          <div class="challenge-menu" aria-label="Men√∫ de reptes">
            <button class="challenge-chip" type="button" data-challenge="tug" aria-current="true">ü™¢ Joc de la corda</button>
            <button class="challenge-chip" type="button" data-challenge="caps">‚öΩ Joc de les xapes</button>
            <button class="challenge-chip" type="button" disabled>üéØ Properament</button>
          </div>

          <div class="challenge-wrap" id="ttmGame" data-challenge-panel="tug">
            <!-- Modal de configuraci√≥ inicial (3 passos) -->
            <div class="ttm-modal" id="ttmModal" role="dialog" aria-modal="true" aria-labelledby="ttmSetupTitle">
              <div class="ttm-card">
                <p class="ttm-step-label" id="ttmStepLabel">Pas 1 de 3</p>
                <h3 id="ttmSetupTitle" class="ttm-title">Configuraci√≥ del joc de la corda</h3>
                <p class="subtitle">Quan entris al joc, primer et demanar√† de quin m√≤dul vols fer el repte.</p>

                <div class="ttm-step is-active" data-step="1">
                  <label class="ttm-module-field">
                    M√≤dul del repte
                    <select id="ttmModuleSelect">
                      <option value="arith">Aritm√®tica</option>
                      <option value="cat-morf">Morfologia</option>
                    </select>
                  </label>
                </div>

                <div class="ttm-step" data-step="2">
                  <p><strong>Configuraci√≥ de partida</strong></p>
                  <div class="ttm-grid3">
                    <button type="button" class="ttm-level is-selected" data-level="easy">üü¢ F√†cil</button>
                    <button type="button" class="ttm-level" data-level="medium">üü° Mitj√†</button>
                    <button type="button" class="ttm-level" data-level="hard">üî¥ Dif√≠cil</button>
                  </div>
                  <p class="subtitle" style="margin:.55rem 0 0">Regla nova: guanya l‚Äôequip que aconsegueix <strong>4 encerts m√©s</strong> que l‚Äôaltre.</p>
                  <div class="ttm-mode-buttons" role="group" aria-label="Mode de joc">
                    <button type="button" class="ttm-mode-btn is-active" data-mode="duel">1 vs 1</button>
                    <button type="button" class="ttm-mode-btn" data-mode="champ">Mode campionat</button>
                  </div>
                  <label class="ttm-tour-field" id="ttmBracketField" hidden>
                    Mida del bracket
                    <select id="ttmBracketSize">
                      <option value="4">4 jugadors/es</option>
                      <option value="8">8 jugadors/es</option>
                    </select>
                  </label>
                  <div class="ttm-module-config" id="ttmModuleConfigBox">
                    <div id="ttmModuleConfigFields" class="controls"></div>
                  </div>
                  <label class="ttm-tour-field" id="ttmParticipantsField" hidden>
                    Participants del campionat (una l√≠nia per jugador/a)
                    <textarea id="ttmParticipantsInput" placeholder="Anna
Marc
Laia
Nil"></textarea>
                  </label>
                </div>

                <div class="ttm-step" data-step="3">
                  <p><strong>Nom dels equips</strong></p>
                  <div class="ttm-team-inputs">
                    <label>Equip 1 (blau)
                      <input id="ttmBlueNameInput" type="text" maxlength="20" placeholder="Ex: Dracs blaus" />
                    </label>
                    <label>Equip 2 (vermell)
                      <input id="ttmRedNameInput" type="text" maxlength="20" placeholder="Ex: Flames roges" />
                    </label>
                  </div>
                </div>

                <p id="ttmSetupError" class="ttm-error" aria-live="polite"></p>
                <div class="ttm-actions">
                  <button class="btn-ghost" type="button" id="ttmPrevStep">Anterior</button>
                  <button class="pill" type="button" id="ttmNextStep">Seg√ºent</button>
                </div>
              </div>
            </div>

            <div class="ttm-quick-actions">
              <button class="ttm-exit-btn" type="button" id="ttmExitBtn">‚Üê Pantalla principal</button>
            </div>
            <h3 class="ttm-titlebar">JOC DE LA CORDA</h3>
            <div class="ttm-layout">
              <section class="ttm-team ttm-team--blue" data-team="blue">
                <div class="ttm-team-head ttm-team-head--blue">
                  <h3 id="ttmBluePanelTitle">Equip blau</h3>
                  <span class="ttm-team-points" id="ttmBlueScore">0</span>
                </div>
                <div class="ttm-team-body">
                  <p class="ttm-question" id="ttmQuestionBlue">8 + 8 = ?</p>
                  <div class="ttm-question-media" id="ttmMediaBlue"></div>
                  <div class="ttm-input" id="ttmInputBlue">0</div>
                  <div class="ttm-keypad" data-keypad="blue"></div>
                </div>
              </section>

              <section class="ttm-arena">
                <div class="ttm-hud">
                  <div class="ttm-score ttm-score--blue"><strong id="ttmBlueName">Equip blau</strong><span>Marcador</span></div>
                  <div class="ttm-timer" id="ttmTimer">02:00</div>
                  <div class="ttm-score ttm-score--red"><strong id="ttmRedName">Equip vermell</strong><span>Marcador</span></div>
                </div>
                <div class="ttm-rope-zone" aria-label="Corda del tira-corda">
                  <div class="ttm-center"></div>
                  <div class="ttm-track">
                    <div class="ttm-rope"></div>
                    <div class="ttm-flag" id="ttmFlag"></div>
                  </div>
                  <div class="ttm-tugger ttm-tugger--left" id="ttmBluePullerA">üßç‚Äç‚ôÇÔ∏è</div>
                  <div class="ttm-tugger ttm-tugger--left b" id="ttmBluePullerB">üßç‚Äç‚ôÇÔ∏è</div>
                  <div class="ttm-tugger ttm-tugger--right" id="ttmRedPullerA">üßç‚Äç‚ôÇÔ∏è</div>
                  <div class="ttm-tugger ttm-tugger--right b" id="ttmRedPullerB">üßç‚Äç‚ôÇÔ∏è</div>
                  <p class="ttm-image-hint">Si vols posar una imatge pr√≤pia de l'animaci√≥, desa-la a <code>assets/challenges/tug-war.png</code> i substitueix aquests personatges.</p>
                </div>
              </section>

              <section class="ttm-team ttm-team--red" data-team="red">
                <div class="ttm-team-head ttm-team-head--red">
                  <h3 id="ttmRedPanelTitle">Equip vermell</h3>
                  <span class="ttm-team-points" id="ttmRedScore">0</span>
                </div>
                <div class="ttm-team-body">
                  <p class="ttm-question" id="ttmQuestionRed">7 + 6 = ?</p>
                  <div class="ttm-question-media" id="ttmMediaRed"></div>
                  <div class="ttm-input" id="ttmInputRed">0</div>
                  <div class="ttm-keypad" data-keypad="red"></div>
                </div>
              </section>
            </div>

            <div class="ttm-result" id="ttmResult" hidden>
              <div class="ttm-result-card">
                <p class="portal-section-title">Partida finalitzada</p>
                <h3 id="ttmWinnerTitle">Guanya l'equip blau!</h3>
                <p id="ttmWinnerStats"></p>
                <button class="pill" type="button" id="ttmRestartBtn">Tornar a jugar</button>
              </div>
            </div>
          </div>


          <div class="challenge-wrap" id="capGame" data-challenge-panel="caps" hidden>
            <div class="ttm-modal" id="capModal" role="dialog" aria-modal="true" aria-labelledby="capSetupTitle">
              <div class="ttm-card">
                <p class="ttm-step-label" id="capStepLabel">Pas 1 de 3</p>
                <h3 id="capSetupTitle" class="ttm-title">Configuraci√≥ del joc de les xapes</h3>
                <p class="subtitle">Resposta correcta = 1 tir de xapa. La partida acaba al primer gol.</p>
                <div class="ttm-step is-active" data-step="1">
                  <label class="ttm-module-field">M√≤dul del repte
                    <select id="capModuleSelect"><option value="arith">Aritm√®tica</option><option value="cat-morf">Morfologia</option></select>
                  </label>
                </div>
                <div class="ttm-step" data-step="2">
                  <p><strong>Configuraci√≥ de partida</strong></p>
                  <div class="ttm-grid3">
                    <button type="button" class="ttm-level is-selected" data-level="easy">üü¢ F√†cil</button>
                    <button type="button" class="ttm-level" data-level="medium">üü° Mitj√†</button>
                    <button type="button" class="ttm-level" data-level="hard">üî¥ Dif√≠cil</button>
                  </div>
                  <div class="ttm-mode-buttons" role="group" aria-label="Mode de joc">
                    <button type="button" class="ttm-mode-btn is-active" data-mode="duel">1 vs 1</button>
                    <button type="button" class="ttm-mode-btn" data-mode="champ">Mode campionat</button>
                  </div>
                  <label class="ttm-tour-field" id="capBracketField" hidden>Mida del bracket<select id="capBracketSize"><option value="4">4 jugadors/es</option><option value="8">8 jugadors/es</option></select></label>
                  <div class="ttm-module-config"><div id="capModuleConfigFields" class="controls"></div></div>
                  <label class="ttm-tour-field" id="capParticipantsField" hidden>Participants del campionat (una l√≠nia per jugador/a)<textarea id="capParticipantsInput" placeholder="Anna
Marc
Laia
Nil"></textarea></label>
                </div>
                <div class="ttm-step" data-step="3">
                  <p><strong>Nom dels equips</strong></p>
                  <div class="ttm-team-inputs">
                    <label>Equip 1 (blau)<input id="capBlueNameInput" type="text" maxlength="20" placeholder="Ex: Dracs blaus" /></label>
                    <label>Equip 2 (vermell)<input id="capRedNameInput" type="text" maxlength="20" placeholder="Ex: Flames roges" /></label>
                  </div>
                </div>
                <p id="capSetupError" class="ttm-error" aria-live="polite"></p>
                <div class="ttm-actions"><button class="btn-ghost" type="button" id="capPrevStep">Anterior</button><button class="pill" type="button" id="capNextStep">Seg√ºent</button></div>
              </div>
            </div>
            <div class="ttm-quick-actions"><button class="ttm-exit-btn" type="button" id="capExitBtn">‚Üê Pantalla principal</button></div>
            <h3 class="ttm-titlebar">JOC DE LES XAPES</h3>
            <div class="ttm-layout">
              <section class="ttm-team ttm-team--blue" data-team="blue">
                <div class="ttm-team-head ttm-team-head--blue"><h3 id="capBluePanelTitle">Equip blau</h3><span class="ttm-team-points" id="capBlueScore">0</span></div>
                <div class="ttm-team-body"><p class="ttm-question" id="capQuestionBlue">8 + 8 = ?</p><div class="ttm-question-media" id="capMediaBlue"></div><div class="ttm-input" id="capInputBlue">0</div><div class="ttm-keypad" data-keypad="blue"></div></div>
              </section>
              <section class="ttm-arena">
                <div class="ttm-hud">
                  <div class="ttm-score ttm-score--blue"><strong id="capBlueName">Equip blau</strong><span>Gols</span></div>
                  <div class="ttm-timer" id="capTimer">02:00</div>
                  <div class="ttm-score ttm-score--red"><strong id="capRedName">Equip vermell</strong><span>Gols</span></div>
                </div>
                <div class="cap-turn" id="capTurnHint">Encerta una pregunta per fer un tir.</div>
                <div class="cap-field" id="capField"><div class="cap-midline"></div><div class="cap-goal cap-goal--left"></div><div class="cap-goal cap-goal--right"></div><div class="cap-ball" id="capBall"></div><div class="cap-chip cap-chip--blue" id="capChipBlue"></div><div class="cap-chip cap-chip--red" id="capChipRed"></div></div>
              </section>
              <section class="ttm-team ttm-team--red" data-team="red">
                <div class="ttm-team-head ttm-team-head--red"><h3 id="capRedPanelTitle">Equip vermell</h3><span class="ttm-team-points" id="capRedScore">0</span></div>
                <div class="ttm-team-body"><p class="ttm-question" id="capQuestionRed">7 + 6 = ?</p><div class="ttm-question-media" id="capMediaRed"></div><div class="ttm-input" id="capInputRed">0</div><div class="ttm-keypad" data-keypad="red"></div></div>
              </section>
            </div>
            <div class="ttm-result" id="capResult" hidden><div class="ttm-result-card"><p class="portal-section-title">Partida finalitzada</p><h3 id="capWinnerTitle">Gol!</h3><p id="capWinnerStats"></p><button class="pill" type="button" id="capRestartBtn">Tornar a jugar</button></div></div>
          </div>
        </section>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="view-config" class="hidden">
      <div class="panel card">
        <div class="row" style="align-items:center">
          <div>
            <h2 class="title" id="cfg-title" style="margin:0">Configura el m√≤dul</h2>
            <p class="subtitle" id="cfg-desc"></p>
          </div>
          <div class="controls">
            <button class="btn-secondary" onclick="showView('home')">‚Üê Torna</button>
            <button onclick="startFromConfig()">Comen√ßa</button>
          </div>
        </div>

        <div class="section-title">Opcions comunes</div>
        <div class="controls">
          <label class="field chip">Preguntes
            <select id="cfg-count">
              <option>10</option><option>20</option><option>30</option><option>50</option>
            </select>
          </label>
          <label class="field chip">Temps (min)
            <select id="cfg-time">
              <option value="0">Sense l√≠mit</option><option>5</option><option>10</option><option>15</option><option>20</option>
            </select>
          </label>
          <label class="field chip" id="cfg-level-wrap">Nivell (1‚Äì4)
            <select id="cfg-level"></select>
          </label>
        </div>

        <div id="cfg-specific"></div>
      </div>
    </section>

   <!-- QUIZ -->
<section id="view-quiz" class="hidden">
  <div class="quiz">

    <!-- üîπ Columna esquerra -->
    <div id="leftCol">
      <div class="panel card">
        <div class="q-header">
          <div style="display:flex; align-items:center; gap:10px">
            <span id="qModule" class="chip">‚Äî</span>
            <span id="qLevel" class="chip">Nivell 1</span>
            <span id="timer" class="chip timer">--:--</span>
          </div>
          <div class="progress" style="flex:1"><i id="bar"></i></div>
        </div>

        <div class="q">
          <div class="meta" id="qMeta">Pregunta 1 de 10</div>
          <h2 id="qText">‚Äî</h2>
          <div id="qMedia" style="margin:4px 0 2px"></div>
          <div class="answer-row">
            <input id="answer" class="input answer" placeholder="Resposta" type="text" />
            <button id="btnCheck">Comprova (‚Üµ)</button>
            <button class="btn-secondary" id="btnSkip">Omet (‚Üí)</button>
          </div>
          <div id="feedback"></div>
        </div>
      </div>
    </div>

    <!-- üîπ Columna dreta (teclat o opcions) -->
    <div id="rightCol">
      <div class="panel card" id="keypad"></div>
    </div>

  </div>
</section>


    <!-- RESULTS -->
    <section id="view-results" class="hidden">
      <div class="panel card">
        <div class="row">
          <h3 class="title" style="margin:0">Resultats guardats</h3>
          <div class="tbl-actions">
            <button class="btn-secondary" onclick="exportCSV()">Exporta CSV</button>
            <button class="btn-ghost" onclick="clearResults()">Neteja</button>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
          <label class="chip">Filtra m√≤dul: <select id="filter-module"></select></label>
          <label class="chip">Alumne/a: <input id="filter-student" class="input" placeholder="Tots" style="width:160px"></label>
        </div>
        <div id="resultsTable">No hi ha dades encara.</div>
      </div>

      <!-- PERFIL / ANALYTICS -->
      <div class="panel card" id="results-analytics">
        <div class="row" style="align-items:center">
          <h3 class="title" style="margin:0">Perfil i gr√†fiques</h3>
          <div class="subtitle">Es basa en el filtre d'<b>alumne</b> i (opcionalment) el de <b>m√≤dul</b>.</div>
        </div>

        <!-- KPIs -->
        <div class="kpi-grid" id="kpiWrap">
          <!-- S‚Äôomple des de JS -->
        </div>

        <!-- Charts -->
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-title">Evoluci√≥ de puntuaci√≥</div>
            <div id="chartScoreTrend"></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Mitjana per m√≤dul</div>
            <div id="chartByModule"></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Temps vs Puntuaci√≥</div>
            <div id="chartTimeVsScore"></div>
          </div>
        </div>

        <div id="analyticsHint" class="chip" style="margin-top:10px; display:none">
          Escriu un nom d‚Äôalumne/a al filtre per veure el seu perfil.
        </div>
      </div>
    </section>

    <!-- ABOUT -->
<section id="view-about" class="hidden">
  <div class="panel card">
    <h3 class="title" style="margin-top:0">Sobre aquesta eina</h3>
    <p class="subtitle">
      Web single-file creada per <strong>Focus Academy</strong>, sense comptes ni depend√®ncies.  
      Dades locals al navegador.
    </p>
    <ul>
      <li><strong>Generador de preguntes</strong> per a Matem√†tiques (aritm√®tica, fraccions, percentatges, equacions, geometria, estad√≠stica, unitats), Llengua catalana i castellana (ortografia, categories gramaticals, sintaxi), Qu√≠mica (elements, f√≥rmules i compostos) i Geografia (pa√Øsos i banderes).</li>
      <li><strong>Temps opcional</strong>, nivell 1‚Äì4, i rep√†s de nom√©s les preguntes err√≤nies.</li>
      <li><strong>Historial exportable</strong> a CSV i <strong>gr√†fics de rendiment</strong>.</li>
      <li><strong>Tutor personalitzat</strong> que t‚Äôacompanya pas a pas en l‚Äôaprenentatge.</li>
    </ul>
  </div>
</section>

    <footer class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:16px">
      <div>Fet per Focus Academy Sant Cugat ¬∑ ¬© <span id="year"></span></div>
      <img src="https://static.wixstatic.com/media/543803_e8b22e64a34945f9ba54d4ca39fa3645~mv2.png/v1/crop/x_836,y_591,w_1877,h_1328/fill/w_642,h_454,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/543803_e8b22e64a34945f9ba54d4ca39fa3645~mv2.png"
           alt="Logo Focus Academy" style="height:40px; width:auto; object-fit:contain"
           referrerpolicy="no-referrer" />
  </footer>
  </main>

  <!-- üîπ Carrega primer els m√≤duls auxiliars -->
  <script src="lang-cat.js" defer></script>
  <script src="lang-esp.js" defer></script>
  <script src="quim.js" defer></script>
  <script src="geo.js" defer></script>
  <script src="tutor.js"></script>
  <script src="flashcards.js" defer></script>

  <!-- üîπ Despr√©s el bloc del login local -->
  <script>
  document.addEventListener('DOMContentLoaded', ()=> {
    const overlay = document.querySelector('#loginOverlay');
    const userList = document.querySelector('#loginUserList');
    const btnSelect = document.querySelector('#btnLoginSelect');
    const btnCreate = document.querySelector('#btnCreateUser');
    const btnDelete = document.querySelector('#btnDeleteUser');
    const inputNew = document.querySelector('#newUserName');

    function setOverlayVisible(open) {
      if (!overlay) return;
      overlay.classList.toggle('is-active', open);
      overlay.toggleAttribute('hidden', !open);
      overlay.style.display = open ? 'flex' : 'none';
    }

    // üîπ Carrega usuaris guardats
    function refreshUsers(){
      const users = JSON.parse(localStorage.getItem('students') || '[]');
      userList.innerHTML = users.map(u=>`<option>${u}</option>`).join('');
    }

    // üîπ Mostra overlay si no hi ha usuari actiu
    const current = localStorage.getItem('lastStudent');
    setOverlayVisible(!current);

    // üîπ Entrar amb usuari existent
    btnSelect.addEventListener('click', ()=>{
      const name = userList.value.trim();
      if(!name) return alert('Selecciona un usuari.');
      localStorage.setItem('lastStudent', name);
      setOverlayVisible(false);
      document.dispatchEvent(new CustomEvent('focusquiz:user-login'));
    });

    // üîπ Crear nou usuari
    btnCreate.addEventListener('click', ()=>{
      const name = inputNew.value.trim();
      if(name.length < 2) return alert('Nom massa curt.');
      const users = JSON.parse(localStorage.getItem('students') || '[]');
      if(!users.includes(name)) users.push(name);
      localStorage.setItem('students', JSON.stringify(users));
      localStorage.setItem('lastStudent', name);
      refreshUsers();
      inputNew.value = '';
      setOverlayVisible(false);
      document.dispatchEvent(new CustomEvent('focusquiz:user-login'));
    });

    // üîπ Esborrar usuari
    btnDelete.addEventListener('click', ()=>{
      const name = userList.value.trim();
      if(!name) return alert('Selecciona un usuari.');
      const users = JSON.parse(localStorage.getItem('students') || '[]').filter(u => u !== name);
      localStorage.setItem('students', JSON.stringify(users));
      if(localStorage.getItem('lastStudent') === name) localStorage.removeItem('lastStudent');
      refreshUsers();
      if(!localStorage.getItem('lastStudent')){
        setOverlayVisible(true);
        document.dispatchEvent(new CustomEvent('focusquiz:user-logout'));
      }
    });

    // üîπ Bot√≥ "Canvia d'usuari"
    const switchBtn = document.getElementById('switchUserBtn');
    if (switchBtn) {
      switchBtn.addEventListener('click', () => {
        localStorage.removeItem('lastStudent');
        setOverlayVisible(true);
        document.dispatchEvent(new CustomEvent('focusquiz:user-logout'));
      });
    }

    // üîπ Bot√≥ "Tanca sessi√≥"
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        const currentName = localStorage.getItem('lastStudent');
        if (!currentName || confirm(`Vols tancar la sessi√≥ de ${currentName}?`)) {
          localStorage.removeItem('lastStudent');
          setOverlayVisible(true);
          if (currentName) alert('Sessi√≥ tancada.');
          document.dispatchEvent(new CustomEvent('focusquiz:user-logout'));
        }
      });
    }

    refreshUsers();
  });
  </script>






  <script src="reptes/challenges.js" defer></script>
  <script src="reptes/tug-game.js" defer></script>
  <script src="reptes/caps-game.js" defer></script>


  <script>
    // ===== Men√∫ de reptes (canvi de joc) =====
    (() => {
      const chips = Array.from(document.querySelectorAll('.challenge-chip[data-challenge]'));
      const panels = Array.from(document.querySelectorAll('[data-challenge-panel]'));
      if (!chips.length || !panels.length) return;
      const activate = (id) => {
        chips.forEach((chip) => chip.setAttribute('aria-current', chip.dataset.challenge === id ? 'true' : 'false'));
        panels.forEach((panel) => { panel.hidden = panel.dataset.challengePanel !== id; });
      };
      chips.forEach((chip) => chip.addEventListener('click', () => activate(chip.dataset.challenge || 'tug')));
      activate('tug');
    })();
  </script>

  <script>
    // ===== L√≤gica del repte: Joc de les xapes =====
    (() => {
      const root = document.getElementById('capGame');
      if (!root) return;
      const DURATION = 120;

      const state = {
        step: 1,
        difficulty: 'easy',
        moduleId: 'arith',
        moduleMeta: null,
        moduleOptions: {},
        gameMode: 'duel',
        bracketSize: 4,
        tournament: null,
        running: false,
        timeLeft: DURATION,
        shooter: null,
        timerId: null,
        frameId: null,
        drag: null,
        field: {
          w: 0, h: 0,
          ball: { x: 0, y: 0, vx: 0, vy: 0, r: 17 },
          blue: { x: 0, y: 0, vx: 0, vy: 0, r: 17 },
          red: { x: 0, y: 0, vx: 0, vy: 0, r: 17 }
        },
        teams: {
          blue: { name: 'Equip blau', score: 0, input: '', current: null, rawCorrect: 0 },
          red: { name: 'Equip vermell', score: 0, input: '', current: null, rawCorrect: 0 }
        }
      };

      const els = {
        modal: document.getElementById('capModal'),
        stepLabel: document.getElementById('capStepLabel'),
        steps: Array.from(root.querySelectorAll('.ttm-step')),
        prevStep: document.getElementById('capPrevStep'),
        nextStep: document.getElementById('capNextStep'),
        setupError: document.getElementById('capSetupError'),
        moduleSelect: document.getElementById('capModuleSelect'),
        moduleConfigFields: document.getElementById('capModuleConfigFields'),
        levelButtons: Array.from(root.querySelectorAll('[data-level]')),
        modeButtons: Array.from(root.querySelectorAll('[data-mode]')),
        bracketField: document.getElementById('capBracketField'),
        bracketSize: document.getElementById('capBracketSize'),
        participantsField: document.getElementById('capParticipantsField'),
        participantsInput: document.getElementById('capParticipantsInput'),
        teamInputsWrap: root.querySelector('.ttm-team-inputs'),
        blueNameInput: document.getElementById('capBlueNameInput'),
        redNameInput: document.getElementById('capRedNameInput'),
        blueName: document.getElementById('capBlueName'),
        redName: document.getElementById('capRedName'),
        bluePanelTitle: document.getElementById('capBluePanelTitle'),
        redPanelTitle: document.getElementById('capRedPanelTitle'),
        blueScore: document.getElementById('capBlueScore'),
        redScore: document.getElementById('capRedScore'),
        timer: document.getElementById('capTimer'),
        turnHint: document.getElementById('capTurnHint'),
        field: document.getElementById('capField'),
        ball: document.getElementById('capBall'),
        chipBlue: document.getElementById('capChipBlue'),
        chipRed: document.getElementById('capChipRed'),
        questionBlue: document.getElementById('capQuestionBlue'),
        questionRed: document.getElementById('capQuestionRed'),
        mediaBlue: document.getElementById('capMediaBlue'),
        mediaRed: document.getElementById('capMediaRed'),
        inputBlue: document.getElementById('capInputBlue'),
        inputRed: document.getElementById('capInputRed'),
        result: document.getElementById('capResult'),
        winnerTitle: document.getElementById('capWinnerTitle'),
        winnerStats: document.getElementById('capWinnerStats'),
        restartBtn: document.getElementById('capRestartBtn'),
        exitBtn: document.getElementById('capExitBtn')
      };

      const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
      const formatTime = (t) => `${String(Math.floor(t / 60)).padStart(2, '0')}:${String(t % 60).padStart(2, '0')}`;
      const getRegisteredModules = () => (typeof window.getRegisteredModules === 'function' ? window.getRegisteredModules() : []);
      const isIntegerLike = (v) => (typeof v === 'number' ? Number.isFinite(v) && Number.isInteger(v) : /^-?\\d+$/.test(String(v || '').trim()));

      function updateStepUi() {
        els.stepLabel.textContent = `Pas ${state.step} de 3`;
        els.steps.forEach((node) => node.classList.toggle('is-active', Number(node.dataset.step) === state.step));
        els.prevStep.disabled = state.step === 1;
        els.nextStep.textContent = state.step === 3 ? 'Comen√ßa el joc' : 'Seg√ºent';
        applyGameModeUi();
      }
      function applyGameModeUi() {
        els.modeButtons.forEach((btn) => btn.classList.toggle('is-active', btn.dataset.mode === state.gameMode));
        const isChamp = state.gameMode === 'champ';
        if (els.bracketField) els.bracketField.hidden = !isChamp;
        if (els.participantsField) els.participantsField.hidden = !isChamp;
        if (els.teamInputsWrap) els.teamInputsWrap.style.display = isChamp ? 'none' : 'grid';
      }

      function renderModuleConfigFields() {
        const box = els.moduleConfigFields;
        if (!box) return;
        const mod = getRegisteredModules().find((m) => m.id === state.moduleId) || state.moduleMeta;
        if (state.moduleId === 'arith') {
          box.innerHTML = `<div class="section-title">Opcions d'aritm√®tica</div><div class="controls"><div class="group"><label class="toggle"><input class="check" type="checkbox" id="cap-op-plus" checked> Sumes</label><label class="toggle"><input class="check" type="checkbox" id="cap-op-minus" checked> Restes</label><label class="toggle"><input class="check" type="checkbox" id="cap-op-times" checked> Multiplicacions</label><label class="toggle"><input class="check" type="checkbox" id="cap-op-div" checked> Divisions</label></div></div>`;
          return;
        }
        if (mod?.config && typeof mod.config.render === 'function') {
          box.innerHTML = '';
          const rendered = mod.config.render();
          if (rendered) {
            box.appendChild(rendered);
            const basicInput = box.querySelector('input[name="cat-morf-sub"][value="basiques"]');
            if (basicInput) {
              basicInput.closest('label')?.remove();
              if (basicInput.checked) box.querySelector('input[name="cat-morf-sub"]')?.setAttribute('checked', 'checked');
            }
          }
          return;
        }
        box.innerHTML = '<span class="subtitle">Aquest m√≤dul no t√© opcions extra.</span>';
      }

      function readModuleOptions() {
        const options = {};
        if (state.moduleId === 'arith') {
          options.ops = [];
          if (document.getElementById('cap-op-plus')?.checked) options.ops.push('+');
          if (document.getElementById('cap-op-minus')?.checked) options.ops.push('-');
          if (document.getElementById('cap-op-times')?.checked) options.ops.push('√ó');
          if (document.getElementById('cap-op-div')?.checked) options.ops.push('√∑');
          if (!options.ops.length) options.ops.push('+');
        } else if (state.moduleMeta?.config && typeof state.moduleMeta.config.collect === 'function') {
          Object.assign(options, state.moduleMeta.config.collect() || {});
        }
        state.moduleOptions = options;
      }

      function populateModuleOptions() {
        const allowed = new Set(['arith', 'cat-morf']);
        const mods = getRegisteredModules().filter((m) => allowed.has(m.id));
        els.moduleSelect.innerHTML = mods.map((m) => `<option value="${m.id}">${m.name || m.id}</option>`).join('') || '<option value="arith">Aritm√®tica</option>';
        if (!mods.some((m) => m.id === state.moduleId)) state.moduleId = mods[0]?.id || 'arith';
        els.moduleSelect.value = state.moduleId;
        state.moduleMeta = mods.find((m) => m.id === state.moduleId) || null;
        renderModuleConfigFields();
      }

      function createArithmeticQuestion() {
        const cfg = { easy:[0,20], medium:[-30,60], hard:[-80,140] };
        const [min,max] = cfg[state.difficulty] || cfg.easy;
        const ops = state.moduleOptions.ops?.length ? state.moduleOptions.ops : ['+'];
        const op = ops[randomInt(0, ops.length - 1)];
        const a = randomInt(min, max), b = randomInt(min, max);
        if (op === '+') return { q: `${a} + ${b} = ?`, a: String(a + b) };
        if (op === '-') return { q: `${a} ‚àí ${b} = ?`, a: String(a - b) };
        if (op === '√ó') return { q: `${a} √ó ${b} = ?`, a: String(a * b) };
        const d = randomInt(1, 12), res = randomInt(-12, 12), n = d * res;
        return { q: `${n} √∑ ${d} = ?`, a: String(res) };
      }

      function createQuestion() {
        if (state.moduleId === 'arith') return { ...createArithmeticQuestion(), rawOptions: null, html: '' };
        const mod = state.moduleMeta || getRegisteredModules().find((m) => m.id === state.moduleId);
        if (mod?.generator) {
          const q = mod.generator(state.moduleOptions || {}, state.difficulty);
          if (q?.q != null && q?.a != null) {
            if (Array.isArray(q.options) && q.options.length) {
              const idx = q.options.findIndex((op) => String(op).trim().toLowerCase() === String(q.a).trim().toLowerCase());
              const html = `<div class="ttm-choice-grid">${q.options.map((label, i) => `<div class="ttm-choice-item"><strong>${i + 1}.</strong> ${label}</div>`).join('')}</div>`;
              return { q: q.q, a: String(idx >= 0 ? idx + 1 : q.a), rawOptions: q.options.slice(), html: q.html || html };
            }
            return { q: q.q, a: String(q.a), rawOptions: null, html: q.html || '' };
          }
        }
        return { q: '2 + 2 = ?', a: '4', rawOptions: null, html: '' };
      }

      function setQuestion(teamKey) {
        const t = state.teams[teamKey];
        t.current = createQuestion();
        t.input = '';
        const questionEl = teamKey === 'blue' ? els.questionBlue : els.questionRed;
        const mediaEl = teamKey === 'blue' ? els.mediaBlue : els.mediaRed;
        const teamPanel = root.querySelector(`.ttm-team[data-team="${teamKey}"]`);
        if (questionEl) questionEl.textContent = t.current.q;
        if (mediaEl) mediaEl.innerHTML = t.current.html || '';
        if (teamPanel) teamPanel.classList.toggle('is-text-question', state.moduleId === 'cat-morf');
        renderTeamControls(teamKey);
      }

      function updateHud() {
        els.blueName.textContent = state.teams.blue.name;
        els.redName.textContent = state.teams.red.name;
        els.bluePanelTitle.textContent = state.teams.blue.name;
        els.redPanelTitle.textContent = state.teams.red.name;
        els.blueScore.textContent = String(state.teams.blue.score);
        els.redScore.textContent = String(state.teams.red.score);
        els.inputBlue.textContent = state.teams.blue.input || '0';
        els.inputRed.textContent = state.teams.red.input || '0';
        els.timer.textContent = formatTime(Math.max(0, state.timeLeft));
      }

      function renderShotState() {
        const canBlue = state.running && state.shooter === 'blue';
        const canRed = state.running && state.shooter === 'red';
        els.chipBlue.classList.toggle('is-active-shot', canBlue);
        els.chipRed.classList.toggle('is-active-shot', canRed);
        if (!state.running) return;
        if (canBlue) els.turnHint.textContent = `${state.teams.blue.name}: arrossega la xapa blava per xutar.`;
        else if (canRed) els.turnHint.textContent = `${state.teams.red.name}: arrossega la xapa vermella per xutar.`;
        else els.turnHint.textContent = 'Encerta una pregunta per fer un tir.';
      }

      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
      function refreshFieldSize() {
        const rect = els.field.getBoundingClientRect();
        state.field.w = Math.max(320, rect.width || 320);
        state.field.h = Math.max(240, rect.height || 240);
      }
      function resetField() {
        refreshFieldSize();
        const { w, h } = state.field;
        Object.assign(state.field.ball, { x: w / 2, y: h / 2, vx: 0, vy: 0 });
        Object.assign(state.field.blue, { x: w * 0.24, y: h / 2, vx: 0, vy: 0 });
        Object.assign(state.field.red, { x: w * 0.76, y: h / 2, vx: 0, vy: 0 });
        renderField();
      }
      function renderField() {
        const apply = (el, obj) => { if (el) { el.style.left = `${obj.x}px`; el.style.top = `${obj.y}px`; } };
        apply(els.ball, state.field.ball); apply(els.chipBlue, state.field.blue); apply(els.chipRed, state.field.red);
      }

      function bounce(obj) {
        const { w, h } = state.field;
        obj.x = clamp(obj.x, obj.r, w - obj.r);
        obj.y = clamp(obj.y, obj.r, h - obj.r);
        if (obj.x <= obj.r || obj.x >= w - obj.r) obj.vx *= -0.75;
        if (obj.y <= obj.r || obj.y >= h - obj.r) obj.vy *= -0.75;
      }
      function collideChipBall(chip) {
        const ball = state.field.ball;
        const dx = ball.x - chip.x, dy = ball.y - chip.y;
        const dist = Math.hypot(dx, dy) || 0.0001;
        const minDist = ball.r + chip.r;
        if (dist >= minDist) return;
        const nx = dx / dist, ny = dy / dist;
        const overlap = minDist - dist;
        ball.x += nx * overlap; ball.y += ny * overlap;
        const rel = (ball.vx - chip.vx) * nx + (ball.vy - chip.vy) * ny;
        if (rel < 0) {
          const impulse = -rel * 1.1;
          ball.vx += nx * impulse; ball.vy += ny * impulse;
          chip.vx -= nx * impulse * 0.45; chip.vy -= ny * impulse * 0.45;
        }
      }

      function checkGoal() {
        const { ball, h, w } = state.field;
        const top = h * 0.34, bottom = h * 0.66;
        if (ball.y < top || ball.y > bottom) return null;
        if (ball.x - ball.r <= 0) return 'red';
        if (ball.x + ball.r >= w) return 'blue';
        return null;
      }

      function stepPhysics() {
        if (!state.running) return;
        const objs = [state.field.blue, state.field.red, state.field.ball];
        objs.forEach((o) => { o.x += o.vx; o.y += o.vy; o.vx *= 0.985; o.vy *= 0.985; if (Math.abs(o.vx) < 0.02) o.vx = 0; if (Math.abs(o.vy) < 0.02) o.vy = 0; bounce(o); });
        collideChipBall(state.field.blue); collideChipBall(state.field.red);
        const scorer = checkGoal();
        renderField();
        if (scorer) endGame(scorer, 'goal');
      }

      function tick() {
        stepPhysics();
        state.frameId = requestAnimationFrame(tick);
      }

      function parseAnswer(v) { return String(v ?? '').replace(/\s+/g, '').replace(',', '.').toLowerCase(); }
      function handleAnswer(teamKey) {
        if (!state.running) return;
        const t = state.teams[teamKey];
        const expected = parseAnswer(t.current?.a);
        const got = parseAnswer(t.input);
        if (!expected || !got) return;
        if (expected === got || (isIntegerLike(expected) && isIntegerLike(got) && Number(expected) === Number(got))) {
          t.rawCorrect += 1;
          state.shooter = teamKey;
          setQuestion(teamKey);
          renderShotState();
          updateHud();
          return;
        }
        t.input = '';
        setQuestion(teamKey);
        updateHud();
      }

      function pushDigit(teamKey, value) {
        if (!state.running) return;
        state.teams[teamKey].input += String(value);
        updateHud();
      }
      function buildKeypad(teamKey, container) {
        ['7','8','9','4','5','6','1','2','3','0'].forEach((digit) => {
          const b = document.createElement('button'); b.type = 'button'; b.className = 'ttm-key'; b.textContent = digit;
          b.addEventListener('click', () => pushDigit(teamKey, digit)); container.appendChild(b);
        });
        const minus = document.createElement('button'); minus.type='button'; minus.className='ttm-key ttm-key--minus'; minus.textContent='‚àí';
        minus.addEventListener('click',()=>{ if(state.moduleId!=='arith' || !state.running) return; const t=state.teams[teamKey]; t.input = t.input.startsWith('-') ? t.input.slice(1) : `-${t.input}`; updateHud(); });
        const clear = document.createElement('button'); clear.type='button'; clear.className='ttm-key ttm-key--clear'; clear.textContent='Esborrar'; clear.addEventListener('click',()=>{ state.teams[teamKey].input=''; updateHud(); });
        const send = document.createElement('button'); send.type='button'; send.className='ttm-key ttm-key--send'; send.textContent='Enviar'; send.addEventListener('click',()=>handleAnswer(teamKey));
        container.append(minus, clear, send);
      }
      function renderTeamControls(teamKey) {
        const container = root.querySelector(`.ttm-keypad[data-keypad="${teamKey}"]`);
        const inputEl = teamKey === 'blue' ? els.inputBlue : els.inputRed;
        if (!container) return;
        const current = state.teams[teamKey].current;
        const hasChoices = state.moduleId === 'cat-morf' && Array.isArray(current?.rawOptions) && current.rawOptions.length;
        if (hasChoices) {
          container.classList.add('is-choices'); container.innerHTML = '';
          current.rawOptions.forEach((label, i) => {
            const btn = document.createElement('button'); btn.type='button'; btn.className='ttm-choice-btn'; btn.textContent=`${i + 1}. ${label}`;
            btn.addEventListener('click',()=>{ if(!state.running) return; state.teams[teamKey].input=String(i+1); handleAnswer(teamKey); });
            container.appendChild(btn);
          });
          if (inputEl) inputEl.style.display = 'none';
          return;
        }
        container.classList.remove('is-choices'); container.innerHTML=''; if (inputEl) inputEl.style.display='block'; buildKeypad(teamKey, container);
      }

      function prepareTournament(players, size) {
        const pool = players.slice(0, size);
        state.tournament = { round: 1, queue: pool, winners: [], pairIndex: 0, awaitingNext: false };
      }
      function setupMatchNames() {
        if (state.gameMode !== 'champ' || !state.tournament) return true;
        const t = state.tournament;
        if (t.queue.length < 2) return false;
        state.teams.blue.name = t.queue.shift();
        state.teams.red.name = t.queue.shift();
        return true;
      }
      function advanceTournament(winnerName) {
        const t = state.tournament;
        if (!t) return { finished: true, champion: winnerName };
        t.winners.push(winnerName);
        if (t.queue.length >= 2) {
          return { finished: false, next: true };
        }
        if (t.winners.length === 1) return { finished: true, champion: t.winners[0] };
        t.queue = t.winners.slice();
        t.winners = [];
        t.round += 1;
        return { finished: false, next: true };
      }

      function startGame() {
        clearInterval(state.timerId);
        if (!setupMatchNames()) return;
        state.running = true;
        state.timeLeft = DURATION;
        state.shooter = null;
        state.teams.blue.score = 0; state.teams.red.score = 0;
        state.teams.blue.rawCorrect = 0; state.teams.red.rawCorrect = 0;
        els.modal.hidden = true; els.result.hidden = true;
        setQuestion('blue'); setQuestion('red');
        resetField(); updateHud(); renderShotState();
        state.timerId = setInterval(() => {
          if (!state.running) return;
          state.timeLeft -= 1; updateHud();
          if (state.timeLeft <= 0) {
            const winner = state.teams.blue.rawCorrect === state.teams.red.rawCorrect ? null : (state.teams.blue.rawCorrect > state.teams.red.rawCorrect ? 'blue' : 'red');
            endGame(winner, 'time');
          }
        }, 1000);
      }

      function endGame(winnerTeam, reason) {
        if (!state.running) return;
        state.running = false;
        clearInterval(state.timerId);
        state.shooter = null;
        let winnerName = 'Empat';
        if (winnerTeam && state.teams[winnerTeam]) {
          state.teams[winnerTeam].score = 1;
          winnerName = state.teams[winnerTeam].name;
        }
        updateHud(); renderShotState();

        if (state.gameMode === 'champ' && winnerTeam) {
          const progress = advanceTournament(winnerName);
          if (progress.finished) {
            els.winnerTitle.textContent = `Campi√≥/na: ${progress.champion}`;
            els.winnerStats.textContent = `Campionat completat en mode eliminat√≤ries.`;
            els.restartBtn.textContent = 'Nou campionat';
            state.tournament = null;
          } else {
            state.tournament.awaitingNext = true;
            els.winnerTitle.textContent = `Guanya ${winnerName}`;
            els.winnerStats.textContent = 'Preparats per a la seg√ºent eliminat√≤ria.';
            els.restartBtn.textContent = 'Seg√ºent eliminat√≤ria';
          }
        } else {
          els.winnerTitle.textContent = winnerTeam ? `Gol de ${winnerName}!` : 'Temps esgotat';
          els.winnerStats.textContent = reason === 'goal' ? 'Partida acabada al primer gol.' : 'S ha acabat el temps de joc.';
          els.restartBtn.textContent = 'Tornar a jugar';
        }
        els.result.hidden = false;
      }

      function setupChipDrag(teamKey, chipEl) {
        chipEl.addEventListener('pointerdown', (ev) => {
          if (!state.running || state.shooter !== teamKey) return;
          const chip = state.field[teamKey];
          state.drag = { teamKey, startX: ev.clientX, startY: ev.clientY, chipStartX: chip.x, chipStartY: chip.y };
          chipEl.setPointerCapture(ev.pointerId);
        });
        chipEl.addEventListener('pointermove', (ev) => {
          if (!state.drag || state.drag.teamKey !== teamKey) return;
          const chip = state.field[teamKey];
          const dx = ev.clientX - state.drag.startX, dy = ev.clientY - state.drag.startY;
          chip.x = clamp(state.drag.chipStartX + dx, chip.r, state.field.w - chip.r);
          chip.y = clamp(state.drag.chipStartY + dy, chip.r, state.field.h - chip.r);
          renderField();
        });
        chipEl.addEventListener('pointerup', (ev) => {
          if (!state.drag || state.drag.teamKey !== teamKey) return;
          const chip = state.field[teamKey];
          const dx = ev.clientX - state.drag.startX, dy = ev.clientY - state.drag.startY;
          chip.vx = clamp((state.drag.startX - ev.clientX) * 0.16, -14, 14);
          chip.vy = clamp((state.drag.startY - ev.clientY) * 0.16, -14, 14);
          state.drag = null;
          state.shooter = null;
          renderShotState();
        });
      }

      els.moduleSelect?.addEventListener('change', () => {
        state.moduleId = els.moduleSelect.value || 'arith';
        state.moduleMeta = getRegisteredModules().find((m) => m.id === state.moduleId) || null;
        renderModuleConfigFields();
      });
      els.modeButtons.forEach((btn) => btn.addEventListener('click', () => { state.gameMode = btn.dataset.mode === 'champ' ? 'champ' : 'duel'; applyGameModeUi(); }));
      els.bracketSize?.addEventListener('change', () => { state.bracketSize = Number(els.bracketSize.value || 4) === 8 ? 8 : 4; });
      els.levelButtons.forEach((btn) => btn.addEventListener('click', () => { state.difficulty = btn.dataset.level; els.levelButtons.forEach((b) => b.classList.toggle('is-selected', b === btn)); }));
      els.prevStep.addEventListener('click', () => { state.step = Math.max(1, state.step - 1); els.setupError.textContent = ''; updateStepUi(); });
      els.nextStep.addEventListener('click', () => {
        els.setupError.textContent = '';
        if (state.step < 3) { state.step += 1; updateStepUi(); return; }
        readModuleOptions();
        if (state.gameMode === 'champ') {
          const size = Number(els.bracketSize?.value || 4); state.bracketSize = size === 8 ? 8 : 4;
          const players = (els.participantsInput.value || '').split('\n').map((v) => v.trim()).filter(Boolean);
          if (players.length < state.bracketSize) { els.setupError.textContent = `Calen ${state.bracketSize} participants per al campionat.`; return; }
          prepareTournament(players, state.bracketSize);
          startGame();
          return;
        }
        const blue = (els.blueNameInput.value || '').trim() || 'Equip blau';
        const red = (els.redNameInput.value || '').trim() || 'Equip vermell';
        if (blue.toLowerCase() === red.toLowerCase()) { els.setupError.textContent = 'Els equips han de tenir noms diferents.'; return; }
        state.teams.blue.name = blue; state.teams.red.name = red; state.tournament = null; startGame();
      });
      els.restartBtn.addEventListener('click', () => {
        if (state.gameMode === 'champ' && state.tournament?.awaitingNext) { state.tournament.awaitingNext = false; startGame(); return; }
        state.running = false; clearInterval(state.timerId); state.step = 1; state.timeLeft = DURATION; state.tournament = null;
        els.result.hidden = true; els.modal.hidden = false; updateStepUi(); updateHud(); renderShotState(); resetField();
      });
      els.exitBtn?.addEventListener('click', () => {
        state.running = false; clearInterval(state.timerId); state.step = 1; state.timeLeft = DURATION; state.tournament = null;
        els.result.hidden = true; els.modal.hidden = false; updateStepUi(); updateHud(); renderShotState(); resetField();
        if (typeof showView === 'function') showView('home');
      });

      setupChipDrag('blue', els.chipBlue);
      setupChipDrag('red', els.chipRed);
      window.addEventListener('resize', resetField);

      populateModuleOptions();
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', populateModuleOptions, { once: true });
      else setTimeout(populateModuleOptions, 50);
      state.frameId = requestAnimationFrame(tick);
      updateStepUi(); updateHud(); renderShotState(); resetField();
    })();
  </script>

  <!-- üîπ L√≤gica principal i generadors de matem√†tiques -->
  <script type="module" src="supabase/student-sync.js"></script>
  <script src="main.js" defer></script>
  <script src="math.js" defer></script>
</body>
</html>
