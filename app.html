<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Focus Academy ¬∑ Espai de rep√†s</title>
  <meta name="description" content="Pr√†ctiques de matem√†tiques per a estudiants. Single-file, sense depend√®ncies." />
  <link rel="stylesheet" href="style.css">

  <style>
    /* ===== Reptes: Tira-corda matem√†tic ===== */
    .challenge-section { margin-top: 1rem; }
    .challenge-wrap { border: 1px solid #d7dff5; border-radius: 18px; padding: 1rem; background: #fff; position: relative; overflow: hidden; }
    .challenge-header { display: grid; gap: .4rem; margin-bottom: .9rem; }
    .challenge-header h2 { margin: 0; }
    .challenge-menu { display: flex; flex-wrap: wrap; gap: .5rem; margin-bottom: 1rem; }
    .challenge-chip { border: 1px solid #c8d3f6; background: #eef3ff; color: #24449a; border-radius: 999px; padding: .45rem .8rem; font-weight: 700; }
    .challenge-chip[disabled] { opacity: .55; }

    .ttm-modal { position: absolute; inset: 0; background: rgba(10, 16, 35, .72); display: grid; place-items: center; z-index: 10; }
    .ttm-modal[hidden] { display: none; }
    .ttm-card { width: min(700px, calc(100% - 2rem)); background: #fff; border-radius: 16px; padding: 1rem; box-shadow: 0 20px 40px rgba(16, 23, 46, .28); }
    .ttm-step { display: none; margin-top: .8rem; }
    .ttm-step.is-active { display: block; }
    .ttm-title { margin: 0; }
    .ttm-step-label { margin: 0 0 .2rem; color: #4863d9; font-weight: 700; font-size: .9rem; }
    .ttm-grid4 { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: .5rem; }
    .ttm-grid3 { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: .5rem; }
    .ttm-op, .ttm-level { border: 1px solid #c6d1f0; background: #f6f9ff; border-radius: 10px; padding: .65rem; font-weight: 700; cursor: pointer; transition: .2s ease; }
    .ttm-op:hover, .ttm-level:hover { transform: translateY(-1px); }
    .ttm-op.is-active { background: #e7eeff; border-color: #5472e4; color: #2e48ad; }
    .ttm-level.is-selected { background: #ffeecf; border-color: #f4b23f; }
    .ttm-team-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: .8rem; }
    .ttm-team-inputs label { display: grid; gap: .35rem; font-weight: 600; }
    .ttm-team-inputs input { border: 1px solid #cbd7f6; border-radius: 10px; padding: .6rem .7rem; }
    .ttm-actions { margin-top: .9rem; display: flex; justify-content: space-between; gap: .5rem; }
    .ttm-error { min-height: 1.2rem; color: #b42318; margin-top: .4rem; }

    .ttm-hud { display: grid; grid-template-columns: 1fr auto 1fr; gap: .6rem; align-items: center; margin-bottom: .8rem; }
    .ttm-score { display: flex; justify-content: space-between; align-items: center; border-radius: 11px; padding: .6rem .75rem; background: #f2f4f8; }
    .ttm-score--blue { border: 1px solid #9fc1ff; color: #174b9d; }
    .ttm-score--red { border: 1px solid #ffb4bc; color: #9e1f34; }
    .ttm-timer { font-weight: 800; letter-spacing: .05em; border-radius: 999px; background: #111827; color: #fff; padding: .45rem .8rem; }

    .ttm-rope-zone { margin-bottom: .8rem; }
    .ttm-track { position: relative; height: 44px; border-radius: 999px; background: linear-gradient(90deg, rgba(36,94,187,.11) 0%, #fff 50%, rgba(206,39,62,.11) 100%); border: 1px solid #d6def3; overflow: hidden; }
    .ttm-center { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; transform: translateX(-50%); background: #7f8db0; }
    .ttm-rope { position: absolute; left: 5%; right: 5%; top: 50%; height: 10px; transform: translateY(-50%); border-radius: 999px; background: repeating-linear-gradient(90deg, #8c5b2c 0 12px, #b27b45 12px 24px); }
    .ttm-flag { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); border-radius: 50%; background: #f0f4ff; border: 3px solid #4a63d1; transition: left .26s cubic-bezier(.22,.61,.36,1); }
    .ttm-labels { display: flex; justify-content: space-between; margin-top: .25rem; font-size: .83rem; }
    .ttm-labels .b { color: #1f5aba; font-weight: 700; }
    .ttm-labels .r { color: #bf2842; font-weight: 700; }

    .ttm-teams { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
    .ttm-team { border: 1px solid #d9e1f8; border-radius: 14px; padding: .8rem; background: #fbfdff; }
    .ttm-team--blue { box-shadow: inset 0 0 0 1px rgba(66,126,224,.12); }
    .ttm-team--red { box-shadow: inset 0 0 0 1px rgba(217,69,94,.14); }
    .ttm-question { font-size: 1.2rem; font-weight: 800; margin: .4rem 0; min-height: 1.5em; }
    .ttm-input { border: 1px dashed #b8c7ee; border-radius: 10px; background: #f3f7ff; padding: .5rem .6rem; font-family: ui-monospace, monospace; font-size: 1.1rem; margin-bottom: .5rem; min-height: 2rem; }
    .ttm-keypad { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: .35rem; }
    .ttm-key { border: 1px solid #c5d3f6; background: #fff; border-radius: 10px; padding: .5rem; font-weight: 700; cursor: pointer; transition: .18s ease; }
    .ttm-key:hover { transform: translateY(-1px); background: #eef4ff; }
    .ttm-key--clear { background: #ffe4e7; border-color: #ffc1ca; color: #8c1f32; }
    .ttm-key--send { grid-column: span 2; background: #2150ca; border-color: #2150ca; color: #fff; }

    .ttm-result { position: absolute; inset: 0; z-index: 12; display: grid; place-items: center; background: rgba(8, 12, 25, .72); }
    .ttm-result[hidden] { display: none; }
    .ttm-result-card { width: min(520px, calc(100% - 2rem)); background: #fff; border-radius: 16px; padding: 1rem; text-align: center; }

    @media (max-width: 960px) {
      .ttm-grid4 { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .ttm-grid3 { grid-template-columns: 1fr; }
      .ttm-team-inputs, .ttm-teams { grid-template-columns: 1fr; }
      .ttm-hud { grid-template-columns: 1fr; }
      .ttm-timer { justify-self: start; }
    }
  </style>

</head>
  <!-- LOGIN LOCAL (overlay) -->
<div id="loginOverlay" class="login-overlay" hidden>
  <div class="login-dialog">
    <h2 class="login-title">Accedeix a Focus Academy</h2>
    <p class="login-subtitle">Tria un usuari existent o escriu un nom nou: aix√≠ guardarem els ex√†mens i podr√†s veure els resultats nom√©s en aquest dispositiu.</p>

    <label class="login-label" for="loginUserList">Usuaris existents</label>
    <div class="login-row">
      <select id="loginUserList" class="login-select"></select>
      <button id="btnLoginSelect" class="pill login-small">Entrar</button>
    </div>

    <div class="login-divider" role="presentation"></div>

    <label class="login-label" for="newUserName">Crear nou usuari</label>
    <p class="login-help">Posa-hi un nom senzill (per exemple ¬´La classe de 4t¬ª o el teu nom) per recon√®ixer on guardem els ex√†mens i notes.</p>
    <input id="newUserName" class="login-input input" placeholder="Nom (m√≠nim 2 car√†cters)" />
    <div class="login-row">
      <button id="btnCreateUser" class="btn login-primary">Crea i entra</button>
      <button id="btnDeleteUser" class="btn-ghost login-ghost">Suprimeix seleccionat</button>
    </div>

    <div class="login-footer">
      <small>üí° Nom√©s cal posar un nom per tenir guardats els ex√†mens i consultar els resultats quan tornis. Tot queda en localStorage, sense servidors.</small>
    </div>
  </div>
</div>

<body class="home-page">
  <header class="topbar">
    <div class="wrap row header-bar">

      <!-- üîπ Marca -->
      <button class="brand brand-home" type="button" onclick="showView('home')" aria-label="Tornar a l'inici">
        <div class="logo">FQ</div>
        <h1>Focus Academy</h1>
      </button>

      <!-- üîπ Navegaci√≥ principal -->
      <nav class="main-nav" aria-label="Navegaci√≥ principal">
        <button class="pill nav-btn" type="button" onclick="scrollToSection('tutorSection')">Tutor</button>
        <button class="pill nav-btn" type="button" onclick="scrollToSection('calendarSection')">Calendari</button>
        <button class="pill nav-btn" type="button" onclick="scrollToSection('classSection')">Aula</button>
        <button class="pill nav-btn" type="button" onclick="scrollToSection('liveSection')">Live</button>
        <a class="pill nav-btn nav-btn-ghost" href="/portal/supabase-portal.html">Acc√©s professorat</a>
      </nav>

      <!-- üîπ Usuari actiu -->
      <div class="user-controls">
        <button id="activeUser" class="chip user-chip" type="button" aria-live="polite">
          üë§ <span class="label">Sessi√≥ no iniciada</span>
        </button>
        <button id="switchUserBtn" class="pill small" type="button">Canvia</button>
        <button id="logoutBtn" class="pill small" type="button">Surt</button>
      </div>

    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="view-home" class="hero">
      <div class="panel card">
        <h2 class="title">Benvingut/da! üëã</h2>
        <p class="subtitle">Tria un m√≤dul per configurar-lo i comen√ßar. Tot queda guardat en aquest dispositiu (sense comptes).</p>

        <div id="moduleGrid"></div>

        <!-- üß† Consell del tutor -->
        <div id="tutorSection" class="panel card tutor-card">
          <h3 class="title tutor-title">Consell del teu tutor virtual ü§ñ</h3>
          <div id="recommendationText" class="subtitle">Carregant recomanaci√≥...</div>
          <div class="tutor-actions">
          </div>
        </div>

        <section id="calendarSection" class="panel card study-calendar" aria-labelledby="studyCalendarTitle">
          <div class="study-calendar__header">
            <div>
              <p class="portal-section-title">Calendari d'estudi</p>
              <h2 id="studyCalendarTitle">Apunta tasques, ex√†mens i recordatoris</h2>
              <p class="subtitle">Un espai perqu√® l'alumnat pugui organitzar-se i afegir una descripci√≥ clara de cada esdeveniment.</p>
            </div>
            <div class="study-calendar__actions">
              <button class="pill" id="studyCalendarAddShortcut" type="button">+ Afegir</button>
              <button class="btn-ghost" id="studyCalendarToday" type="button">Avui</button>
            </div>
          </div>

          <div class="study-calendar__layout">
            <div class="study-calendar__board">
              <div class="study-calendar__month">
                <button class="btn-ghost" id="studyCalendarPrev" type="button" aria-label="Mes anterior">‚Üê</button>
                <div class="study-calendar__month-title">
                  <span data-calendar-month>Setembre 2024</span>
                  <strong>Vista mensual</strong>
                </div>
                <button class="btn-ghost" id="studyCalendarNext" type="button" aria-label="Mes seg√ºent">‚Üí</button>
              </div>

              <div class="study-calendar__legend">
                <span class="study-calendar__pill is-homework">Deures</span>
                <span class="study-calendar__pill is-exam">Examen</span>
                <span class="study-calendar__pill is-reminder">Recordatori</span>
              </div>

              <div class="study-calendar__weekdays">
                <span>Dl</span>
                <span>Dt</span>
                <span>Dc</span>
                <span>Dj</span>
                <span>Dv</span>
                <span>Ds</span>
                <span>Dg</span>
              </div>

              <div id="studyCalendarGrid" class="study-calendar__grid"></div>
            </div>

            <aside class="study-calendar__details">
              <div class="study-calendar__details-header">
                <div>
                  <p class="portal-section-title">Fitxa del dia</p>
                  <h3 id="studyCalendarSelectedDate">Selecciona un dia</h3>
                </div>
                <span class="study-calendar__badge" id="studyCalendarSelectedBadge">--</span>
              </div>
              <div class="study-calendar__details-card">
                <label class="study-calendar__label">
                  <span>Qu√® tens?</span>
                  <input class="input" id="studyCalendarTitleInput" type="text" placeholder="Examen, treball, recordatori..." />
                </label>
                <label class="study-calendar__label">
                  <span>Tipus</span>
                  <select class="input" id="studyCalendarTypeInput">
                    <option value="homework">Deures</option>
                    <option value="exam">Examen</option>
                    <option value="reminder">Recordatori</option>
                  </select>
                </label>
                <label class="study-calendar__label">
                  <span>Descripci√≥</span>
                  <textarea class="input" id="studyCalendarDescriptionInput" rows="5" placeholder="Detalla qu√® cal preparar, material, passos..."></textarea>
                </label>
                <div class="study-calendar__details-actions">
                  <button class="btn-primary" id="studyCalendarAddButton" type="button">Afegir</button>
                  <button class="btn-secondary" id="studyCalendarClearButton" type="button">Neteja</button>
                </div>
              </div>
              <div class="study-calendar__list">
                <h4>Esdeveniments del dia</h4>
                <p id="studyCalendarEmpty" class="study-calendar__empty">Encara no hi ha res programat per aquest dia.</p>
                <ul id="studyCalendarList" class="study-calendar__list-items"></ul>
              </div>
            </aside>
          </div>
        </section>


        <section id="challengesSection" class="panel card challenge-section" aria-labelledby="challengesTitle">
          <div class="challenge-header">
            <p class="portal-section-title">Reptes</p>
            <h2 id="challengesTitle">Jocs per competir en equip</h2>
            <p class="subtitle">Tria un joc del men√∫. Primer disponible: <strong>Tira-corda matem√†tic</strong>.</p>
          </div>

          <div class="challenge-menu" aria-label="Men√∫ de reptes">
            <button class="challenge-chip" type="button" data-challenge="tug" aria-current="true">ü™¢ Tira-corda matem√†tic</button>
            <button class="challenge-chip" type="button" disabled>üß© Properament</button>
            <button class="challenge-chip" type="button" disabled>üéØ Properament</button>
          </div>

          <div class="challenge-wrap" id="ttmGame" data-challenge-panel="tug">
            <!-- Modal de configuraci√≥ inicial (3 passos) -->
            <div class="ttm-modal" id="ttmModal" role="dialog" aria-modal="true" aria-labelledby="ttmSetupTitle">
              <div class="ttm-card">
                <p class="ttm-step-label" id="ttmStepLabel">Pas 1 de 3</p>
                <h3 id="ttmSetupTitle" class="ttm-title">Configuraci√≥ del tira-corda matem√†tic</h3>

                <div class="ttm-step is-active" data-step="1">
                  <p><strong>Selecciona operacions</strong></p>
                  <div class="ttm-grid4">
                    <button type="button" class="ttm-op is-active" data-op="add">+</button>
                    <button type="button" class="ttm-op is-active" data-op="sub">‚àí</button>
                    <button type="button" class="ttm-op is-active" data-op="mul">√ó</button>
                    <button type="button" class="ttm-op is-active" data-op="div">√∑</button>
                  </div>
                  <p class="subtitle">Activa almenys una operaci√≥.</p>
                </div>

                <div class="ttm-step" data-step="2">
                  <p><strong>Nivell de dificultat</strong></p>
                  <div class="ttm-grid3">
                    <button type="button" class="ttm-level is-selected" data-level="easy">üü¢ F√†cil</button>
                    <button type="button" class="ttm-level" data-level="medium">üü° Mitj√†</button>
                    <button type="button" class="ttm-level" data-level="hard">üî¥ Dif√≠cil</button>
                  </div>
                </div>

                <div class="ttm-step" data-step="3">
                  <p><strong>Nom dels equips</strong></p>
                  <div class="ttm-team-inputs">
                    <label>Equip 1 (blau)
                      <input id="ttmBlueNameInput" type="text" maxlength="20" placeholder="Ex: Dracs blaus" />
                    </label>
                    <label>Equip 2 (vermell)
                      <input id="ttmRedNameInput" type="text" maxlength="20" placeholder="Ex: Flames roges" />
                    </label>
                  </div>
                </div>

                <p id="ttmSetupError" class="ttm-error" aria-live="polite"></p>
                <div class="ttm-actions">
                  <button class="btn-ghost" type="button" id="ttmPrevStep">Anterior</button>
                  <button class="pill" type="button" id="ttmNextStep">Seg√ºent</button>
                </div>
              </div>
            </div>

            <div class="ttm-hud">
              <div class="ttm-score ttm-score--blue"><strong id="ttmBlueName">Equip blau</strong><span>‚úÖ <span id="ttmBlueScore">0</span></span></div>
              <div class="ttm-timer" id="ttmTimer">02:00</div>
              <div class="ttm-score ttm-score--red"><strong id="ttmRedName">Equip vermell</strong><span>‚úÖ <span id="ttmRedScore">0</span></span></div>
            </div>

            <div class="ttm-rope-zone" aria-label="Corda del tira-corda">
              <div class="ttm-track">
                <div class="ttm-center"></div>
                <div class="ttm-rope"></div>
                <div class="ttm-flag" id="ttmFlag"></div>
              </div>
              <div class="ttm-labels"><span class="b">Camp blau</span><span class="r">Camp vermell</span></div>
            </div>

            <div class="ttm-teams">
              <section class="ttm-team ttm-team--blue" data-team="blue">
                <h3 id="ttmBluePanelTitle">Equip blau</h3>
                <p class="ttm-question" id="ttmQuestionBlue">Esperant inici...</p>
                <div class="ttm-input" id="ttmInputBlue">0</div>
                <div class="ttm-keypad" data-keypad="blue"></div>
              </section>

              <section class="ttm-team ttm-team--red" data-team="red">
                <h3 id="ttmRedPanelTitle">Equip vermell</h3>
                <p class="ttm-question" id="ttmQuestionRed">Esperant inici...</p>
                <div class="ttm-input" id="ttmInputRed">0</div>
                <div class="ttm-keypad" data-keypad="red"></div>
              </section>
            </div>

            <div class="ttm-result" id="ttmResult" hidden>
              <div class="ttm-result-card">
                <p class="portal-section-title">Partida finalitzada</p>
                <h3 id="ttmWinnerTitle">Guanya l'equip blau!</h3>
                <p id="ttmWinnerStats"></p>
                <button class="pill" type="button" id="ttmRestartBtn">Tornar a jugar</button>
              </div>
            </div>
          </div>
        </section>


        <section id="classSection" class="panel card home-live-cta home-class-cta" aria-labelledby="homeClassTitle">
          <div class="home-live-cta__body">
            <p class="portal-section-title">Aula FocusQuiz</p>
            <h2 id="homeClassTitle">Has rebut un codi de prova?</h2>
            <p class="subtitle">Escriu el codi que t'ha donat el professorat i entra directament a l'espai de proves.</p>
            <form id="classCodeForm" class="home-live-join-form" autocomplete="off">
              <label class="portal-field-label" for="classCodeInput">Codi del test</label>
              <div class="home-live-join-controls">
                <input
                  id="classCodeInput"
                  class="input"
                  type="text"
                  name="classCode"
                  minlength="4"
                  maxlength="12"
                  required
                  placeholder="Exemple: TR01A2"
                  aria-describedby="classCodeHelp"
                />
                <button class="pill" type="submit">Entra a l'aula</button>
              </div>
              <p id="classCodeHelp" class="home-live-join-hint">
                Els tests FocusQuiz ara es fan a l'espai d'aula. Escriu el codi que t'ha donat el teu professorat.
              </p>
            </form>
          </div>
          <div class="home-live-cta__art home-class-cta__art" aria-hidden="true"></div>
        </section>

        <section id="liveSection" class="panel card home-live-cta" aria-labelledby="homeLiveTitle">
          <div class="home-live-cta__body">
            <p class="portal-section-title">Partides Live</p>
            <h2 id="homeLiveTitle">Tens un codi FocusQuiz?</h2>
            <p class="subtitle">Escriu el codi que t'ha compartit el professorat i entra directament a la partida en viu.</p>
            <form id="homeLiveJoinForm" class="home-live-join-form" autocomplete="off">
              <label class="portal-field-label" for="homeLiveJoinCode">Codi de partida</label>
              <div class="home-live-join-controls">
                <input
                  id="homeLiveJoinCode"
                  class="input"
                  type="text"
                  name="code"
                  minlength="4"
                  maxlength="8"
                  required
                  placeholder="Exemple: 72F8FE"
                />
                <button class="pill" type="submit">Unir-me</button>
              </div>
              <p class="home-live-join-hint">Et portarem a la sala de joc i nom√©s haur√†s d'introduir el teu nom.</p>
            </form>
          </div>
          <div class="home-live-cta__art" aria-hidden="true"></div>
        </section>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            // üîπ Mostra recomanaci√≥ del tutor
            showRecommendation('#recommendationText');

            const dropdown = document.querySelector('[data-nav-dropdown]');
            if (dropdown) {
              const summary = dropdown.querySelector('summary');
              const closeDropdown = () => {
                dropdown.open = false;
                if (summary) summary.focus();
              };

              dropdown.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && dropdown.open) {
                  event.preventDefault();
                  closeDropdown();
                }
              });

              document.addEventListener('click', (event) => {
                if (!dropdown.contains(event.target)) dropdown.open = false;
              });

              if (summary) {
                summary.addEventListener('keydown', (event) => {
                  if (event.key === ' ' || event.key === 'Enter') {
                    event.preventDefault();
                    dropdown.open = !dropdown.open;
                  }
                });
              }

              dropdown.addEventListener('toggle', () => {
                if (summary) summary.setAttribute('aria-expanded', dropdown.open ? 'true' : 'false');
              });

              if (summary) summary.setAttribute('aria-expanded', dropdown.open ? 'true' : 'false');
            }

            // üîπ Mostra l'usuari actiu (si n'hi ha)
            const current = localStorage.getItem('lastStudent');
            const badge = document.getElementById('activeUser');
            if (badge) {
              const label = badge.querySelector('.label');
              if (label) label.textContent = current || 'Sessi√≥ no iniciada';
              badge.classList.toggle('is-empty', !current);
            }

            const form = document.getElementById('classCodeForm');
            if (form) {
              form.addEventListener('submit', (event) => {
                event.preventDefault();
                const input = document.getElementById('classCodeInput');
                if (!input) return;
                const code = (input.value || '').trim().toUpperCase();
                if (!code) {
                  input.focus();
                  return;
                }
                const target = new URL('class.html', window.location.href);
                target.searchParams.set('code', code);
                window.location.href = target.toString();
              });
            }

            const calendarSection = document.querySelector('.study-calendar');
            if (calendarSection) {
              const storagePrefix = 'focusquiz.studyCalendar';
              const getStorageKey = () => `${storagePrefix}.${localStorage.getItem('lastStudent') || 'default'}`;
              let storageKey = getStorageKey();
              const addShortcut = document.getElementById('studyCalendarAddShortcut');
              const todayButton = document.getElementById('studyCalendarToday');
              const prevButton = document.getElementById('studyCalendarPrev');
              const nextButton = document.getElementById('studyCalendarNext');
              const monthLabel = calendarSection.querySelector('[data-calendar-month]');
              const grid = document.getElementById('studyCalendarGrid');
              const titleInput = document.getElementById('studyCalendarTitleInput');
              const typeInput = document.getElementById('studyCalendarTypeInput');
              const descInput = document.getElementById('studyCalendarDescriptionInput');
              const addButton = document.getElementById('studyCalendarAddButton');
              const clearButton = document.getElementById('studyCalendarClearButton');
              const selectedDateLabel = document.getElementById('studyCalendarSelectedDate');
              const selectedBadge = document.getElementById('studyCalendarSelectedBadge');
              const list = document.getElementById('studyCalendarList');
              const emptyState = document.getElementById('studyCalendarEmpty');
              let cells = [];
              let selectedDate = null;
              let eventsByDate = {};
              let editingIndex = null;
              let currentMonth = new Date();
              currentMonth.setDate(1);

              const loadEvents = () => {
                try {
                  eventsByDate = JSON.parse(localStorage.getItem(storageKey)) || {};
                } catch (error) {
                  eventsByDate = {};
                }
              };

              loadEvents();

              const typeLabels = {
                homework: 'Deures',
                exam: 'Examen',
                reminder: 'Recordatori'
              };

              const formatDate = (value) => {
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) return value;
                return parsed.toLocaleDateString('ca-ES', { weekday: 'short', day: 'numeric', month: 'long' });
              };

              const formatISO = (date) => date.toISOString().slice(0, 10);

              const setSelectedDate = (value) => {
                selectedDate = value;
                cells.forEach(cell => cell.classList.toggle('is-selected', cell.dataset.date === value));
                if (selectedDateLabel) selectedDateLabel.textContent = formatDate(value);
                if (selectedBadge) selectedBadge.textContent = value || '--';
                renderDetails();
              };

              const ensureSelectedDate = () => {
                if (!cells.length) return;
                const todayIso = formatISO(new Date());
                const todayCell = cells.find(cell => cell.dataset.date === todayIso);
                const monthCell = cells.find(cell => cell.dataset.inMonth === 'true');
                const hasSelected = cells.some(cell => cell.dataset.date === selectedDate);
                if (hasSelected && selectedDate) {
                  setSelectedDate(selectedDate);
                  return;
                }
                const fallback = todayCell || monthCell || cells[0];
                if (fallback) setSelectedDate(fallback.dataset.date);
              };

              const persist = () => {
                localStorage.setItem(storageKey, JSON.stringify(eventsByDate));
              };

              const syncWithActiveUser = () => {
                storageKey = getStorageKey();
                loadEvents();
                renderCells();
                renderDetails();
              };

              const renderMonthGrid = () => {
                if (!grid) return;
                if (monthLabel) {
                  monthLabel.textContent = currentMonth.toLocaleDateString('ca-ES', { month: 'long', year: 'numeric' });
                }

                grid.innerHTML = '';
                cells = [];

                const startOfMonth = new Date(currentMonth);
                startOfMonth.setDate(1);
                const startOffset = (startOfMonth.getDay() + 6) % 7;
                const totalCells = 42;

                for (let index = 0; index < totalCells; index++) {
                  const dayNumber = index - startOffset + 1;
                  const cellDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), dayNumber);
                  const isCurrentMonth = cellDate.getMonth() === currentMonth.getMonth();
                  const button = document.createElement('button');
                  button.className = 'study-calendar__cell';
                  if (!isCurrentMonth) button.classList.add('is-outside');
                  if (isCurrentMonth) button.dataset.inMonth = 'true';
                  button.dataset.date = formatISO(cellDate);
                  button.innerHTML = `
                    <span class="study-calendar__date">${cellDate.getDate()}</span>
                    <span class="study-calendar__events"></span>
                  `;
                  button.addEventListener('click', () => setSelectedDate(button.dataset.date));
                  grid.appendChild(button);
                  cells.push(button);
                }

                ensureSelectedDate();
                renderCells();
              };

              const renderCells = () => {
                const today = formatISO(new Date());
                cells.forEach(cell => {
                  const date = cell.dataset.date;
                  const container = cell.querySelector('.study-calendar__events');
                  cell.classList.toggle('is-today', date === today);
                  if (!container) return;
                  container.innerHTML = '';
                  const items = eventsByDate[date] || [];
                  items.slice(0, 2).forEach(item => {
                    const badge = document.createElement('span');
                    badge.className = `study-calendar__event is-${item.type}`;
                    badge.textContent = item.title;
                    container.appendChild(badge);
                  });
                  if (items.length > 2) {
                    const more = document.createElement('span');
                    more.className = 'study-calendar__more';
                    more.textContent = `+${items.length - 2}`;
                    container.appendChild(more);
                  }
                  if (items.length > 0) {
                    const count = document.createElement('span');
                    count.className = 'study-calendar__count';
                    count.textContent = items.length;
                    container.appendChild(count);
                  }
                });
              };

              const renderDetails = () => {
                const items = eventsByDate[selectedDate] || [];
                list.innerHTML = '';
                if (items.length === 0) {
                  emptyState.classList.remove('hidden');
                  editingIndex = null;
                  addButton.textContent = 'Afegir';
                  return;
                }
                emptyState.classList.add('hidden');
                items.forEach((item, index) => {
                  const li = document.createElement('li');
                  li.className = 'study-calendar__list-item';
                  li.innerHTML = `
                    <div>
                      <p class="study-calendar__list-title">${item.title}</p>
                      <p class="study-calendar__list-meta">${typeLabels[item.type] || 'Apunt'} ¬∑ ${item.description || 'Sense descripci√≥'}</p>
                    </div>
                    <div class="study-calendar__list-actions">
                      <button class="btn-ghost" type="button" data-edit-index="${index}">Edita</button>
                      <button class="btn-ghost" type="button" data-remove-index="${index}">Elimina</button>
                    </div>
                  `;
                  list.appendChild(li);
                });
              };

              const addEvent = () => {
                if (!selectedDate || !titleInput.value.trim()) {
                  titleInput.focus();
                  return;
                }
                const entry = {
                  title: titleInput.value.trim(),
                  description: descInput.value.trim(),
                  type: typeInput.value
                };
                eventsByDate[selectedDate] = eventsByDate[selectedDate] || [];
                if (editingIndex !== null) {
                  eventsByDate[selectedDate][editingIndex] = entry;
                  editingIndex = null;
                  addButton.textContent = 'Afegir';
                } else {
                  eventsByDate[selectedDate].push(entry);
                }
                persist();
                renderCells();
                renderDetails();
                titleInput.value = '';
                descInput.value = '';
                titleInput.focus();
              };

              const clearForm = () => {
                titleInput.value = '';
                descInput.value = '';
                typeInput.value = 'homework';
                editingIndex = null;
                addButton.textContent = 'Afegir';
              };

              const goToToday = () => {
                const today = new Date();
                const formatted = formatISO(today);
                currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                renderMonthGrid();
                const todayCell = cells.find(cell => cell.dataset.date === formatted);
                if (todayCell) {
                  setSelectedDate(formatted);
                  todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
              };

              list.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                if (target.dataset.editIndex !== undefined) {
                  const index = Number(target.dataset.editIndex);
                  const items = eventsByDate[selectedDate] || [];
                  const current = items[index];
                  if (!current) return;
                  editingIndex = index;
                  titleInput.value = current.title;
                  descInput.value = current.description || '';
                  typeInput.value = current.type || 'homework';
                  addButton.textContent = 'Desa canvis';
                  titleInput.focus();
                  return;
                }
                const removeIndex = target.dataset.removeIndex;
                if (removeIndex === undefined) return;
                const items = eventsByDate[selectedDate] || [];
                items.splice(Number(removeIndex), 1);
                if (items.length === 0) {
                  delete eventsByDate[selectedDate];
                }
                persist();
                renderCells();
                renderDetails();
              });

              addButton.addEventListener('click', addEvent);
              addShortcut.addEventListener('click', addEvent);
              clearButton.addEventListener('click', clearForm);
              todayButton.addEventListener('click', goToToday);

              prevButton?.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderMonthGrid();
              });

              nextButton?.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderMonthGrid();
              });

              document.addEventListener('focusquiz:user-login', syncWithActiveUser);
              document.addEventListener('focusquiz:user-logout', syncWithActiveUser);

              renderMonthGrid();
            }
          });
        </script>
      </div>
    </section>
    <!-- CONFIG -->
    <section id="view-config" class="hidden">
      <div class="panel card">
        <div class="row" style="align-items:center">
          <div>
            <h2 class="title" id="cfg-title" style="margin:0">Configura el m√≤dul</h2>
            <p class="subtitle" id="cfg-desc"></p>
          </div>
          <div class="controls">
            <button class="btn-secondary" onclick="showView('home')">‚Üê Torna</button>
            <button onclick="startFromConfig()">Comen√ßa</button>
          </div>
        </div>

        <div class="section-title">Opcions comunes</div>
        <div class="controls">
          <label class="field chip">Preguntes
            <select id="cfg-count">
              <option>10</option><option>20</option><option>30</option><option>50</option>
            </select>
          </label>
          <label class="field chip">Temps (min)
            <select id="cfg-time">
              <option value="0">Sense l√≠mit</option><option>5</option><option>10</option><option>15</option><option>20</option>
            </select>
          </label>
          <label class="field chip" id="cfg-level-wrap">Nivell (1‚Äì4)
            <select id="cfg-level"></select>
          </label>
        </div>

        <div id="cfg-specific"></div>
      </div>
    </section>

   <!-- QUIZ -->
<section id="view-quiz" class="hidden">
  <div class="quiz">

    <!-- üîπ Columna esquerra -->
    <div id="leftCol">
      <div class="panel card">
        <div class="q-header">
          <div style="display:flex; align-items:center; gap:10px">
            <span id="qModule" class="chip">‚Äî</span>
            <span id="qLevel" class="chip">Nivell 1</span>
            <span id="timer" class="chip timer">--:--</span>
          </div>
          <div class="progress" style="flex:1"><i id="bar"></i></div>
        </div>

        <div class="q">
          <div class="meta" id="qMeta">Pregunta 1 de 10</div>
          <h2 id="qText">‚Äî</h2>
          <div id="qMedia" style="margin:4px 0 2px"></div>
          <div class="answer-row">
            <input id="answer" class="input answer" placeholder="Resposta" type="text" />
            <button id="btnCheck">Comprova (‚Üµ)</button>
            <button class="btn-secondary" id="btnSkip">Omet (‚Üí)</button>
          </div>
          <div id="feedback"></div>
        </div>
      </div>
    </div>

    <!-- üîπ Columna dreta (teclat o opcions) -->
    <div id="rightCol">
      <div class="panel card" id="keypad"></div>
    </div>

  </div>
</section>


    <!-- RESULTS -->
    <section id="view-results" class="hidden">
      <div class="panel card">
        <div class="row">
          <h3 class="title" style="margin:0">Resultats guardats</h3>
          <div class="tbl-actions">
            <button class="btn-secondary" onclick="exportCSV()">Exporta CSV</button>
            <button class="btn-ghost" onclick="clearResults()">Neteja</button>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
          <label class="chip">Filtra m√≤dul: <select id="filter-module"></select></label>
          <label class="chip">Alumne/a: <input id="filter-student" class="input" placeholder="Tots" style="width:160px"></label>
        </div>
        <div id="resultsTable">No hi ha dades encara.</div>
      </div>

      <!-- PERFIL / ANALYTICS -->
      <div class="panel card" id="results-analytics">
        <div class="row" style="align-items:center">
          <h3 class="title" style="margin:0">Perfil i gr√†fiques</h3>
          <div class="subtitle">Es basa en el filtre d'<b>alumne</b> i (opcionalment) el de <b>m√≤dul</b>.</div>
        </div>

        <!-- KPIs -->
        <div class="kpi-grid" id="kpiWrap">
          <!-- S‚Äôomple des de JS -->
        </div>

        <!-- Charts -->
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-title">Evoluci√≥ de puntuaci√≥</div>
            <div id="chartScoreTrend"></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Mitjana per m√≤dul</div>
            <div id="chartByModule"></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">Temps vs Puntuaci√≥</div>
            <div id="chartTimeVsScore"></div>
          </div>
        </div>

        <div id="analyticsHint" class="chip" style="margin-top:10px; display:none">
          Escriu un nom d‚Äôalumne/a al filtre per veure el seu perfil.
        </div>
      </div>
    </section>

    <!-- ABOUT -->
<section id="view-about" class="hidden">
  <div class="panel card">
    <h3 class="title" style="margin-top:0">Sobre aquesta eina</h3>
    <p class="subtitle">
      Web single-file creada per <strong>Focus Academy</strong>, sense comptes ni depend√®ncies.  
      Dades locals al navegador.
    </p>
    <ul>
      <li><strong>Generador de preguntes</strong> per a Matem√†tiques (aritm√®tica, fraccions, percentatges, equacions, geometria, estad√≠stica, unitats), Llengua catalana i castellana (ortografia, categories gramaticals, sintaxi), Qu√≠mica (elements, f√≥rmules i compostos) i Geografia (pa√Øsos i banderes).</li>
      <li><strong>Temps opcional</strong>, nivell 1‚Äì4, i rep√†s de nom√©s les preguntes err√≤nies.</li>
      <li><strong>Historial exportable</strong> a CSV i <strong>gr√†fics de rendiment</strong>.</li>
      <li><strong>Tutor personalitzat</strong> que t‚Äôacompanya pas a pas en l‚Äôaprenentatge.</li>
    </ul>
  </div>
</section>

    <footer class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:16px">
      <div>Fet per Focus Academy Sant Cugat ¬∑ ¬© <span id="year"></span></div>
      <img src="https://static.wixstatic.com/media/543803_e8b22e64a34945f9ba54d4ca39fa3645~mv2.png/v1/crop/x_836,y_591,w_1877,h_1328/fill/w_642,h_454,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/543803_e8b22e64a34945f9ba54d4ca39fa3645~mv2.png"
           alt="Logo Focus Academy" style="height:40px; width:auto; object-fit:contain"
           referrerpolicy="no-referrer" />
  </footer>
  </main>

  <!-- üîπ Carrega primer els m√≤duls auxiliars -->
  <script src="lang-cat.js" defer></script>
  <script src="lang-esp.js" defer></script>
  <script src="quim.js" defer></script>
  <script src="geo.js" defer></script>
  <script src="tutor.js"></script>
  <script src="flashcards.js" defer></script>

  <!-- üîπ Despr√©s el bloc del login local -->
  <script>
  document.addEventListener('DOMContentLoaded', ()=> {
    const overlay = document.querySelector('#loginOverlay');
    const userList = document.querySelector('#loginUserList');
    const btnSelect = document.querySelector('#btnLoginSelect');
    const btnCreate = document.querySelector('#btnCreateUser');
    const btnDelete = document.querySelector('#btnDeleteUser');
    const inputNew = document.querySelector('#newUserName');

    function setOverlayVisible(open) {
      if (!overlay) return;
      overlay.classList.toggle('is-active', open);
      overlay.toggleAttribute('hidden', !open);
      overlay.style.display = open ? 'flex' : 'none';
    }

    // üîπ Carrega usuaris guardats
    function refreshUsers(){
      const users = JSON.parse(localStorage.getItem('students') || '[]');
      userList.innerHTML = users.map(u=>`<option>${u}</option>`).join('');
    }

    // üîπ Mostra overlay si no hi ha usuari actiu
    const current = localStorage.getItem('lastStudent');
    setOverlayVisible(!current);

    // üîπ Entrar amb usuari existent
    btnSelect.addEventListener('click', ()=>{
      const name = userList.value.trim();
      if(!name) return alert('Selecciona un usuari.');
      localStorage.setItem('lastStudent', name);
      setOverlayVisible(false);
      document.dispatchEvent(new CustomEvent('focusquiz:user-login'));
    });

    // üîπ Crear nou usuari
    btnCreate.addEventListener('click', ()=>{
      const name = inputNew.value.trim();
      if(name.length < 2) return alert('Nom massa curt.');
      const users = JSON.parse(localStorage.getItem('students') || '[]');
      if(!users.includes(name)) users.push(name);
      localStorage.setItem('students', JSON.stringify(users));
      localStorage.setItem('lastStudent', name);
      refreshUsers();
      inputNew.value = '';
      setOverlayVisible(false);
      document.dispatchEvent(new CustomEvent('focusquiz:user-login'));
    });

    // üîπ Esborrar usuari
    btnDelete.addEventListener('click', ()=>{
      const name = userList.value.trim();
      if(!name) return alert('Selecciona un usuari.');
      const users = JSON.parse(localStorage.getItem('students') || '[]').filter(u => u !== name);
      localStorage.setItem('students', JSON.stringify(users));
      if(localStorage.getItem('lastStudent') === name) localStorage.removeItem('lastStudent');
      refreshUsers();
      if(!localStorage.getItem('lastStudent')){
        setOverlayVisible(true);
        document.dispatchEvent(new CustomEvent('focusquiz:user-logout'));
      }
    });

    // üîπ Bot√≥ "Canvia d'usuari"
    const switchBtn = document.getElementById('switchUserBtn');
    if (switchBtn) {
      switchBtn.addEventListener('click', () => {
        localStorage.removeItem('lastStudent');
        setOverlayVisible(true);
        document.dispatchEvent(new CustomEvent('focusquiz:user-logout'));
      });
    }

    // üîπ Bot√≥ "Tanca sessi√≥"
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        const currentName = localStorage.getItem('lastStudent');
        if (!currentName || confirm(`Vols tancar la sessi√≥ de ${currentName}?`)) {
          localStorage.removeItem('lastStudent');
          setOverlayVisible(true);
          if (currentName) alert('Sessi√≥ tancada.');
          document.dispatchEvent(new CustomEvent('focusquiz:user-logout'));
        }
      });
    }

    refreshUsers();
  });
  </script>


  <script>
    // ===== L√≤gica del repte: Tira-corda matem√†tic =====
    (() => {
      const root = document.getElementById('ttmGame');
      if (!root) return;

      const DURATION = 120; // 2 minuts
      const LIMIT = 10; // quan la corda arriba a un camp

      const state = {
        step: 1,
        operations: new Set(['add', 'sub', 'mul', 'div']),
        difficulty: 'easy',
        running: false,
        timeLeft: DURATION,
        ropePos: 0,
        timerId: null,
        teams: {
          blue: { name: 'Equip blau', score: 0, input: '', current: null },
          red: { name: 'Equip vermell', score: 0, input: '', current: null }
        }
      };

      const els = {
        modal: document.getElementById('ttmModal'),
        stepLabel: document.getElementById('ttmStepLabel'),
        steps: Array.from(root.querySelectorAll('.ttm-step')),
        prevStep: document.getElementById('ttmPrevStep'),
        nextStep: document.getElementById('ttmNextStep'),
        setupError: document.getElementById('ttmSetupError'),
        opButtons: Array.from(root.querySelectorAll('[data-op]')),
        levelButtons: Array.from(root.querySelectorAll('[data-level]')),
        blueNameInput: document.getElementById('ttmBlueNameInput'),
        redNameInput: document.getElementById('ttmRedNameInput'),
        blueName: document.getElementById('ttmBlueName'),
        redName: document.getElementById('ttmRedName'),
        bluePanelTitle: document.getElementById('ttmBluePanelTitle'),
        redPanelTitle: document.getElementById('ttmRedPanelTitle'),
        blueScore: document.getElementById('ttmBlueScore'),
        redScore: document.getElementById('ttmRedScore'),
        timer: document.getElementById('ttmTimer'),
        flag: document.getElementById('ttmFlag'),
        questionBlue: document.getElementById('ttmQuestionBlue'),
        questionRed: document.getElementById('ttmQuestionRed'),
        inputBlue: document.getElementById('ttmInputBlue'),
        inputRed: document.getElementById('ttmInputRed'),
        keypads: Array.from(root.querySelectorAll('.ttm-keypad')),
        result: document.getElementById('ttmResult'),
        winnerTitle: document.getElementById('ttmWinnerTitle'),
        winnerStats: document.getElementById('ttmWinnerStats'),
        restartBtn: document.getElementById('ttmRestartBtn')
      };

      const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
      const formatTime = (t) => `${String(Math.floor(t / 60)).padStart(2, '0')}:${String(t % 60).padStart(2, '0')}`;

      function createQuestion() {
        const ops = Array.from(state.operations);
        const op = ops[randomInt(0, ops.length - 1)];
        const ranges = {
          easy: { add: [1, 20], sub: [1, 20], mul: [1, 10], div: [1, 10] },
          medium: { add: [10, 80], sub: [10, 80], mul: [4, 16], div: [2, 16] },
          hard: { add: [50, 250], sub: [50, 250], mul: [8, 24], div: [4, 24] }
        };
        const [min, max] = ranges[state.difficulty][op];
        let a = randomInt(min, max);
        let b = randomInt(min, max);

        if (op === 'add') return { text: `${a} + ${b} = ?`, answer: a + b };
        if (op === 'sub') {
          if (b > a) [a, b] = [b, a];
          return { text: `${a} ‚àí ${b} = ?`, answer: a - b };
        }
        if (op === 'mul') return { text: `${a} √ó ${b} = ?`, answer: a * b };

        const divisor = Math.max(1, b);
        const result = randomInt(min, max);
        const dividend = divisor * result;
        return { text: `${dividend} √∑ ${divisor} = ?`, answer: result };
      }

      function updateStepUi() {
        els.stepLabel.textContent = `Pas ${state.step} de 3`;
        els.steps.forEach(step => step.classList.toggle('is-active', Number(step.dataset.step) === state.step));
        els.prevStep.disabled = state.step === 1;
        els.nextStep.textContent = state.step === 3 ? 'Comen√ßar joc' : 'Seg√ºent';
      }

      function updateHud() {
        els.blueName.textContent = state.teams.blue.name;
        els.redName.textContent = state.teams.red.name;
        els.bluePanelTitle.textContent = state.teams.blue.name;
        els.redPanelTitle.textContent = state.teams.red.name;
        els.blueScore.textContent = state.teams.blue.score;
        els.redScore.textContent = state.teams.red.score;
        els.timer.textContent = formatTime(state.timeLeft);
        els.inputBlue.textContent = state.teams.blue.input || '0';
        els.inputRed.textContent = state.teams.red.input || '0';
      }

      function updateRope() {
        const pct = 50 + (state.ropePos / LIMIT) * 45;
        els.flag.style.left = `${Math.min(95, Math.max(5, pct))}%`;
      }

      function setQuestion(teamKey) {
        state.teams[teamKey].current = createQuestion();
        (teamKey === 'blue' ? els.questionBlue : els.questionRed).textContent = state.teams[teamKey].current.text;
      }

      function endGame() {
        if (!state.running) return;
        state.running = false;
        clearInterval(state.timerId);

        const blue = state.teams.blue;
        const red = state.teams.red;
        let winner = null;
        if (state.ropePos <= -LIMIT) winner = blue;
        else if (state.ropePos >= LIMIT) winner = red;
        else if (blue.score > red.score) winner = blue;
        else if (red.score > blue.score) winner = red;

        const used = DURATION - state.timeLeft;
        if (winner) {
          els.winnerTitle.textContent = `üèÜ Guanya ${winner.name}!`;
          els.winnerStats.textContent = `Encerts: ${winner.score} ¬∑ Temps utilitzat: ${formatTime(used)}`;
        } else {
          els.winnerTitle.textContent = 'ü§ù Empat!';
          els.winnerStats.textContent = `Encerts blau: ${blue.score} ¬∑ Encerts vermell: ${red.score} ¬∑ Temps: ${formatTime(used)}`;
        }
        els.result.hidden = false;
      }

      function handleAnswer(teamKey) {
        if (!state.running) return;
        const team = state.teams[teamKey];
        const value = Number(team.input || '');
        const ok = Number.isFinite(value) && value === team.current.answer;

        if (ok) {
          team.score += 1;
          state.ropePos += teamKey === 'blue' ? -1 : 1;
        } else {
          state.ropePos += teamKey === 'blue' ? 0.5 : -0.5;
        }

        team.input = '';
        setQuestion(teamKey);
        updateHud();
        updateRope();
        if (Math.abs(state.ropePos) >= LIMIT) endGame();
      }

      function startGame() {
        state.running = true;
        state.timeLeft = DURATION;
        state.ropePos = 0;
        state.teams.blue.score = 0;
        state.teams.red.score = 0;
        state.teams.blue.input = '';
        state.teams.red.input = '';
        setQuestion('blue');
        setQuestion('red');
        updateHud();
        updateRope();
        els.modal.hidden = true;
        els.result.hidden = true;

        clearInterval(state.timerId);
        state.timerId = setInterval(() => {
          state.timeLeft -= 1;
          els.timer.textContent = formatTime(Math.max(0, state.timeLeft));
          if (state.timeLeft <= 0) endGame();
        }, 1000);
      }

      function buildKeypad(teamKey, container) {
        ['7','8','9','4','5','6','1','2','3','0'].forEach(n => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'ttm-key';
          btn.textContent = n;
          btn.addEventListener('click', () => {
            if (!state.running) return;
            const t = state.teams[teamKey];
            t.input = `${t.input}${n}`.slice(0, 8);
            updateHud();
          });
          container.appendChild(btn);
        });

        const clear = document.createElement('button');
        clear.type = 'button';
        clear.className = 'ttm-key ttm-key--clear';
        clear.textContent = 'Esborrar';
        clear.addEventListener('click', () => {
          state.teams[teamKey].input = '';
          updateHud();
        });

        const send = document.createElement('button');
        send.type = 'button';
        send.className = 'ttm-key ttm-key--send';
        send.textContent = 'Enviar';
        send.addEventListener('click', () => handleAnswer(teamKey));

        container.appendChild(clear);
        container.appendChild(send);
      }

      // Controls de configuraci√≥
      els.opButtons.forEach(btn => btn.addEventListener('click', () => {
        const op = btn.dataset.op;
        if (state.operations.has(op) && state.operations.size === 1) return;
        if (state.operations.has(op)) {
          state.operations.delete(op);
          btn.classList.remove('is-active');
        } else {
          state.operations.add(op);
          btn.classList.add('is-active');
        }
      }));

      els.levelButtons.forEach(btn => btn.addEventListener('click', () => {
        state.difficulty = btn.dataset.level;
        els.levelButtons.forEach(b => b.classList.toggle('is-selected', b === btn));
      }));

      els.prevStep.addEventListener('click', () => {
        state.step = Math.max(1, state.step - 1);
        els.setupError.textContent = '';
        updateStepUi();
      });

      els.nextStep.addEventListener('click', () => {
        els.setupError.textContent = '';
        if (state.step < 3) {
          state.step += 1;
          updateStepUi();
          return;
        }
        const blue = (els.blueNameInput.value || '').trim() || 'Equip blau';
        const red = (els.redNameInput.value || '').trim() || 'Equip vermell';
        if (blue.toLowerCase() === red.toLowerCase()) {
          els.setupError.textContent = 'Els equips han de tenir noms diferents.';
          return;
        }
        state.teams.blue.name = blue;
        state.teams.red.name = red;
        startGame();
      });

      els.restartBtn.addEventListener('click', () => {
        clearInterval(state.timerId);
        state.step = 1;
        state.running = false;
        state.timeLeft = DURATION;
        state.ropePos = 0;
        els.modal.hidden = false;
        els.result.hidden = true;
        updateStepUi();
        updateHud();
        updateRope();
      });

      els.keypads.forEach(kp => buildKeypad(kp.dataset.keypad, kp));
      updateStepUi();
      updateHud();
      updateRope();
    })();
  </script>

  <!-- üîπ L√≤gica principal i generadors de matem√†tiques -->
  <script type="module" src="supabase/student-sync.js"></script>
  <script src="main.js" defer></script>
  <script src="math.js" defer></script>
</body>
</html>
