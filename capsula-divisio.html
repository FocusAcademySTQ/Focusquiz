<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FocusQuiz ¬∑ C√†psula ¬∑ Divisi√≥ (Prim√†ria, sense √†udio)</title>
  <meta name="description" content="C√†psula de divisi√≥ per Prim√†ria: 4 sessions guiades, estil Smartick (paper de llibreta, punts magenta), animacions suaus i exercicis autocorrectius. Single‚Äëfile, sense depend√®ncies." />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --brand:#93c5fd; --brand-2:#a7f3d0; --brand-3:#fbcfe8; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.07), 0 4px 12px rgba(15,23,42,.06);
      --paper:#FBF3CC; --paper-line:#9BB3E6; --pen:#2D4C9A; --dot:#FF4DBB;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1180px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .left{display:flex;align-items:center;gap:10px}
    .logo{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:var(--shadow);font-weight:900}
    h1{font-size:clamp(1.3rem,1.1rem + 2vw,2.4rem);margin:0}
    .sub{color:var(--muted)}

    .top-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{background:#eef2ff;color:#3730a3;border-radius:999px;padding:8px 12px;font-size:.95rem}

    .grid{display:grid;grid-template-columns:300px 1fr;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .inner{padding:18px}

    .steps{display:grid;gap:10px}
    .step{display:flex;gap:12px;align-items:center;border:2px solid var(--line);padding:14px;border-radius:16px;cursor:pointer;background:#fff;transition:transform .18s ease, box-shadow .18s ease}
    .step:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .step.locked{opacity:.5;cursor:not-allowed}
    .ico{width:38px;height:38px;border-radius:12px;display:grid;place-items:center;background:#f1f5f9;font-size:1.2rem}
    .step .meta{display:flex;flex-direction:column;line-height:1.1}
    .step .meta small{color:var(--muted)}
    .status{margin-left:auto;font-weight:800}
    .status.ok{color:var(--ok)} .status.do{color:#111}

    .view{min-height:560px}
    .fade-enter{animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

    .coach{display:flex;gap:12px;align-items:flex-start;background:#f1f5f9;border:2px solid var(--line);padding:14px;border-radius:16px}
    .coach .avatar{width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg,var(--brand-3),var(--brand));display:grid;place-items:center;font-weight:900;color:#111;font-size:1.1rem}
    .coach .bubble{line-height:1.3;font-size:1.05rem}

    .note{padding:12px 14px;border-radius:14px;background:#fff7ed;border:2px solid #fed7aa;color:#7c2d12;font-size:1.05rem}
    .result{padding:12px 14px;border-radius:14px;font-weight:800;display:inline-flex;align-items:center;gap:10px;font-size:1.05rem}
    .result.ok{background:#ecfdf5;color:#065f46}
    .result.no{background:#fef2f2;color:#7f1d1d}
    .progress{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-3));width:0}

    /* Smartick-like figure */
    .smartick-figure{display:inline-block;width:min(100%,600px)}
    .smartick-figure svg{width:100%;height:auto;display:block}
    .btn{appearance:none;border:2px solid var(--line);background:#fff;border-radius:14px;padding:12px 14px;font-size:1.05rem;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border:none}
    .btn.ghost{background:transparent;border:2px dashed var(--line)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="left">
        <div class="logo">FQ</div>
        <div>
          <h1>FocusQuiz ¬∑ C√†psules ‚Äî Divisi√≥</h1>
          <div class="sub">Estil Smartick (paper de llibreta i punts magenta). 4 sessions curtes amb animacions. Cada sessi√≥ es desbloqueja quan superes la prova üëá</div>
        </div>
      </div>
      <div class="top-controls">
        <span class="pill">Progr√©s total: <b id="allPct">0%</b></span>
      </div>
    </header>

    <section class="grid">
      <aside class="card" aria-label="Sessions">
        <div class="inner">
          <div class="steps" id="steps"></div>
          <div id="tests" aria-live="polite" style="display:none"></div>
        </div>
      </aside>

      <main class="card view fade-enter" id="view">
        <div class="inner" id="screen"></div>
      </main>
    </section>
  </div>

  <script>
  // ===== Utils b√†siques =====
  const $ = (q,el=document)=>el.querySelector(q);
  const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
  const rng = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;

  const LS_KEY = 'fq_capsula_divisio_primaria_v1';
  const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  if(!state.progress){ state.progress = { s1:false, s2:false, s3:false, s4:false }; }
  if(typeof state.best3 !== 'number') state.best3 = 0;
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  const SESS = [
    { id:'s1', title:'1) Mira i ent√©n', sub:'Dividir = repartir en parts iguals.', icon:'üëÄ' },
    { id:'s2', title:'2) Fem-ho pas a pas', sub:'Reparteix manualment els punts.', icon:'üß±' },
    { id:'s3', title:'3) Practiquem r√†pid', sub:'5 bones en 90 s. Pots repetir!', icon:'‚è±Ô∏è' },
    { id:'s4', title:'4) Prova final', sub:'10 preguntes. A partir de 8, aprovat!', icon:'üéØ' },
  ];

  function percentAll(){ const v = Object.values(state.progress).filter(Boolean).length; return Math.round(v/4*100); }
  function renderSteps(){
    const box = $('#steps'); box.innerHTML='';
    SESS.forEach((s,idx)=>{
      const unlocked = idx===0 || Object.values(state.progress).slice(0,idx).every(Boolean);
      const done = !!state.progress[s.id];
      const el = document.createElement('div'); el.className='step' + (unlocked?'':' locked'); el.dataset.id = s.id;
      el.innerHTML = `<div class="ico">${s.icon}</div>
        <div class="meta"><b>${s.title}</b><small>${s.sub}</small></div>
        <div class="status ${done?'ok':'do'}">${done?'Fet ‚úÖ': (unlocked?'Inicia':'Blocat')}</div>`;
      if(unlocked){ el.addEventListener('click', ()=> openSession(s.id)); }
      box.appendChild(el);
    });
    $('#allPct').textContent = percentAll()+"%";
  }

  // Obre sessi√≥: primer enganxa la vista al DOM i despr√©s inicialitza (evitem listeners sobre null)
  function openSession(id){
    const host = $('#screen'); host.innerHTML='';
    const view = document.createElement('div'); view.className='fade-enter';
    host.appendChild(view);
    if(id==='s1') initS1(view); else if(id==='s2') initS2(view); else if(id==='s3') initS3(view); else initS4(view);
    renderSteps();
  }

  // ===== Helper Smartick-like (SVG) =====
  function svgFigure(N,G,opts={animate:false}){
    const svgNS='http://www.w3.org/2000/svg';
    const box = document.createElementNS(svgNS,'svg');
    box.setAttribute('viewBox','0 0 600 190');
    box.setAttribute('preserveAspectRatio','xMidYMid slice');

    // defs (paper)
    const defs=document.createElementNS(svgNS,'defs');
    const pat=document.createElementNS(svgNS,'pattern');
    pat.setAttribute('id','paper'+Math.random());
    pat.setAttribute('width','600'); pat.setAttribute('height','20'); pat.setAttribute('patternUnits','userSpaceOnUse');
    const r1=document.createElementNS(svgNS,'rect'); r1.setAttribute('width','600'); r1.setAttribute('height','20'); r1.setAttribute('fill',getComputedStyle(document.documentElement).getPropertyValue('--paper')||'#FBF3CC');
    const r2=document.createElementNS(svgNS,'rect'); r2.setAttribute('y','19'); r2.setAttribute('width','600'); r2.setAttribute('height','1'); r2.setAttribute('fill',getComputedStyle(document.documentElement).getPropertyValue('--paper-line')||'#9BB3E6');
    pat.appendChild(r1); pat.appendChild(r2); defs.appendChild(pat); box.appendChild(defs);

    const bg=document.createElementNS(svgNS,'rect'); bg.setAttribute('width','600'); bg.setAttribute('height','190'); bg.setAttribute('fill',`url(#${pat.getAttribute('id')})`); box.appendChild(bg);

    // Caixa superior decorativa
    const topRect=document.createElementNS(svgNS,'rect'); topRect.setAttribute('x','60'); topRect.setAttribute('y','15'); topRect.setAttribute('width','480'); topRect.setAttribute('height','70'); topRect.setAttribute('fill','none'); topRect.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--pen')||'#2D4C9A'); topRect.setAttribute('stroke-width','4'); box.appendChild(topRect);

    // Caixes de grup
    const bins=document.createElementNS(svgNS,'g'); bins.setAttribute('id','bins'); box.appendChild(bins);
    const dots=document.createElementNS(svgNS,'g'); dots.setAttribute('id','dots'); box.appendChild(dots);
    const label=document.createElementNS(svgNS,'text'); label.setAttribute('id','label'); label.setAttribute('x','300'); label.setAttribute('y','180'); label.setAttribute('text-anchor','middle'); label.setAttribute('font-family','Verdana, Arial, sans-serif'); label.setAttribute('font-size','20'); label.setAttribute('fill',getComputedStyle(document.documentElement).getPropertyValue('--pen')||'#2D4C9A'); box.appendChild(label);

    const W=480,H=60,X0=60,Y=105,gap=20; const boxW=(W-gap*(G-1))/G;
    for(let i=0;i<G;i++){
      const x=X0+i*(boxW+gap);
      const rect=document.createElementNS(svgNS,'rect');
      rect.setAttribute('x',x); rect.setAttribute('y',Y); rect.setAttribute('width',boxW); rect.setAttribute('height',H);
      rect.setAttribute('fill','none'); rect.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--pen')||'#2D4C9A'); rect.setAttribute('stroke-width','4');
      bins.appendChild(rect);
    }

    const dotR=7, fill=getComputedStyle(document.documentElement).getPropertyValue('--dot')||'#FF4DBB', stroke=getComputedStyle(document.documentElement).getPropertyValue('--pen')||'#2D4C9A';
    function placeDot(cx,cy,delay=0){
      const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',dotR); c.setAttribute('fill',fill); c.setAttribute('stroke',stroke); c.setAttribute('stroke-width','2'); c.style.opacity='0'; dots.appendChild(c);
      if(opts.animate){ setTimeout(()=>{ c.animate([{opacity:0,transform:'translateY(-8px)'},{opacity:1,transform:'translateY(0)'}],{duration:220,easing:'ease-out',fill:'forwards'}); }, delay); } else { c.style.opacity='1'; }
    }

    const q=Math.floor(N/G), r=N%G;
    for(let g=0; g<G; g++){
      const x=X0 + g*(boxW+gap);
      const cols=Math.min(q,4); const rows=Math.ceil(q/cols||1); const cellX=boxW/(cols+1||1), cellY=18;
      for(let k=0;k<q;k++){
        const col=(k%cols)+1, row=Math.floor(k/cols)+1;
        const cx=x + col*cellX, cy=Y + H - row*cellY - 10;
        placeDot(cx, cy, opts.animate? (g*q+k)*60 : 0);
      }
    }
    for(let t=0;t<r;t++){
      const x=X0 + t*(boxW+gap) + boxW/2; const y=Y-14; placeDot(x,y, opts.animate? (G*q + t)*60 : 0);
    }

    label.textContent = `${N} : ${G} = ${q}` + (r? `  (rest = ${r})` : ``);
    return box;
  }

  // ===== Sessi√≥ 1 ‚Äî Mira i ent√©n =====
  function initS1(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>1) Mira i ent√©n</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Dividir vol dir <b>repartir en parts iguals</b>. Mira com es reparteixen els punts dins de les caixes. Pots canviar els n√∫meros i tornar a veure l'animaci√≥.</div></div>
      <div style="height:12px"></div>
      <div class="controls">
        <label>Objectes (N)
          <select id="s1N">
            <option>8</option><option selected>12</option><option>15</option><option>17</option><option>20</option>
          </select>
        </label>
        <label>Grups (G)
          <select id="s1G">
            <option>2</option><option selected>3</option><option>4</option><option>5</option>
          </select>
        </label>
        <button id="s1demo" class="btn primary">‚ñ∂Ô∏è Mostra animaci√≥</button>
        <button id="s1new" class="btn ghost">Nova figura</button>
      </div>
      <div class="smartick-figure" id="s1fig"></div>
      <div class="note">Objectiu: Mira l'animaci√≥ dues vegades i crea una figura nova per desbloquejar la seg√ºent sessi√≥.</div>
      <div class="progress" style="margin-top:10px"><div id="s1bar"></div></div>
    `;

    let views=0, created=false; // condicions per desbloqueig

    function render(animate=false){
      const holder=q('#s1fig'); holder.innerHTML='';
      const N=+q('#s1N').value, G=+q('#s1G').value;
      holder.appendChild(svgFigure(N,G,{animate}));
    }

    q('#s1demo').addEventListener('click', ()=>{ render(true); views++; q('#s1bar').style.width=Math.min(views+(created?1:0),3)/3*100+'%'; if(views>=2 && created){ state.progress.s1=true; save(); renderSteps(); setTimeout(()=>openSession('s2'),600); } });
    q('#s1new').addEventListener('click', ()=>{ const selN=q('#s1N'); const selG=q('#s1G'); selN.selectedIndex = (selN.selectedIndex+1)%selN.options.length; selG.selectedIndex = (selG.selectedIndex+1)%selG.options.length; created=true; render(false); q('#s1bar').style.width=Math.min(views+(created?1:0),3)/3*100+'%'; });
    q('#s1N').addEventListener('change', ()=>render(false));
    q('#s1G').addEventListener('change', ()=>render(false));

    render(false);
  }

  // ===== Sessi√≥ 2 ‚Äî Fem-ho pas a pas (interactiu) =====
  function initS2(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML=`
      <h2>2) Fem-ho pas a pas</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Clica una caixa per col¬∑locar-hi el <b>seg√ºent punt</b>. Prova d'aconseguir <b>el mateix nombre</b> de punts a cada caixa. El que sobri ser√† el <b>rest</b>.</div></div>
      <div class="controls">
        <label>Objectes (N)
          <select id="s2N"><option>7</option><option selected>11</option><option>13</option><option>16</option></select>
        </label>
        <label>Grups (G)
          <select id="s2G"><option>2</option><option selected>3</option><option>4</option></select>
        </label>
        <button id="s2reset" class="btn ghost">Reinicia</button>
      </div>
      <div class="smartick-figure"><svg id="s2svg" viewBox="0 0 600 190" preserveAspectRatio="xMidYMid slice" aria-label="Repartiment manual"></svg></div>
      <div class="controls" style="margin-top:8px">
        <button id="s2check" class="btn primary">Comprova</button>
        <div id="s2fb"></div>
      </div>
      <div class="progress" style="margin-top:10px"><div id="s2bar"></div></div>
    `;

    const svg = q('#s2svg');
    const svgNS='http://www.w3.org/2000/svg';
    let N=11,G=3, placed=0, perBin=[]; let bins=[]; let doneRounds=0;

    function build(){
      // reset
      svg.innerHTML=''; bins=[]; perBin=Array(G).fill(0); placed=0;
      // defs paper
      const defs=document.createElementNS(svgNS,'defs');
      const pat=document.createElementNS(svgNS,'pattern'); pat.setAttribute('id','paperS2'); pat.setAttribute('width','600'); pat.setAttribute('height','20'); pat.setAttribute('patternUnits','userSpaceOnUse');
      const r1=document.createElementNS(svgNS,'rect'); r1.setAttribute('width','600'); r1.setAttribute('height','20'); r1.setAttribute('fill',getComputedStyle(document.documentElement).getPropertyValue('--paper')||'#FBF3CC');
      const r2=document.createElementNS(svgNS,'rect'); r2.setAttribute('y','19'); r2.setAttribute('width','600'); r2.setAttribute('height','1'); r2.setAttribute('fill',getComputedStyle(document.documentElement).getPropertyValue('--paper-line')||'#9BB3E6');
      pat.appendChild(r1); pat.appendChild(r2); defs.appendChild(pat); svg.appendChild(defs);

      const bg=document.createElementNS(svgNS,'rect'); bg.setAttribute('width','600'); bg.setAttribute('height','190'); bg.setAttribute('fill','url(#paperS2)'); svg.appendChild(bg);
      const top=document.createElementNS(svgNS,'rect'); top.setAttribute('x','60'); top.setAttribute('y','15'); top.setAttribute('width','480'); top.setAttribute('height','70'); top.setAttribute('fill','none'); top.setAttribute('stroke',getComputedStyle(document.documentElement).getPropertyValue('--pen')||'#2D4C9A'); top.setAttribute('stroke-width','4'); svg.appendChild(top);

      const W=480,H=60,X0=60,Y=105,gap=20; const boxW=(W-gap*(G-1))/G;
      for(let i=0;i<G;i++){
  const x = X0 + i*(boxW + gap);
  const rect = document.createElementNS(svgNS, 'rect');
  rect.setAttribute('x', x);
  rect.setAttribute('y', Y);
  rect.setAttribute('width', boxW);
  rect.setAttribute('height', H);
  rect.setAttribute('rx', '4');
  rect.setAttribute('fill', 'none');
  rect.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--pen') || '#2D4C9A');
  rect.setAttribute('stroke-width', '4');
  rect.style.cursor = 'pointer';
  rect.addEventListener('click', () => place(i, x, Y, boxW, H));
  svg.appendChild(rect);

  // ‚úÖ Correcci√≥: ‚Äúy:Y‚Äù no existia, ara √©s expl√≠cit
  bins.push({ x: x, y: Y, w: boxW, h: H });
}

      // punts a dalt (pendents de col¬∑locar)
      const pending=Math.min(N,12); const topY=45; const startX=110; const step=30;
      for(let i=0;i<pending;i++){
        const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx', startX + i*step); c.setAttribute('cy', topY); c.setAttribute('r','7'); c.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--dot')||'#FF4DBB'); c.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--pen')||'#2D4C9A'); c.setAttribute('stroke-width','2'); svg.appendChild(c);
      }
    }

    function place(binIdx, x, Y, boxW, H){
      if(placed>=N) return;
      const cols=4; const cellX=boxW/(cols+1), cellY=18; const k=perBin[binIdx];
      const col=(k%cols)+1, row=Math.floor(k/cols)+1; const cx=x + col*cellX, cy=Y + H - row*cellY - 10;
      const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r','7'); c.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--dot')||'#FF4DBB'); c.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--pen')||'#2D4C9A'); c.setAttribute('stroke-width','2'); c.style.opacity='0'; svg.appendChild(c);
      c.animate([{opacity:0,transform:'translateY(-8px)'},{opacity:1,transform:'translateY(0)'}],{duration:200,easing:'ease-out',fill:'forwards'});
      perBin[binIdx]++; placed++;
    }

    function check(){
      const min=Math.min(...perBin), max=Math.max(...perBin); const equal=min===max; const q=Math.floor(N/G); const r=N%G;
      const ok = equal && max===q && placed===N; // tot col¬∑locat i igualtat
      q('#s2fb').innerHTML = `<span class="result ${ok?'ok':'no'}">${ok?'Correcte ‚úÖ':'Encara no ‚ùå'} <span class="mono">${N} : ${G} = ${q}${r?`, rest ${r}`:''}</span></span>`;
      if(ok){ doneRounds++; q('#s2bar').style.width=Math.min(doneRounds,2)/2*100+'%'; if(doneRounds>=2){ state.progress.s2=true; save(); renderSteps(); setTimeout(()=>openSession('s3'),700); } }
    }

    function reset(){ N=+q('#s2N').value; G=+q('#s2G').value; doneRounds=0; q('#s2bar').style.width='0%'; build(); }

    q('#s2N').addEventListener('change', reset);
    q('#s2G').addEventListener('change', reset);
    q('#s2reset').addEventListener('click', reset);
    q('#s2check').addEventListener('click', check);

    reset();
  }

  // ===== Sessi√≥ 3 ‚Äî Practiquem r√†pid (quocient + residu) =====
  function initS3(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML=`
      <h2>3) Practiquem r√†pid</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Tens <b>90 segons</b>. Escriu <b>quocient</b> i <b>residu</b> de cada divisi√≥. Aconsegueix <b>5 encerts</b>!</div></div>
      <div class="controls">
        <label>Rang
          <select id="s3range"><option value="20">Fins a 20</option><option value="50" selected>Fins a 50</option><option value="100">Fins a 100</option></select>
        </label>
        <button id="s3start" class="btn primary">Comen√ßa</button>
        <span class="pill">Temps: <b id="s3t">‚Äî</b></span>
        <span class="pill">Correctes: <b id="s3ok">0</b>/5</span>
        <span class="pill">Millor marca: <b id="s3best">${state.best3||0}</b></span>
      </div>
      <div id="s3op" style="margin:12px 0"></div>
      <div id="s3fb"></div>
    `;

    let target=5, ok=0, running=false, timer=null, left=90; let cur={a:0,b:0,q:0,r:0};

    function gen(){
      const max=+q('#s3range').value; let a=rng(6,max), b=rng(2, Math.min(9, max-1));
      if(b>a) [a,b]=[b,a]; // assegura a>=b
      const qn=Math.floor(a/b), rn=a%b; return {a,b,qn,rn};
    }

    function render(){
      const box=q('#s3op');
      box.innerHTML=`
        <div class="note"><b>Resol:</b> <span class="mono">${cur.a} √∑ ${cur.b}</span> &nbsp; ‚Üí &nbsp; Quocient <input id="ansQ" style="width:3ch;text-align:center"> &nbsp; Residu <input id="ansR" style="width:3ch;text-align:center"> &nbsp; <button id="s3check" class="btn">Comprova</button></div>
      `;
      q('#ansQ').focus();
      q('#s3check').addEventListener('click', checkOne);
    }

    function checkOne(){
      const uQ=+q('#ansQ').value||0, uR=+q('#ansR').value||0;
      const good=(uQ===cur.q && uR===cur.r);
      q('#s3fb').innerHTML=`<span class="result ${good?'ok':'no'}">${good?'Correcte ‚úÖ':'Incorrecte ‚ùå'} <span class="mono">${cur.a} √∑ ${cur.b} = ${cur.q} (rest ${cur.r})</span></span>`;
      if(good){ ok++; q('#s3ok').textContent=ok; if(ok>=target){ stop(true); } else { next(); } }
    }

    function next(){ curOp(); render(); }
    function curOp(){ const g=gen(); cur={a:g.a,b:g.b,q:g.qn,r:g.rn}; }

    function tick(){ left--; q('#s3t').textContent=left+'s'; if(left<=0){ stop(false); }}
    function start(){ ok=0; left=90; q('#s3ok').textContent='0'; q('#s3t').textContent=left+'s'; running=true; timer=setInterval(tick,1000); curOp(); render(); }
    function stop(win){ running=false; clearInterval(timer); if(win){ state.progress.s3=true; save(); renderSteps(); setTimeout(()=>openSession('s4'),650);} if(ok>state.best3){ state.best3=ok; save(); q('#s3best').textContent=ok; } }

    q('#s3start').addEventListener('click', start);
    view.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && running) checkOne(); });
  }

  // ===== Sessi√≥ 4 ‚Äî Prova final =====
  function initS4(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML=`
      <h2>4) Prova final</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Respon <b>10 divisions</b> escrivint <b>quocient</b> i <b>residu</b>. Si arribes a <b>8</b>, certificat superat! üëè</div></div>
      <div class="controls">
        <label>Rang
          <select id="s4range"><option value="20">Fins a 20</option><option value="50" selected>Fins a 50</option><option value="100">Fins a 100</option></select>
        </label>
        <button id="s4start" class="btn primary">Inicia la prova</button>
        <span class="pill">P: <b id="s4i">0</b>/10</span>
        <span class="pill">Encerts: <b id="s4ok">0</b></span>
      </div>
      <div id="s4host" style="margin:12px 0"></div>
      <div id="s4fb"></div>
    `;

    let i=0, ok=0, cur={a:0,b:0,q:0,r:0};

    function gen(){
      const max=+q('#s4range').value; let a=rng(8,max), b=rng(2, Math.min(9, max-1)); if(b>a) [a,b]=[b,a];
      const qn=Math.floor(a/b), rn=a%b; return {a,b,qn,rn};
    }

    function render(){
      const host=q('#s4host'); host.innerHTML=`
        <div class="note"><b>Q${i+1}.</b> <span class="mono">${cur.a} √∑ ${cur.b}</span> ‚Üí Quocient <input id="q" style="width:3ch;text-align:center"> Residu <input id="r" style="width:3ch;text-align:center"> <button id="s4check" class="btn">Comprova</button></div>
      `;
      q('#q').focus(); q('#s4check').addEventListener('click', checkOne);
    }

    function next(){ cur=gen(); render(); }

    function start(){ i=0; ok=0; q('#s4i').textContent='0'; q('#s4ok').textContent='0'; next(); }

    function checkOne(){ const uQ=+q('#q').value||0, uR=+q('#r').value||0; const good=(uQ===cur.qn && uR===cur.rn); if(good) ok++; i++; q('#s4i').textContent=i; q('#s4ok').textContent=ok; q('#s4fb').innerHTML=`<span class="result ${good?'ok':'no'}">${good?'Correcte ‚úÖ':'Incorrecte ‚ùå'} <span class="mono">${cur.a} √∑ ${cur.b} = ${cur.qn} (rest ${cur.rn})</span></span>`; if(i>=10){ const pass=ok>=8; if(pass){ state.progress.s4=true; save(); renderSteps(); q('#s4fb').insertAdjacentHTML('beforeend',' <span class="pill" style="margin-left:8px">Completada üèÜ</span>'); } } else { next(); } }

    q('#s4start').addEventListener('click', start);
    view.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkOne(); });
  }

 // ===== Init =====
document.addEventListener('DOMContentLoaded', ()=>{
  renderSteps();
  const firstOpen = ['s1','s2','s3','s4'].find((id,idx)=> idx===0 || Object.values(state.progress).slice(0,idx).every(Boolean) );
  openSession(firstOpen||'s1');
  // runSmokeTests(); // (Comentat perqu√® obria autom√†ticament la secci√≥ 2)
});

  // ===== Smoke tests =====
  function runSmokeTests(){
    const box = document.getElementById('tests'); if(!box) return;
    try{
      console.assert(document.querySelectorAll('#steps .step').length>=1,'[TEST] Steps renderitzats');
      openSession('s1'); console.assert(document.querySelector('#screen #s1demo'),'[TEST] s1demo existeix');
      openSession('s2'); console.assert(document.querySelector('#screen #s2check'),'[TEST] s2check existeix');
      box.style.display='block'; box.textContent='Tests b√†sics passats ‚úÖ';
    }catch(e){ box.style.display='block'; box.textContent='Alguns tests han fallat ‚ùå (mira la consola)'; console.error(e); }
  }
  </script>
</body>
</html>
