<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FocusQuiz ¬∑ C√†psula ¬∑ Divisi√≥ pas a pas</title>
  <meta name="description" content="C√†psula d'aprenentatge per dominar la divisi√≥: animacions de repartiment, divisi√≥ llarga guiada, pr√†ctica cronometrada i prova final." />
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --brand:#a5b4fc; --brand-2:#c7d2fe; --brand-3:#d1fae5; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --radius:18px; --shadow:0 12px 32px rgba(15,23,42,.08), 0 6px 18px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:linear-gradient(180deg,#f8fafc,#eef2ff 320px); color:var(--ink)}
    a{text-decoration:none;color:inherit}

    .wrap{max-width:1180px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:20px}
    .left{display:flex;align-items:center;gap:12px}
    .logo{display:inline-grid;place-items:center;width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:var(--shadow);font-weight:900;color:#111}
    h1{font-size:clamp(1.3rem,1.15rem + 2vw,2.4rem);margin:0}
    .sub{color:var(--muted);max-width:620px}
    .pill{background:#eef2ff;color:#3730a3;border-radius:999px;padding:9px 14px;font-size:.92rem;font-weight:700;display:inline-flex;align-items:center;gap:6px}

    .top-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .hero-card{background:linear-gradient(120deg,rgba(165,180,252,0.35),rgba(199,210,254,0.25));padding:18px 20px;border-radius:20px;border:1.5px dashed rgba(99,102,241,0.45);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;margin-bottom:18px}
    .hero-card h2{margin:0;font-size:1.25rem}
    .hero-card p{margin:0;color:#334155;line-height:1.4}

    .grid{display:grid;grid-template-columns:320px 1fr; gap:20px}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .inner{padding:20px}

    .steps{display:grid;gap:12px}
    .step{display:flex;gap:12px;align-items:center;border:2px solid var(--line);padding:14px;border-radius:18px;cursor:pointer;background:#fff;transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
    .step:hover{transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.06); border-color:#c7d2fe}
    .step.locked{opacity:.55; cursor:not-allowed}
    .ico{width:40px;height:40px;border-radius:14px;display:grid;place-items:center;background:#f1f5f9;font-size:1.35rem}
    .step .meta{display:flex;flex-direction:column;line-height:1.1}
    .step .meta small{color:var(--muted)}
    .status{margin-left:auto;font-weight:800}
    .status.ok{color:var(--ok)}
    .status.do{color:#111}

    .view{min-height:580px}
    .fade-enter{animation:fadeIn .32s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none}}

    .coach{display:flex;gap:12px;align-items:flex-start;background:#f1f5f9;border:2px solid var(--line);padding:14px;border-radius:18px;margin:12px 0}
    .coach .avatar{width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg,var(--brand-2),var(--brand-3));display:grid;place-items:center;font-weight:900;color:#111;font-size:1.1rem}
    .coach .bubble{line-height:1.35;font-size:1.05rem}

    .note{padding:12px 14px;border-radius:16px;background:#fff7ed;border:2px solid #fed7aa;color:#7c2d12;font-size:1.02rem;margin:12px 0}
    .info{padding:12px 14px;border-radius:16px;background:#eef2ff;border:2px solid #c7d2fe;color:#1e3a8a;font-size:1rem;margin:12px 0}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 14px}
    label>span{display:block;font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#334155;margin-bottom:4px}
    select,input,button{appearance:none;border:2px solid var(--line);background:#fff;border-radius:14px;padding:11px 14px;font-size:1.02rem;font-family:inherit}
    input[type=number]{width:120px}
    button{cursor:pointer;font-weight:700;box-shadow:var(--shadow);background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#fff;border:none;transition:transform .18s ease, box-shadow .18s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 12px 28px rgba(79,70,229,0.25)}
    button.ghost{background:transparent;color:#334155;border:2px dashed var(--line);box-shadow:none}
    button.ok{background:linear-gradient(135deg,#10b981,#34d399);color:#034732}
    button.warn{background:linear-gradient(135deg,#f59e0b,#fcd34d);color:#7c2d12}
    button.small{padding:8px 12px;font-size:.9rem}

    .progress{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress > div{height:100%; background:linear-gradient(90deg,#4f46e5,#a855f7); width:0}

    .result{padding:10px 12px;border-radius:14px;font-weight:700;display:inline-flex;align-items:center;gap:8px;font-size:.98rem;margin-top:8px}
    .result.ok{background:#ecfdf5;color:#065f46}
    .result.no{background:#fef2f2;color:#7f1d1d}

    .sim-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}
    .bucket{border:2px solid var(--line);border-radius:16px;padding:12px;min-height:120px;background:#fff}
    .bucket h4{margin:0 0 8px;font-size:.95rem;color:#1f2937}
    .token-wrap{display:flex;flex-wrap:wrap;gap:6px}
    .token{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#a5f3fc,#93c5fd);color:#0f172a;font-weight:700;font-size:.85rem;box-shadow:0 6px 16px rgba(15,23,42,0.12)}
    .token.rest{background:linear-gradient(135deg,#fbcfe8,#fbbf24);color:#78350f}

    .ld-board{margin:16px 0;border:2px solid var(--line);border-radius:18px;padding:16px;background:#f8fafc}
    .ld{display:grid;grid-template-columns:auto 1fr;align-items:start;gap:0}
    .ld-left{padding:10px 12px 18px 4px;border-right:3px solid #111;font-size:1.4rem;font-family:"JetBrains Mono",ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
    .ld-right{border-top:3px solid #111;padding:6px 0 0 14px;min-width:220px}
    .ld-quotient{min-height:32px;font-size:1.3rem;font-family:"JetBrains Mono",ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;letter-spacing:.12em}
    .ld-dividend{font-size:1.35rem;font-family:"JetBrains Mono",ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
    .ld-steps{margin-top:12px;display:grid;gap:8px;font-family:"JetBrains Mono",ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
    .ld-step{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .ld-step strong{color:#1e3a8a}
    .ld-step span{display:inline-flex;align-items:center;gap:4px}

    .multiples{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .multiples span{padding:6px 10px;border-radius:12px;background:#e0f2fe;color:#0c4a6e;font-weight:600;font-size:.85rem}

    .dual-inputs{display:flex;gap:10px;flex-wrap:wrap}
    .dual-inputs input{width:120px;text-align:center;font-weight:700;font-size:1.05rem}

    .pill.small{font-size:.85rem;padding:6px 10px}

    @media (max-width:720px){
      header{align-items:flex-start}
      .hero-card{margin-bottom:12px}
      .ld-left{font-size:1.2rem}
      .ld-right{min-width:0}
      .dual-inputs input{width:100px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="left">
        <div class="logo">FQ</div>
        <div>
          <h1>FocusQuiz ¬∑ C√†psules ‚Äî Divisi√≥ pas a pas</h1>
          <div class="sub">Una ruta amb 4 sessions curtes per entendre el repartiment, practicar la divisi√≥ llarga i posar-te a prova. Tot queda guardat al teu dispositiu üëá</div>
        </div>
      </div>
      <div class="top-controls">
        <span class="pill">Progr√©s total: <b id="allPct">0%</b></span>
        <a class="pill" href="capsules.html">‚Üê Torna a l'Espai</a>
      </div>
    </header>

    <div class="hero-card">
      <h2>Com funciona?</h2>
      <p>Completa cada sessi√≥ per desbloquejar la seg√ºent. Si ja tens experi√®ncia, pots repetir les activitats per millorar la teva marca personal. Per comen√ßar, mira l'animaci√≥ de repartiment i respon dues divisions senzilles.</p>
    </div>

    <section class="grid">
      <aside class="card" aria-label="Sessions">
        <div class="inner">
          <div class="steps" id="steps"></div>
          <div id="tests" aria-live="polite" style="margin-top:12px;font-size:.9rem;display:none"></div>
        </div>
      </aside>

      <main class="card view" id="view">
        <div class="inner" id="screen"></div>
      </main>
    </section>
  </div>

  <script>
  const $ = (q,el=document)=>el.querySelector(q);
  const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
  const rng = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;

  function genDivision(level){
    let divisor, quotient, remainder, dividend;
    if(level===1){
      divisor = rng(2,9);
      quotient = rng(2,9);
      remainder = rng(0, divisor-1);
      dividend = divisor * quotient + remainder;
      if(dividend < 12 || dividend > 98) return genDivision(level);
    } else if(level===2){
      divisor = rng(3,9);
      quotient = rng(10,36);
      remainder = rng(0, divisor-1);
      dividend = divisor * quotient + remainder;
      if(dividend < 120 || dividend > 999) return genDivision(level);
    } else {
      divisor = rng(11,25);
      quotient = rng(4,18);
      remainder = rng(0, divisor-1);
      dividend = divisor * quotient + remainder;
      if(dividend < 200 || dividend > 999) return genDivision(level);
    }
    return {dividend, divisor, quotient, remainder};
  }

  function divisionSteps(dividend, divisor){
    const digits = String(dividend).split('').map(Number);
    let partial = 0;
    return digits.map((digit, idx)=>{
      partial = partial * 10 + digit;
      const qDigit = Math.floor(partial / divisor);
      const product = qDigit * divisor;
      const remainder = partial - product;
      const step = { idx, partial, qDigit, product, remainder, bring: digit };
      partial = remainder;
      return step;
    });
  }

  function multiplesOf(divisor){
    const out = [];
    for(let i=1;i<=9;i++) out.push(`${i} √ó ${divisor} = ${i*divisor}`);
    return out;
  }

  const LS_KEY = 'fq_capsula_divisio_v1';
  const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  if(!state.progress){ state.progress = { s1:false, s2:false, s3:false, s4:false }; }
  if(typeof state.best3 !== 'number') state.best3 = 0;

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  const SESS = [
    { id:'s1', title:'1) Mira i reparteix', sub:'Animaci√≥ + 2 divisions senzilles', icon:'üé¨' },
    { id:'s2', title:'2) Divisi√≥ llarga guiada', sub:'Pas a pas amb pista visual', icon:'üßÆ' },
    { id:'s3', title:'3) Pr√†ctica cronometrada', sub:'5 encerts en 90 segons', icon:'‚è±Ô∏è' },
    { id:'s4', title:'4) Prova final', sub:'10 preguntes. 8 bones per superar-la', icon:'üéØ' },
  ];

  function percentAll(){ const v = Object.values(state.progress).filter(Boolean).length; return Math.round(v/4*100); }

  function renderSteps(){
    const box = $('#steps'); box.innerHTML='';
    SESS.forEach((s,idx)=>{
      const unlocked = idx===0 || Object.values(state.progress).slice(0,idx).every(Boolean);
      const done = !!state.progress[s.id];
      const el = document.createElement('div'); el.className = 'step' + (unlocked?'':' locked'); el.dataset.id = s.id;
      el.innerHTML = `<div class="ico">${s.icon}</div>
        <div class="meta"><b>${s.title}</b><small>${s.sub}</small></div>
        <div class="status ${done?'ok':'do'}">${done?'Fet ‚úÖ': (unlocked?'Inicia':'Blocat')}</div>`;
      if(unlocked){ el.addEventListener('click', ()=> openSession(s.id)); }
      box.appendChild(el);
    });
    $('#allPct').textContent = percentAll()+"%";
  }

  function openSession(id){
    const host = $('#screen');
    host.innerHTML='';
    const view = document.createElement('div');
    view.className='fade-enter';
    host.appendChild(view);
    if(id==='s1') initS1(view);
    else if(id==='s2') initS2(view);
    else if(id==='s3') initS3(view);
    else initS4(view);
    renderSteps();
  }

  function renderTokens(container, students, items){
    container.innerHTML='';
    const base = Math.floor(items / students);
    const rest = items % students;
    const frag = document.createDocumentFragment();
    for(let i=0;i<students;i++){
      const box = document.createElement('div');
      box.className = 'bucket';
      box.innerHTML = `<h4>Grup ${i+1}</h4><div class="token-wrap"></div>`;
      const wrap = $('.token-wrap', box);
      for(let j=0;j<base;j++){
        const token = document.createElement('div'); token.className='token'; token.textContent=j+1; wrap.appendChild(token);
      }
      if(i < rest){ const extra = document.createElement('div'); extra.className='token rest'; extra.textContent='+1'; wrap.appendChild(extra); }
      frag.appendChild(box);
    }
    container.appendChild(frag);
    return { base, rest };
  }

  function fmtDivision(d){ return `${d.dividend} √∑ ${d.divisor}`; }

  /* ===== S1 ===== */
  function initS1(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>1) Mira i reparteix</h2>
      <div class="coach"><div class="avatar">üë©‚Äçüè´</div><div class="bubble">Quan fem una <b>divisi√≥</b>, repartim un total d'objectes entre grups iguals. El n√∫mero que obtenim √©s quants n'hi toca a cada grup. Si en sobren, parlem de <b>resta</b>. Ajusta la simulaci√≥ i observa qu√® passa.</div></div>
      <div class="info">Consell: pensa la divisi√≥ com un repartiment just. Primer mira quantes vegades hi cap el divisor i despr√©s comprova si sobren objectes.</div>
      <div class="controls">
        <label><span>Elements</span><input id="s1items" type="range" min="12" max="84" step="6" value="36"></label>
        <span class="pill small">Total: <b id="s1itemsLabel">36</b></span>
        <label><span>Nombre de grups</span><input id="s1groups" type="range" min="2" max="6" value="3"></label>
        <span class="pill small">Grups: <b id="s1groupsLabel">3</b></span>
        <button id="s1simulate" class="ok">Distribueix</button>
      </div>
      <div id="s1visual" class="sim-grid" aria-live="polite"></div>
      <div id="s1summary" class="note" style="display:none"></div>
      <div class="info">Ara practica dues divisions seguides per desbloquejar la seg√ºent sessi√≥.</div>
      <div class="controls">
        <label><span>Dificultat</span>
          <select id="s1level">
            <option value="1">2 xifres √∑ 1 xifra</option>
            <option value="2" selected>3 xifres √∑ 1 xifra</option>
            <option value="3">3 xifres √∑ 2 xifres</option>
          </select>
        </label>
        <button id="s1new" class="ghost">Nova divisi√≥</button>
      </div>
      <div id="s1question" class="info" style="display:none"></div>
      <div class="dual-inputs">
        <input id="s1ansQ" inputmode="numeric" maxlength="3" placeholder="Quocient" aria-label="Resposta: quocient" />
        <input id="s1ansR" inputmode="numeric" maxlength="2" placeholder="Resta" aria-label="Resposta: resta" />
      </div>
      <div class="controls" style="margin-top:10px">
        <button id="s1check">Comprova</button>
        <div id="s1fb"></div>
      </div>
      <div class="progress"><div id="s1bar"></div></div>
    `;

    const items = q('#s1items');
    const groups = q('#s1groups');
    const itemsLabel = q('#s1itemsLabel');
    const groupsLabel = q('#s1groupsLabel');
    const visual = q('#s1visual');
    const summary = q('#s1summary');
    const levelSel = q('#s1level');
    let current=null; let streak=0;

    function updateLabels(){ itemsLabel.textContent = items.value; groupsLabel.textContent = groups.value; }

    function simulate(){ updateLabels(); const {base, rest} = renderTokens(visual, Number(groups.value), Number(items.value)); summary.style.display='block'; summary.innerHTML = `<strong>${items.value} objectes √∑ ${groups.value} grups</strong> ‚Üí Cada grup rep <b>${base}</b> objectes${rest?` i en sobren <b>${rest}</b>.`:' i no en sobra cap!'} Toca dir: ${items.value} √∑ ${groups.value} = ${base}${rest?` amb resta ${rest}`:''}.`; }

    function newDivision(){ current = genDivision(Number(levelSel.value)); q('#s1question').style.display='block'; q('#s1question').innerHTML = `<strong>${fmtDivision(current)}</strong> ¬∑ Escriu quants en toca a cada grup i la resta.`; q('#s1ansQ').value=''; q('#s1ansR').value=''; q('#s1ansQ').focus(); }

    function check(){ if(!current) return; const ansQ = Number(q('#s1ansQ').value); const ansR = Number(q('#s1ansR').value); const ok = ansQ===current.quotient && ansR===current.remainder; q('#s1fb').innerHTML = `<span class="result ${ok?'ok':'no'}">${ok?'Ben fet! ‚úÖ':'Oops‚Ä¶ torna-ho a intentar ‚ùå'} <span>${fmtDivision(current)} = ${current.quotient} ${current.remainder?`(resta ${current.remainder})`:'(sense resta)'}</span></span>`; if(ok){ streak++; q('#s1bar').style.width = Math.min(streak,2)/2*100+"%"; if(streak>=2){ state.progress.s1=true; save(); renderSteps(); setTimeout(()=>openSession('s2'),650); } else { setTimeout(newDivision,500); } } else { streak=0; q('#s1bar').style.width='0%'; }
    }

    items.addEventListener('input', ()=>{ updateLabels(); simulate(); });
    groups.addEventListener('input', ()=>{ updateLabels(); simulate(); });
    q('#s1simulate').addEventListener('click', simulate);
    q('#s1new').addEventListener('click', newDivision);
    levelSel.addEventListener('change', newDivision);
    q('#s1check').addEventListener('click', check);
    view.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const active = document.activeElement; if(active===q('#s1ansQ') || active===q('#s1ansR')){ check(); } }});

    simulate();
    newDivision();
  }

  /* ===== S2 ===== */
  function initS2(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>2) Divisi√≥ llarga guiada</h2>
      <div class="coach"><div class="avatar">üßë‚Äçüè´</div><div class="bubble">Anirem columna a columna. A cada pas pensa: quantes vegades hi cap el divisor en el n√∫mero actual sense passar-se? Escriu el d√≠git i veur√†s com fem la resta.</div></div>
      <div class="controls">
        <label><span>Dificultat</span>
          <select id="s2level">
            <option value="1">2 xifres √∑ 1 xifra</option>
            <option value="2" selected>3 xifres √∑ 1 xifra</option>
            <option value="3">3 xifres √∑ 2 xifres</option>
          </select>
        </label>
        <button id="s2new" class="ghost">Nova divisi√≥</button>
      </div>
      <div class="ld-board">
        <div class="ld">
          <div class="ld-left" id="s2divisor">‚Äî</div>
          <div class="ld-right">
            <div class="ld-quotient" id="s2quotient">¬∑¬∑¬∑</div>
            <div class="ld-dividend" id="s2dividend">‚Äî</div>
          </div>
        </div>
        <div class="ld-steps" id="s2work"></div>
      </div>
      <div id="s2hint" class="info">Selecciona la resposta correcta per al primer pas.</div>
      <div class="controls">
        <label><span>Resposta</span>
          <select id="s2choice">
            <option value="">‚Äî</option>
            <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
          </select>
        </label>
        <button id="s2check">Comprova el pas</button>
        <span class="pill small" id="s2stepLabel">Pas 1</span>
      </div>
      <div class="multiples" id="s2multiples"></div>
      <div id="s2fb"></div>
      <div class="progress"><div id="s2bar"></div></div>
    `;

    let level=Number(q('#s2level').value);
    let division=null; let steps=[]; let idx=0; let solved=0; const target=2;

    function updateBoard(){
      q('#s2divisor').textContent = division.divisor;
      q('#s2dividend').textContent = division.dividend;
      const solvedDigits = steps.slice(0, idx).map(s=>s.qDigit).join('');
      const remaining = steps.length - solvedDigits.length;
      q('#s2quotient').textContent = solvedDigits + (remaining>0 ? '¬∑'.repeat(remaining) : '');
      q('#s2stepLabel').textContent = `Pas ${Math.min(idx+1, steps.length)}`;
      q('#s2multiples').innerHTML = multiplesOf(division.divisor).map(m=>`<span>${m}</span>`).join('');
    }

    function describeStep(step){
      if(step.qDigit===0){
        return `El n√∫mero actual √©s <b>${step.partial}</b>. ${division.divisor} no hi cap cap vegada sense passar-se, per tant escrivim <b>0</b> i baixem la seg√ºent xifra.`;
      }
      return `Quantes vegades hi cap <b>${division.divisor}</b> dins <b>${step.partial}</b> sense passar-se? Recorda: ${step.qDigit} √ó ${division.divisor} = ${step.product}.`;
    }

    function newDivision(){
      level = Number(q('#s2level').value);
      division = genDivision(level);
      steps = divisionSteps(division.dividend, division.divisor);
      idx = 0;
      q('#s2work').innerHTML='';
      q('#s2fb').innerHTML='';
      q('#s2bar').style.width = Math.min(solved,target)/target*100+"%";
      q('#s2choice').value='';
      updateBoard();
      q('#s2hint').innerHTML = describeStep(steps[idx]);
    }

    function check(){
      if(!division) return;
      const step = steps[idx];
      const val = Number(q('#s2choice').value);
      if(Number.isNaN(val)){ return; }
      const ok = val === step.qDigit;
      q('#s2fb').innerHTML = `<span class="result ${ok?'ok':'no'}">${ok?'Correcte ‚úÖ':'No del tot ‚ùå'} ${ok?`(${step.qDigit} √ó ${division.divisor} = ${step.product})`:`Repensa: ${division.divisor} hi cap ${step.qDigit} vegades.`}</span>`;
      if(ok){
        const row = document.createElement('div');
        row.className='ld-step';
        row.innerHTML = `<span><strong>${step.partial}</strong> ‚àí ${step.product}</span><span>Resta = <strong>${step.remainder}</strong></span>`;
        q('#s2work').appendChild(row);
        idx++;
        if(idx>=steps.length){
          solved++;
          q('#s2bar').style.width = Math.min(solved,target)/target*100+"%";
          if(solved>=target){
            state.progress.s2=true; save(); renderSteps();
            setTimeout(()=>openSession('s3'),700);
          } else {
            setTimeout(newDivision, 550);
          }
        } else {
          q('#s2choice').value='';
          q('#s2hint').innerHTML = describeStep(steps[idx]);
          updateBoard();
        }
      }
    }

    q('#s2new').addEventListener('click', newDivision);
    q('#s2level').addEventListener('change', ()=>{ solved=0; q('#s2bar').style.width='0%'; newDivision(); });
    q('#s2check').addEventListener('click', check);
    view.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const sel = q('#s2choice'); if(document.activeElement===sel){ check(); } }});

    newDivision();
  }

  /* ===== S3 ===== */
  function initS3(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>3) Pr√†ctica cronometrada</h2>
      <div class="coach"><div class="avatar">üèÉ‚Äç‚ôÄÔ∏è</div><div class="bubble">Tens <b>90 segons</b>. Respon divisions amb quocient i resta. Pots repetir tantes vegades com vulguis per superar la teva millor marca.</div></div>
      <div class="controls">
        <label><span>Dificultat</span>
          <select id="s3level">
            <option value="1">2 xifres √∑ 1 xifra</option>
            <option value="2" selected>3 xifres √∑ 1 xifra</option>
            <option value="3">3 xifres √∑ 2 xifres</option>
          </select>
        </label>
        <button id="s3start">Comen√ßa</button>
        <span class="pill">Temps: <b id="s3t">‚Äî</b></span>
        <span class="pill">Encerts: <b id="s3ok">0</b>/5</span>
        <span class="pill">Millor marca: <b id="s3best">${state.best3||0}</b></span>
      </div>
      <div id="s3question" class="info">Prem ¬´Comen√ßa¬ª per iniciar el compte enrere.</div>
      <div class="dual-inputs">
        <input id="s3ansQ" inputmode="numeric" maxlength="3" placeholder="Quocient" aria-label="Quocient" disabled />
        <input id="s3ansR" inputmode="numeric" maxlength="2" placeholder="Resta" aria-label="Resta" disabled />
      </div>
      <div class="controls" style="margin-top:10px">
        <button id="s3check" class="warn" disabled>Envia resposta</button>
        <div id="s3fb"></div>
      </div>
      <div class="multiples" id="s3multiples"></div>
    `;

    let running=false; let timer=null; let left=0; let ok=0; let target=5; let current=null;

    function stop(win){ running=false; clearInterval(timer); timer=null; q('#s3check').disabled=true; q('#s3ansQ').disabled=true; q('#s3ansR').disabled=true; if(win){ state.progress.s3=true; save(); renderSteps(); setTimeout(()=>openSession('s4'),700); }
      if(ok>state.best3){ state.best3=ok; save(); q('#s3best').textContent=ok; }
    }

    function tick(){ left--; q('#s3t').textContent = left+'s'; if(left<=0){ q('#s3question').innerHTML = `<strong>Temps esgotat!</strong> Has encertat ${ok} divisions.`; stop(false); } }

    function newDivision(){ const lvl = Number(q('#s3level').value); current = genDivision(lvl); q('#s3question').innerHTML = `<strong>${fmtDivision(current)}</strong> ¬∑ Escriu quocient i resta.`; q('#s3multiples').innerHTML = multiplesOf(current.divisor).map(m=>`<span>${m}</span>`).join(''); q('#s3ansQ').value=''; q('#s3ansR').value=''; q('#s3ansQ').focus(); }

    function start(){ running=true; left=90; ok=0; q('#s3ok').textContent='0'; q('#s3t').textContent='90s'; q('#s3ansQ').disabled=false; q('#s3ansR').disabled=false; q('#s3check').disabled=false; newDivision(); timer=setInterval(tick,1000); }

    function check(){ if(!running || !current) return; const ansQ = Number(q('#s3ansQ').value); const ansR = Number(q('#s3ansR').value); const okNow = ansQ===current.quotient && ansR===current.remainder; q('#s3fb').innerHTML = `<span class="result ${okNow?'ok':'no'}">${okNow?'Correcte ‚úÖ':'Incorrecte ‚ùå'} ${fmtDivision(current)} = ${current.quotient}${current.remainder?` (r ${current.remainder})`:' exacta'}</span>`; if(okNow){ ok++; q('#s3ok').textContent = ok; if(ok>=target){ q('#s3question').innerHTML = `<strong>Enhorabona!</strong> Has arribat als ${target} encerts.`; stop(true); return; } }
      if(left>0){ setTimeout(newDivision, okNow?350:450); }
    }

    q('#s3start').addEventListener('click', ()=>{ if(running) return; start(); });
    q('#s3check').addEventListener('click', check);
    view.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const active = document.activeElement; if(active===q('#s3ansQ') || active===q('#s3ansR')) check(); }});
  }

  /* ===== S4 ===== */
  function initS4(view){
    const q=(sel)=>view.querySelector(sel);
    view.innerHTML = `
      <h2>4) Prova final</h2>
      <div class="coach"><div class="avatar">üéì</div><div class="bubble">Resol 10 divisions. A partir de 8 bones superar√†s la c√†psula i obtindr√†s el certificat. Pots repetir-la tantes vegades com vulguis.</div></div>
      <div class="controls">
        <label><span>Dificultat</span>
          <select id="s4level">
            <option value="1">2 xifres √∑ 1 xifra</option>
            <option value="2" selected>3 xifres √∑ 1 xifra</option>
            <option value="3">3 xifres √∑ 2 xifres</option>
          </select>
        </label>
        <button id="s4start">Inicia la prova</button>
        <span class="pill">Pregunta: <b id="s4i">0</b>/10</span>
        <span class="pill">Encerts: <b id="s4ok">0</b></span>
      </div>
      <div id="s4question" class="info">Prem ¬´Inicia la prova¬ª quan estiguis a punt.</div>
      <div class="dual-inputs">
        <input id="s4ansQ" inputmode="numeric" maxlength="3" placeholder="Quocient" aria-label="Quocient" disabled />
        <input id="s4ansR" inputmode="numeric" maxlength="2" placeholder="Resta" aria-label="Resta" disabled />
      </div>
      <div class="controls" style="margin-top:10px">
        <button id="s4check" disabled>Comprova</button>
        <div id="s4fb"></div>
      </div>
      <div class="multiples" id="s4multiples"></div>
    `;

    let idx=0, ok=0, current=null, running=false;

    function newDivision(){ const lvl = Number(q('#s4level').value); current = genDivision(lvl); q('#s4question').innerHTML = `<strong>${fmtDivision(current)}</strong> ¬∑ Escriu quocient i resta.`; q('#s4multiples').innerHTML = multiplesOf(current.divisor).map(m=>`<span>${m}</span>`).join(''); q('#s4ansQ').value=''; q('#s4ansR').value=''; q('#s4ansQ').focus(); }

    function start(){ running=true; idx=0; ok=0; q('#s4i').textContent='0'; q('#s4ok').textContent='0'; q('#s4check').disabled=false; q('#s4ansQ').disabled=false; q('#s4ansR').disabled=false; newDivision(); }

    function finish(){ running=false; q('#s4check').disabled=true; q('#s4ansQ').disabled=true; q('#s4ansR').disabled=true; const pass = ok>=8; if(pass){ state.progress.s4=true; save(); renderSteps(); q('#s4fb').insertAdjacentHTML('beforeend', ' <span class="pill small">Certificat aconseguit üèÜ</span>'); }
      q('#s4question').innerHTML = `${pass?'üéâ Fant√†stic!':'üìù Bon intent!'} Has encertat ${ok} de 10. ${pass?'Ja tens la c√†psula superada.':'Torna-ho a provar quan vulguis.'}`;
    }

    function check(){ if(!running || !current) return; const ansQ = Number(q('#s4ansQ').value); const ansR = Number(q('#s4ansR').value); const okNow = ansQ===current.quotient && ansR===current.remainder; if(okNow) ok++; idx++; q('#s4i').textContent = idx; q('#s4ok').textContent = ok; q('#s4fb').innerHTML = `<span class="result ${okNow?'ok':'no'}">${okNow?'Correcte ‚úÖ':'Incorrecte ‚ùå'} ${fmtDivision(current)} = ${current.quotient}${current.remainder?` (r ${current.remainder})`:' (exacta)'}</span>`;
      if(idx>=10){ finish(); }
      else { setTimeout(newDivision, okNow?380:480); }
    }

    q('#s4start').addEventListener('click', start);
    q('#s4check').addEventListener('click', check);
    view.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const active=document.activeElement; if(active===q('#s4ansQ')||active===q('#s4ansR')) check(); }});
  }

  function runSmokeTests(){
    const box = document.getElementById('tests');
    if(!box) return;
    try{
      console.assert(document.querySelectorAll('#steps .step').length===4,'[TEST] quatre sessions');
      openSession('s1');
      console.assert(document.querySelector('#screen #s1check'),'[TEST] bot√≥ s1check');
      openSession('s2');
      console.assert(document.querySelector('#screen #s2check'),'[TEST] bot√≥ s2check');
      box.className='info';
      box.style.display='block';
      box.textContent='Tests b√†sics passats ‚úÖ';
    }catch(e){
      console.error('[TEST ERROR]', e);
      box.className='note';
      box.style.display='block';
      box.textContent='Alguns tests han fallat ‚ùå (mira la consola)';
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    renderSteps();
    const firstOpen = ['s1','s2','s3','s4'].find((id,idx)=> idx===0 || Object.values(state.progress).slice(0,idx).every(Boolean) );
    openSession(firstOpen||'s1');
    runSmokeTests();
  });
  </script>
</body>
</html>
